<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Application Interaction/lab12">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Lab 12 - Application Interaction | Operating Systems</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://localhost//operating-systems/158/Application Interaction/lab12"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Lab 12 - Application Interaction | Operating Systems"><meta data-rh="true" name="description" content="Task: Time server"><meta data-rh="true" property="og:description" content="Task: Time server"><link data-rh="true" rel="canonical" href="http://localhost//operating-systems/158/Application Interaction/lab12"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/158/Application Interaction/lab12" hreflang="en"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/158/Application Interaction/lab12" hreflang="x-default"><link rel="stylesheet" href="/operating-systems/158/assets/css/styles.a69a9d41.css">
<link rel="preload" href="/operating-systems/158/assets/js/runtime~main.f92a7708.js" as="script">
<link rel="preload" href="/operating-systems/158/assets/js/main.3b098d9a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/operating-systems/158/"><div class="navbar__logo"><img src="/operating-systems/158/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/operating-systems/158/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">SO</b></a><a class="navbar__item navbar__link" href="/operating-systems/158/Software Stack">Software Stack</a><a class="navbar__item navbar__link" href="/operating-systems/158/Data">Data</a><a class="navbar__item navbar__link" href="/operating-systems/158/Compute">Compute</a><a class="navbar__item navbar__link" href="/operating-systems/158/IO">IO</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/operating-systems/158/Application Interaction">Application Interaction</a><a class="navbar__item navbar__link" href="/operating-systems/158/Assignments">Assignments</a><a class="navbar__item navbar__link" href="/operating-systems/158/Exams">Exams</a><a class="navbar__item navbar__link" href="/operating-systems/158/Hackathons">Hackathons</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/158/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/158/lab-setup">Setting up the Lab Environment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/158/Software Stack/">Software Stack</a><button aria-label="Toggle the collapsible sidebar category &#x27;Software Stack&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/158/Data/">Data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/158/Compute/">Compute</a><button aria-label="Toggle the collapsible sidebar category &#x27;Compute&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/158/IO/">IO</a><button aria-label="Toggle the collapsible sidebar category &#x27;IO&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/operating-systems/158/Application Interaction/">Application Interaction</a><button aria-label="Toggle the collapsible sidebar category &#x27;Application Interaction&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/158/Application Interaction/Application-Interaction">Slides</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/158/Application Interaction/app-interact-overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/158/Application Interaction/Questions/">Questions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Questions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/operating-systems/158/Application Interaction/lab12">Lab 12 - Application Interaction</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/158/Assignments/">Assignments</a><button aria-label="Toggle the collapsible sidebar category &#x27;Assignments&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/158/Exams/">Exams</a><button aria-label="Toggle the collapsible sidebar category &#x27;Exams&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/158/Hackathons/">Hackathons</a><button aria-label="Toggle the collapsible sidebar category &#x27;Hackathons&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/158/rules-and-grading">Rules and Grading</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/158/resources">Resources</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/operating-systems/158/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/operating-systems/158/Application Interaction/"><span itemprop="name">Application Interaction</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lab 12 - Application Interaction</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Lab 12 - Application Interaction</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-time-server">Task: Time server<a class="hash-link" href="#task-time-server" title="Direct link to heading">​</a></h2><p>Navigate to <code>chapters/app-interact/time-server/drills/tasks/time-server/support</code>.
Try to figure out the protocol used by the server and the client.
You can do this by reading the source code, corroborated with information obtained at runtime.</p><p>Run the server again (the version in C), but instead of running the client, let&#x27;s run <code>netcat</code> and pipe the output to <code>hexdump</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nc -d 127.0.0.1 2000 | hexdump -C</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><iframe id="82562e64-4e5f-41a5-ae99-1ed5ac55d880" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;0e4dcdef-2c63-45d1-845f-930d288ec5eb&quot;&gt; &lt;p&gt;What format does the message exchanged between the server and the client have?&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;83da6db4-10ca-43cf-9bf3-ed05574ffa06&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;83da6db4-10ca-43cf-9bf3-ed05574ffa06&quot;&gt; &lt;p&gt;8 byte length (little endian) followed by 4 byte timestamp (little endian)&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;09206a39-f930-42d4-bdb0-5568754e620f&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;09206a39-f930-42d4-bdb0-5568754e620f&quot;&gt; &lt;p&gt;8 byte length (big endian) followed by 4 byte timestamp (big endian)&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;109b0929-16f8-4948-9d43-6faa0f56e0b4&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;109b0929-16f8-4948-9d43-6faa0f56e0b4&quot;&gt; &lt;p&gt;4 byte length (little endian) followed by 8 byte timestamp (little endian)&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;dc733c04-20ec-493b-a1a6-8ee6675ae749&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;dc733c04-20ec-493b-a1a6-8ee6675ae749&quot;&gt; &lt;p&gt;4 byte length (big endian) followed by 8 byte timestamp (big endian)&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;dc733c04-20ec-493b-a1a6-8ee6675ae749&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;If we consider one output example:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot;&gt;00000000  00 00 00 08 00 00 00 00  63 1b a9 50              |........c..P|
0000000c&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We can identify the 4 byte length in big endian (&lt;code&gt;00 00 00 08&lt;/code&gt;), then the 8 byte timestamp (&lt;code&gt;00 00 00 00  63 1b a9 50&lt;/code&gt;), also in big endian.&lt;/p&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><iframe id="c451fc67-cd59-46e5-a26e-cfcb21efee69" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;8bc4c16e-8085-413f-906f-774f3fe40c0b&quot;&gt; &lt;p&gt;Is the protocol between the python server and the python client the same?
Can we run the python server and connect to it via the C client?&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;a4ed7608-f298-4aa9-aaa1-fc544fe41acb&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;a4ed7608-f298-4aa9-aaa1-fc544fe41acb&quot;&gt; &lt;p&gt;No, the protocols are different&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;8b999c4f-3aca-4aca-bafc-faa641253bbf&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;8b999c4f-3aca-4aca-bafc-faa641253bbf&quot;&gt; &lt;p&gt;Yes&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;8b999c4f-3aca-4aca-bafc-faa641253bbf&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;By doing the same investigation on the python server we discover that the protocol is the same.
This means that we can run the python server and the C client, or the C server and python client, and everything will work:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot;&gt;student@os:~/.../support/time-server/python$ python3 server.py&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot;&gt;student@os:~/.../support/time-server$ ./client 127.0.0.1 2000
The time is Thu Sep  1 11:48:03 2022&lt;/code&gt;&lt;/pre&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><p>If you&#x27;re having difficulties solving this exercise, go through <a href="/operating-systems/158/Application Interaction/lab12#time-server">this</a> reading material.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-password-cracker">Task: Password cracker<a class="hash-link" href="#task-password-cracker" title="Direct link to heading">​</a></h2><p>Navigate to <code>chapters/app-interact/password-cracker/drills/tasks/password-cracker/support</code>.
Creating 26 processes is not very realistic, since it&#x27;s unlikely that a usual machine has that many cores.</p><p>Modify the program so that it only creates 4 workers.
Each worker will receive 2 characters instead of one, defining an interval to search.
For example, the first worker will receive <code>a</code> and <code>f</code>, meaning it will brute-force passwords starting with <code>a</code>, <code>b</code>, <code>c</code>, <code>d</code>, <code>e</code>, or <code>f</code>, the second <code>g</code> - <code>l</code>, and so on.</p><p>Check that the <code>worker()</code> function is indeed called from different worker processes.
One simple way to do this is to print out the current process ID at the beginning of the function.
To get the current process ID, use the <code>getpid()</code> function from the <code>os</code> module.</p><p>If you&#x27;re having difficulties solving this exercise, go through <a href="/operating-systems/158/Application Interaction/lab12#password-cracker">this</a> reading material.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-d-bus---battery-level">Task: D-Bus - Battery level<a class="hash-link" href="#task-d-bus---battery-level" title="Direct link to heading">​</a></h2><p>Navigate to <code>chapters/app-interact/dbus/drills/tasks/dbus/support</code>.
Use D-Bus to find out the computer&#x27;s battery level.
There is the <code>org.freedesktop.UPower</code> interface on the system bus that can provide this information.</p><p>The method you need to call is <code>org.freedesktop.DBus.Properties.Get</code> from the <code>/org/freedesktop/UPower/devices/DisplayDevice</code> object.</p><p>This method needs 2 arguments: an interface name and a property name.</p><p>Those should be <code>org.freedesktop.UPower.Device</code> and <code>Percentage</code> respectively.</p><p>Then input all of the above into a <code>gdbus</code> call, which, if everything is correct, should output the battery percentage level as a number between 0 and 100.</p><p>Note: if you are running on a desktop computer or inside a virtual machine, you will get the value <code>0.0</code>, because those systems don&#x27;t have a battery.</p><p>If you&#x27;re having difficulties solving this exercise, go through <a href="/operating-systems/158/Application Interaction/lab12#d-bus">this</a> reading material.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-x-window-system">The X Window System<a class="hash-link" href="#the-x-window-system" title="Direct link to heading">​</a></h2><p>Unix-like systems that support a Graphical User Interface usually do this through the X Window System.
This system is implemented with a client-server model: the X Server is the component that controls the screen, keyboard, mouse, and other parts related to the GUI, while the X clients are the applications that want to use the graphical interface (like, for example, an internet browser).</p><p>The clients and the server communicate using a standardized protocol, and the system does not necessarily require the client and server to be on the same machine.
Although not so common nowadays, the X client can run on a different machine than the server, with the communication happening over the network.
But in the more usual case, when both the client and the server are on the same machine, modern implementations of the X Window System use a faster communication channel, like a Unix socket.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="x-client-and-server-on-the-same-machine">X Client and Server on the Same Machine<a class="hash-link" href="#x-client-and-server-on-the-same-machine" title="Direct link to heading">​</a></h3><p>Let&#x27;s investigate the case when both the X client and X server run on the same machine.
First we&#x27;ll take a look at the Unix sockets that are in listening mode.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ sudo netstat -xnlp | grep X11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unix  2      [ ACC ]     STREAM     LISTENING     29120    3472/Xorg            @/tmp/.X11-unix/X0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unix  2      [ ACC ]     STREAM     LISTENING     29121    3472/Xorg            /tmp/.X11-unix/X0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We observe the <code>Xorg</code> process (the X server) listening on a Unix socket with the path <code>/tmp/.X11-unix/X0</code>.</p><p>Now let&#x27;s run an X client (that is, a GUI application) and check that it will indeed connect to this Unix socket.
A very simple example is the <code>xeyes</code> application:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ strace -e trace=socket,connect xeyes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">socket(AF_UNIX, SOCK_STREAM|SOCK_CLOEXEC, 0) = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connect(3, {sa_family=AF_UNIX, sun_path=@&quot;/tmp/.X11-unix/X0&quot;}, 20) = 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As expected, the application creates a Unix socket, then connects to the path <code>@&quot;/tmp/.X11-unix/X0&quot;</code>.</p><p>Furthermore, let&#x27;s confirm that there is actual communication taking place between <code>xeyes</code> and the X server.
We&#x27;ll run <code>xeyes</code> again, and then we&#x27;ll keep moving the mouse cursor around.
When the mouse is moved, the following events are taking place:</p><ul><li>The X server captures the mouse movements (since the server is the one that controls the mouse)</li><li>The X server will pass these &quot;mouse moved&quot; events to the clients (including xeyes)</li><li>The client (xeyes) uses these events to update its window (changing the position of the pupils inside the eyes)</li></ul><p>So, if we run <code>xeyes</code> under <code>strace</code>, we expect to see some communication on the Unix socket that is created at the beginning:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">strace -e &#x27;trace=!poll&#x27; -e trace=&#x27;socket,connect,recvmsg&#x27; xeyes |&amp; grep -v &#x27;\-1 EAGAIN&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="strace-xeyes" src="/operating-systems/158/assets/images/strace_xeyes-f055c379e7028e39de13f0d039171718.gif" width="1920" height="1080" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="oneko">Oneko<a class="hash-link" href="#oneko" title="Direct link to heading">​</a></h3><p>An alternative to <code>xeyes</code> which allows us to observe Unix sockets is <code>oneko</code>.
Going through the same steps, we see that the application also create a Unix socket, then connects to the path <code>@&quot;/tmp/.X11-unix/X0&quot;</code>.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ strace -e trace=socket,connect oneko</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">socket(AF_UNIX, SOCK_STREAM|SOCK_CLOEXEC, 0) = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">connect(3, {sa_family=AF_UNIX, sun_path=@&quot;/tmp/.X11-unix/X1&quot;}, 20) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- SIGALRM {si_signo=SIGALRM, si_code=SI_KERNEL} ---</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When running <code>oneko</code>, what differs from <code>xeyes</code> is the <code>SIGALRM</code> signal.
This means that <code>oneko</code> uses a timer, which is periodically set, and then it expires only to be reset again.
The purpose of this timer is to slow down the cat.</p><p>Verifying the communication between the X server and <code>oneko</code> is easy.
We see that the cat follows our mouse cursor, behaving similarly to <code>xeyes</code>.
After running <code>oneko</code> under <code>strace</code>, we see the communication uses the UNIX socket created at the beginning:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">strace -e &#x27;trace=!poll&#x27; -e trace=&#x27;socket,connect,recvmsg&#x27; oneko |&amp; grep -v &#x27;\-1 EAGAIN&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><iframe id="e331715c-af1f-4e8b-81c2-f2c3c4e6e9da" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;f93ace0a-7bcc-4b34-b141-495d61981ece&quot;&gt; &lt;p&gt;What is the purpose of the timer used in the Oneko&#x27;s implementation&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;bfeec57a-b416-4ac6-a8c5-af91f9537c5d&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;bfeec57a-b416-4ac6-a8c5-af91f9537c5d&quot;&gt; &lt;p&gt;It server no purpose&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;78e34815-5b1a-4f80-a742-1a22bb299e12&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;78e34815-5b1a-4f80-a742-1a22bb299e12&quot;&gt; &lt;p&gt;Speed up the cat&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;c34f76fc-5cf1-4aa7-a0ab-3cb9d0f522bf&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;c34f76fc-5cf1-4aa7-a0ab-3cb9d0f522bf&quot;&gt; &lt;p&gt;Slow down the cat&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;c34f76fc-5cf1-4aa7-a0ab-3cb9d0f522bf&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;The purpose of the timer is to delay the cat. You can verify this by running&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot;&gt;while true; do kill -14 $(pidof oneko)&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;You&#x27;ll notice the cat is much faster in following your mouse.&lt;/p&gt;&lt;p&gt;Try and find other ways to &quot;hack&quot; Oneko to make it move faster.&lt;/p&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><h2 class="anchor anchorWithStickyNavbar_LWe7" id="time-server">Time Server<a class="hash-link" href="#time-server" title="Direct link to heading">​</a></h2><p>Check out the code in <code>chapters/app-interact/time-server/support/server.c</code> and <code>chapters/app-interact/time-server/support/client.c</code>.</p><p>This is a simple program consisting of a server and a client.
The server uses a tcp socket to wait for connections.
Once a client has connected, the server will send the current time to it.
The client will then print the received time to the console.</p><p>Let&#x27;s build and run this example:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ ./server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, in another terminal:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ ./client 127.0.0.1 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The time is Thu Sep  1 11:48:03 2022</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="python-version">Python Version<a class="hash-link" href="#python-version" title="Direct link to heading">​</a></h3><p>In <code>chapters/app-interact/time-server/support/python</code> we have the equivalent python implementation for both the server and client:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/python$ python3 server.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/python$ python3 client.py 127.0.0.1 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The time is Thu Sep  1 11:58:01 2022</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="password-cracker">Password Cracker<a class="hash-link" href="#password-cracker" title="Direct link to heading">​</a></h2><p>In this example, we will solve the following problem: given the sha512 hash of a password, we want to obtain the password that generated the hash.</p><p>Since a hash function is not reversible, one way to solve this problem is by brute-force: generate all possible word combinations, compute the hash for each word, and compare it with our desired hash value.
This is not feasible for long passwords, so for our example we will consider only passwords containing lowercase letters and having the length of 4.</p><p>In order to speed up the entire process, we want to parallelize the solution.
Instead of one process checking all combinations, we&#x27;ll split the work among multiple processes or threads.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="multiprocess-version">Multiprocess Version<a class="hash-link" href="#multiprocess-version" title="Direct link to heading">​</a></h3><p>The code for this version is in <code>chapters/app-interact/password-cracker/support/password-cracker-multiprocess.c</code>.</p><p>The idea is the following: we create 26 worker processes, where each process will consider passwords that start with one particular letter (the first process will brute-force passwords starting with <code>a</code>, the second with <code>b</code>, and so on).</p><p>Since we are using processes, which are naturally isolated, we need a method of communication.
The main process should be able to send data to the workers and read back results from them.
For this purpose we will use pipes: a pair of 2 pipes between the main process and each worker, one pipe for each direction of communication.</p><p>In summary, the flow will look like this:</p><ul><li><p>main process</p><ul><li><p>create worker processes, along with 2 pipes for each worker (one pipe for requests, one for results)</p></li><li><p>send the &#x27;a&#x27; character to the first process request pipe, &#x27;b&#x27; to the second, etc.</p></li><li><p>read the results from each result pipe</p></li></ul></li><li><p>worker process</p><ul><li><p>read one character from the request pipe</p></li><li><p>generate all words of length 4 that begin with that character</p></li><li><p>for each generated word, compute the sha512 hash and compare it with the desired hash</p></li><li><p>if there is a match, write it to the result pipe</p></li></ul></li></ul><p>Let&#x27;s build and run the program:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/password-cracker$ make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcc -Wall -o password-cracker-multiprocess password-cracker-multiprocess.c -lcrypto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcc -Wall -Wno-int-to-pointer-cast -Wno-pointer-to-int-cast -o password-cracker-multithread password-cracker-multithread.c -lcrypto -lpthread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/password-cracker$ ./password-cracker-multiprocess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker 7 found haxx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="multithreaded-version">Multithreaded Version<a class="hash-link" href="#multithreaded-version" title="Direct link to heading">​</a></h3><p>Check out the code in <code>chapters/app-interact/password-cracker/support/password-cracker-multithread.c</code>.</p><p>The core idea of the program is the same, but now we&#x27;re using threads instead of processes.</p><p>This makes the communication easier: we&#x27;ll use the thread function argument to send the first character of the password to each thread.
As for the result, each thread will return it as the return value of the thread function.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ ./password-cracker-multithread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker 7 found haxx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="multiprocess-version-in-python-1">Multiprocess Version in Python (1)<a class="hash-link" href="#multiprocess-version-in-python-1" title="Direct link to heading">​</a></h3><p>Code in <code>chapters/app-interact/password-cracker/support/python/password-cracker-multiprocess-1.py</code>.</p><p>This is the Python equivalent of the previous multiprocess version. The program structure is the same, but Python has a few nice features that make our life easier:</p><ul><li><p>there is a <code>Process</code> object that takes a function argument and spawns a new process that begins execution from that function.
No need to call <code>fork</code> manually.</p></li><li><p>the <code>Pipe</code> object in Python is already bidirectional, unlike the OS pipes, which are unidirectional.
So we don&#x27;t need to create 2 pipes for each direction.</p></li><li><p>we don&#x27;t have to write the code that generates all the password combinations, <code>itertools.product</code> will do it for us</p></li></ul><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ python3 python/password-cracker-multiprocess-1.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker 7 found haxx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="multiprocess-version-in-python-2">Multiprocess Version in Python (2)<a class="hash-link" href="#multiprocess-version-in-python-2" title="Direct link to heading">​</a></h3><p>Code in <code>chapters/app-interact/password-cracker/support/python/password-cracker-multiprocess-2.py</code>.</p><p>In this case, the code looks different than in the previous examples.
Now we are taking advantage of some Python constructs, namely <code>process pools</code>, which are a collection of worker processes.</p><p>A <code>Pool</code> object has, among others, a function called <code>map</code>.
<code>map</code> takes a function, together with an array of values, and applies this function on each value from the array.
At first glance, it might look like the usual <code>map</code> function, but with the key difference that the function application is done by the processes from the pool.</p><p>In other words, the work is distributed to the worker processes from the pool, and all the communication that we had to handle in the previous examples is done behind the scenes, greatly simplifying the code.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ python3 python/password-cracker-multiprocess-2.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker 7 found haxx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="multithreaded-version-in-python">Multithreaded Version in Python<a class="hash-link" href="#multithreaded-version-in-python" title="Direct link to heading">​</a></h3><p>Code in <code>chapters/app-interact/password-cracker/support/python/password-cracker-multithread.py</code>.</p><p>The Python equivalent of the previous multithreaded version.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ python3 python/password-cracker-multithread.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker 7 found haxx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This example is given only to provide an idea of how a multithreaded program is written.
Remember that CPU-bound threads in python don&#x27;t actually run in parallel, due to the Global Interpreter Lock.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-containers-vs-vms">Guide: Containers vs VMs<a class="hash-link" href="#guide-containers-vs-vms" title="Direct link to heading">​</a></h2><p>Containers are a lightweight virtualization technology that allows multiple isolated user-space instances to run on a single host operating system.
They are often compared to <a href="https://linux.die.net/man/1/chroot" target="_blank" rel="noopener noreferrer"><code>chroot</code></a> because they both provide isolated environments for running applications.</p><p>Cgroups limit, account for, and isolate the resource usage (CPU, memory, disk I/O, network, etc.) of a collection of processes.
They can be used to enforce resource limits, prioritization, accounting, and control.
Namespaces isolate processes from each other by creating independent views of system resources.
There are different types of namespaces, such as user, PID, network, mount, IPC, and UTS.
You can read more about them <a href="https://www.nginx.com/blog/what-are-namespaces-cgroups-how-do-they-work/" target="_blank" rel="noopener noreferrer">here</a>, <a href="https://www.baeldung.com/linux/cgroups-and-namespaces" target="_blank" rel="noopener noreferrer">here</a> and a particularly good read about namespaces can be found <a href="https://blog.quarkslab.com/digging-into-linux-namespaces-part-1.html" target="_blank" rel="noopener noreferrer">here</a></p><iframe id="99225e84-5e4b-4970-af7b-b02823ad09ae" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;a12e2092-b6e0-4bd2-85dd-d17cce191435&quot;&gt; &lt;p&gt;Which of the following affirmations about namespaces and cgroups is correct?&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;6254899f-639c-4a93-9d3a-61e22be66bd0&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;6254899f-639c-4a93-9d3a-61e22be66bd0&quot;&gt; &lt;p&gt;Both provide isolation and security.&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;129fd96f-13c5-47bb-a280-b42c5d506778&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;129fd96f-13c5-47bb-a280-b42c5d506778&quot;&gt; &lt;p&gt;Namespaces provide resource management and cgroups provide isolation and security.&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;4461d32e-ce23-4a44-8b64-e92fbe8a2aab&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;4461d32e-ce23-4a44-8b64-e92fbe8a2aab&quot;&gt; &lt;p&gt;Both provide resource management.&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;f470bd49-8650-4e8c-8074-7a4626bcf958&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;f470bd49-8650-4e8c-8074-7a4626bcf958&quot;&gt; &lt;p&gt;Cgroups provide resource management and namespaces provide isolation and security.&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;f470bd49-8650-4e8c-8074-7a4626bcf958&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;They both serve different purposes, cgroups provide resource management and namespaces provide isolation and security.
Cgroups manage resources, while namespaces isolate and secure them.&lt;/p&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><p>However, containers take this isolation a step further by using kernel features such as namespaces and cgroups to provide a more complete and secure isolation of resources.</p><p>Virtual machines, on the other hand, are a heavier form of virtualization that involves running a complete guest operating system on top of a host operating system using a hypervisor.
This allows multiple guest operating systems to run on a single physical machine, each with its own set of virtualized hardware resources.</p><p><img loading="lazy" alt="VMs vs Containers" src="/operating-systems/158/assets/images/containers-vs-vms-75f454982e671d86b4d127b6bed5db07.svg" class="img_ev3q"></p><p>One key difference between containers and VMs is the level of abstraction.
Containers virtualize the operating system, allowing multiple containers to share the same kernel while providing the illusion of running on separate machines.
VMs virtualize the hardware, allowing multiple guest operating systems to run on the same physical machine while providing the illusion of running on separate physical hardware.</p><p>Another difference is the resource overhead.
Containers are generally more lightweight than VMs because they share the host kernel and do not require a separate guest operating system to be installed.
This means that containers can start up faster and use less memory than VMs.</p><iframe id="1dbcb326-2a0f-4d6e-a908-d82d4bdcd212" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;49b0c5ec-6a75-4421-ad8d-fcc1423aff8d&quot;&gt; &lt;p&gt;What is one advantage of using containers over VMs in regard to starting times and memory consumption?&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;6d3e4ae4-041a-430a-b9cb-0f5c9eed42b8&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;6d3e4ae4-041a-430a-b9cb-0f5c9eed42b8&quot;&gt; &lt;p&gt;Containers can start up faster and use less memory than VMs.&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;b560c841-ba18-4de6-b348-787db44423e3&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;b560c841-ba18-4de6-b348-787db44423e3&quot;&gt; &lt;p&gt;The comparison cannot be made.&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;7b7dd6fd-a0d0-4247-93f3-90fde8b08346&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;7b7dd6fd-a0d0-4247-93f3-90fde8b08346&quot;&gt; &lt;p&gt;VMs can start up faster and use less memory than containers.&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;6d3e4ae4-041a-430a-b9cb-0f5c9eed42b8&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;This means that they impose less resource overhead than virtual machines, which need to run a complete guest operating system on top of the host operating system using a hypervisor.&lt;/p&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><h3 class="anchor anchorWithStickyNavbar_LWe7" id="containers">Containers<a class="hash-link" href="#containers" title="Direct link to heading">​</a></h3><p>Our app will make use of <code>docker</code> containers.
A container is an OS-level virtualization method in which a group of userspace processes are isolated from the rest of the system.</p><p>Take for example a database server.
Instead of running it directly on the host system, we&#x27;ll run it in its own container.
This way, the server process will be isolated from other processes on the system.
It will also have its own filesystem.</p><p>Besides isolation, containers are also useful for portability.
Since a container comes with its own filesystem image, we can pack it together will all the dependencies, so that the app will run correctly no matter what packages are installed on the host system.</p><p>Finally, since our application will consist of more than 1 container, we&#x27;ll also use <code>docker-compose</code>, which is a tool that helps us with running multi-container applications.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="os-cloud">OS Cloud<a class="hash-link" href="#os-cloud" title="Direct link to heading">​</a></h2><p>In this section, we are going to build a &quot;toy cloud&quot; called <code>OS Cloud</code>.
Similar to a real cloud (like <code>aws</code>), <code>OS Cloud</code> will allow us to create and manage virtual machines, through an <code>http</code> API.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">​</a></h3><p>Make sure the following packages are installed:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt-get -y update; sudo apt-get -y install docker-compose jq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Also, make sure your user can run docker commands.
If not, maybe you need to add it to the <code>docker</code> group:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo usermod -aG docker student</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, after re-login:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ docker ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you are running inside a virtual machine, you need to enable nested virtualization.
Example for vmware:</p><p><img loading="lazy" alt="nested-virt-vmware" src="/operating-systems/158/assets/images/nested_virt_vmware-1b3a6b314c74c626bc006936abb01bf7.png" width="845" height="699" class="img_ev3q"></p><p>For virtualbox:</p><p><img loading="lazy" alt="nested-virt-vbox" src="/operating-systems/158/assets/images/nested_virt_vbox-4c9c494a233277658f851662ca2dc082.png" width="819" height="590" class="img_ev3q"></p><p>If the button is greyed out, try from the command line:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ VBoxManage  list vms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;USO 2022-2023&quot; {042a5725-bfb7-4a46-9743-1164d3acac23}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ VBoxManage modifyvm {042a5725-bfb7-4a46-9743-1164d3acac23} --nested-hw-virt on</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="initial-liftoff">Initial Liftoff<a class="hash-link" href="#initial-liftoff" title="Direct link to heading">​</a></h3><p>First, we need to do some initial setup:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ ./initial_setup.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then go to <code>support/os-cloud</code> and run:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ ./setup_db.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Setting up db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Starting db server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for db server to start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stopping db server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Restarting db server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Waiting for db server to start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stopping db server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ docker-compose up --build</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now the http API will listen on port <code>localhost:5000</code>. Let&#x27;s try:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl localhost:5000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Welcome to OS Cloud!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let&#x27;s check the running virtual machines:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl localhost:5000/vm_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We got an empty list, since there are no virtual machines yet.
Let&#x27;s create one (the command will take about 1 minute to complete):</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl -H &quot;Content-Type: application/json&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -d &#x27;{ &quot;name&quot;: &quot;my_vm&quot;, &quot;image&quot;: &quot;ubuntu_22.04&quot;, &quot;network&quot;: &quot;default&quot;, &quot;mem_size&quot;: &quot;2G&quot;, &quot;disk_size&quot;: &quot;10G&quot;}&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> localhost:5000/vm_create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;id&quot;:1,&quot;status&quot;:&quot;ok&quot;}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><iframe id="0209d041-26ce-4fb7-8df1-387cd26d3fcc" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;be569788-c5b8-404e-a604-f8dab14fb876&quot;&gt; &lt;p&gt;How do you create a new virtual machine with a memory of 3GB and disk size of 100 GB?&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;16e89cbf-96eb-47e4-93be-c3bddd373af6&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;16e89cbf-96eb-47e4-93be-c3bddd373af6&quot;&gt; &lt;p&gt;By running &lt;code&gt;curl -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;name&quot;: &quot;my_vm&quot;, &quot;image&quot;: &quot;ubuntu_22.04&quot;, &quot;network&quot;: &quot;default&quot;, &quot;mem_size&quot;: &quot;3G&quot;, &quot;disk_size&quot;: &quot;100G&quot;}&#x27; localhost:5000/vm_create&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;748f92a0-d53d-4f6b-b7b2-30a771313719&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;748f92a0-d53d-4f6b-b7b2-30a771313719&quot;&gt; &lt;p&gt;By running &lt;code&gt;curl -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;name&quot;: &quot;my_vm&quot;, &quot;image&quot;: &quot;ubuntu_22.04&quot;, &quot;network&quot;: &quot;default&quot;, &quot;mem_size&quot;: &quot;3G&quot;, &quot;disk_size&quot;: &quot;100G&quot;}&#x27; localhost:5000/vm_delete&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;294e27f3-e9d8-47d1-94ed-4bace984f058&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;294e27f3-e9d8-47d1-94ed-4bace984f058&quot;&gt; &lt;p&gt;By running &lt;code&gt;curl -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;name&quot;: &quot;my_vm&quot;, &quot;image&quot;: &quot;ubuntu_22.04&quot;, &quot;network&quot;: &quot;default&quot;, &quot;mem_size&quot;: &quot;6G&quot;, &quot;disk_size&quot;: &quot;1000G&quot;}&#x27; localhost:5000/vm_delete&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;21add836-6a65-4b2c-8ee0-7d243198c90d&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;21add836-6a65-4b2c-8ee0-7d243198c90d&quot;&gt; &lt;p&gt;By running &lt;code&gt;curl -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;name&quot;: &quot;my_vm&quot;, &quot;image&quot;: &quot;ubuntu_22.04&quot;, &quot;network&quot;: &quot;default&quot;, &quot;mem_size&quot;: &quot;3G&quot;, &quot;disk_size&quot;: &quot;101G&quot;}&#x27; localhost:5000/vm_create&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;16e89cbf-96eb-47e4-93be-c3bddd373af6&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;We need to uso &lt;code&gt;curl&lt;/code&gt; with the right path &lt;code&gt;localhost:5000/vm_create&lt;/code&gt;, specifying the right data &lt;code&gt;{ &quot;name&quot;: &quot;my_vm&quot;, &quot;image&quot;: &quot;ubuntu_22.04&quot;, &quot;network&quot;: &quot;default&quot;, &quot;mem_size&quot;: &quot;3G&quot;, &quot;disk_size&quot;: &quot;100G&quot;}&lt;/code&gt;.&lt;/p&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><p>Check the virtual machine list again:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl localhost:5000/vm_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[{&quot;id&quot;:1,&quot;name&quot;:&quot;my_vm&quot;}]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can also use the <code>jq</code> tool to pretty print the <code>json</code> outputs:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl -s localhost:5000/vm_list | jq .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;id&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;my_vm&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see our newly created virtual machine.
Let&#x27;s get some information about it:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl -s -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;id&quot;: 1 }&#x27; localhost:5000/vm_info | jq .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;disk_size&quot;: 10737418240,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;id&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;ip&quot;: &quot;192.168.0.2&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;mem_size&quot;: 2147483648,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;name&quot;: &quot;my_vm&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;network&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;os&quot;: &quot;ubuntu_22.04&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;state&quot;: &quot;RUNNING&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We recognize some parameters that we specified at creation time, like <code>mem_size</code> and <code>disk_size</code>.
Also, the IP address <code>192.168.0.2</code> has been allocated for our machine.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="virtual-machine-creation">Virtual Machine Creation<a class="hash-link" href="#virtual-machine-creation" title="Direct link to heading">​</a></h3><p>Take a look at the <code>vm_create</code> function in <code>support/os-cloud/os-cloud/vm.py</code>.
The steps undertaken are roughly:</p><ol><li><p>some initial allocations: the virtual machine IP address, network interface, qemu ports, etc</p></li><li><p>the virtual machine disk is created, based on the template specified by the user (like <code>ubuntu_22.04</code>)</p></li><li><p>the virtual machine is started with this new disk, in order to do some more customizations (the <code>ubuntu_22_04_vm_prepare</code> function)</p></li><li><p>the virtual machine is restarted again with the final disk in place</p></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="disk-creation">Disk Creation<a class="hash-link" href="#disk-creation" title="Direct link to heading">​</a></h3><p>All the disk templates are in <code>chapters/app-interact/os-cloud/support/disk-templates</code>.
This directory will be mounted in <code>/disk-templates</code> inside the container.</p><p>The first step of disk creation is to create a <code>qcow2</code> disk file based on the template specified by the user (step 2 from the explanation above).</p><p>This is done in the <code>create_disk_from_template</code> function in <code>chapters/app-interact/os-cloud/support/os-cloud/disk.py</code>.
The function will first create a disk object in the database, then it will call 2 shell scripts: <code>create_disk_from_template.sh</code> and <code>setup_root_password.sh</code>.</p><p>The second step is to start the virtual machine with this disk and do some customizations (step 3 from above).</p><p>This is done in the <code>ubuntu_22_04_vm_prepare</code> function in <code>chapters/app-interact/os-cloud/support/os-cloud/vm.py</code>.
The code will connect to the vm&#x27;s qemu serial console using <code>pexpect</code>.
Then it will use a series of <code>expect_exact</code> + <code>sendline</code> pairs to interact with the virtual machine, as if those commands were typed in the command-line.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="os-cloud-more-disk-customization">OS-Cloud: More Disk Customization<a class="hash-link" href="#os-cloud-more-disk-customization" title="Direct link to heading">​</a></h3><p>You might have probably noticed that there are 2 types of disk customizations:</p><ul><li><p>One type is for things that can be done without running the virtual machine.
If we only want to modify some files inside the disk filesystem, we can do so by mounting the disk.
This is done, for example, in the <code>disk-templates/ubuntu_22.04/setup_root_password.sh</code> script.
There we use <code>nbd_connect_qcow2</code> + <code>mount</code> to mount the disk, then we modify the <code>/etc/shadow</code> file to change the root password.</p></li><li><p>The second case is for operations that must be done with the virtual machine running.
These are handled in the <code>ubuntu_22_04_vm_prepare</code> function: the virtual machine is first started (<code>start_qemu_for_vm</code>), then <code>pexpect</code> is used to interact with the virtual machine via the <code>qemu</code> serial console.
Here we do things like running <code>ssh-keygen</code> - a binary that is part of the disk filesystem, which depends on other parts of the operating system from the disk to be running.
Note that in <code>ubuntu_22_04_vm_prepare</code>, for convenience, we also do some customizations that fall into the first category (like modifying <code>/etc/ssh/sshd_config</code>).</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="copy-additional-files-to-the-newly-created-disk">Copy Additional Files to the Newly Created Disk<a class="hash-link" href="#copy-additional-files-to-the-newly-created-disk" title="Direct link to heading">​</a></h4><p>This is a customization from the first category.
In <code>disk-templates/ubuntu_22.04/files</code> there is a file called <code>99-os-cloud-welcome</code> (a script that prints a greeting message).
We want to copy this file to <code>/etc/update-motd.d</code> in our newly created disk, so that it will run whenever a user logs in.</p><p>To do this, you will create a script called <code>copy_files.sh</code> in <code>disk-templates/ubuntu_22.04</code>.
This script will receive a path to a <code>qcow2</code> disk file as an argument, it will mount the disk, and then copy the file to the necessary location.
Then, in the <code>create_disk_from_template</code> function in <code>disk.py</code> you will call this script, similar with how the other scripts are called.</p><p>You can use <code>disk-templates/ubuntu_22.04/setup_root_password.sh</code> as an example.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="ssh-key-setup">SSH Key Setup<a class="hash-link" href="#ssh-key-setup" title="Direct link to heading">​</a></h4><p>We want to be able to log into the virtual machine using an ssh key, instead of the password <code>123456</code>.
Notice that the <code>vm_create</code> API also accepts an <code>ssh_key</code> parameter.
Here, the user can provide an ssh public key, which the system will install in <code>/root/.ssh/authorized_keys</code> in the newly created virtual machine.</p><p>Your task is to implement this feature, as a customization from the second category (that is, implemented in the <code>ubuntu_22_04_vm_prepare</code> function).
The key will be accessible to the function as the <code>ssh_pub_key</code> parameter.
Then it&#x27;s only a matter of writing the key to the appropriate place, using a command like <code>echo key &gt; /root/.ssh/authorized_keys</code>.
Note that the <code>/root/.ssh</code> directory might not exist, so you need to create it as well.</p><p>After the feature is complete, you can test it using the keys in the <code>support/os-cloud/keys</code> directory.
This directory contains a pair of public-private keys.
The directory will also be mounted inside the <code>os-cloud</code> container in <code>/keys</code>.</p><p>You will create another virtual machine, passing the public key to <code>vm_create</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl -H &quot;Content-Type: application/json&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -d &#x27;{ &quot;name&quot;: &quot;my_vm2&quot;, &quot;image&quot;: &quot;ubuntu_22.04&quot;, &quot;network&quot;: &quot;default&quot;, &quot;mem_size&quot;: &quot;2G&quot;, &quot;disk_size&quot;: &quot;10G&quot;, &quot;ssh_key&quot;: &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC8CDHgeE4NIIIih3wSz58GDkfPLUk2m9gmbZB1f6o8Lzawzb3HVFpslAUWK0f/Ymw9cloInpMo50gWMYFSyJ7ZrOWWak54BedpHDkFAxxy+JCE9b+pkKsrAT7wiir7gn2LHlhj55FLZkC9PpM9cBcrMfzlcP9Bf+2cnpDdINybSLmOUmrI23ANteM4lEVaa2yEbCaJk6dFB8+atz5zPjvVI0Hd+kJK7yJ0xV6Zc2ADle7TKW3dyiXOE9qFKe9933Rj7ocqNXCAO1cxUoJCVuVS7lh+1pSSPXLWLTOhVp/XiLGWVP6KRYmmn710MWKm9Kj1tPiGUphUraL20SJiRT6/ os-cloud-user&quot;}&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> localhost:5000/vm_create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;id&quot;:2,&quot;status&quot;:&quot;ok&quot;}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Obtain the IP address that was allocated to the new vm:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ curl -s -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;id&quot;: 2 }&#x27; localhost:5000/vm_info | jq .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;disk_size&quot;: 10737418240,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;id&quot;: 2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;ip&quot;: &quot;192.168.0.3&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;mem_size&quot;: 2147483648,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;name&quot;: &quot;my_vm2&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;network&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;os&quot;: &quot;ubuntu_22.04&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;state&quot;: &quot;RUNNING&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then go inside the <code>os-cloud</code> container and ssh to the vm using the private key in <code>/keys</code>.
It should work without prompting for the password:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ docker-compose exec os-cloud bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ac93d3d6cab2:/app# ssh -i /keys/ssh_key root@192.168.0.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Welcome to Ubuntu 22.04.1 LTS (GNU/Linux 5.15.0-56-generic x86_64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Powered by OS Cloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Last login: Mon Jan  2 19:34:53 2023 from 192.168.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="os-cloud-internet-access">OS-Cloud: Internet Access<a class="hash-link" href="#os-cloud-internet-access" title="Direct link to heading">​</a></h3><p>Notice that our virtual machines don&#x27;t have Internet access:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Powered by OS Cloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Last login: Mon Jan  2 19:52:47 UTC 2023 on ttyS0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~# curl google.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl: (6) Could not resolve host: google.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this task, we want to fix this problem.
To do this, we must first understand how the networking for the virtual machines is done.</p><p>First, there is the concept of a <code>network</code>, which you saw in the previous section.
There is a network called <code>default</code>, with the address of <code>192.168.0.0/24</code>.
All virtual machines are part of this network, that&#x27;s why they were allocated ip addresses like <code>192.168.0.2</code>.</p><p>Let&#x27;s go inside the <code>os-cloud</code> container and take a look at the network interfaces:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker-compose exec os-cloud bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@8333e5cefb0d:/app# ip a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 127.0.0.1/8 scope host lo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/ether 8a:68:b7:5b:6b:45 brd ff:ff:ff:ff:ff:ff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 192.168.0.1/16 scope global br0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3: tap0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master br0 state UP group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/ether 8a:68:b7:5b:6b:45 brd ff:ff:ff:ff:ff:ff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4: tap1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master br0 state UP group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/ether fa:f8:7f:83:50:8f brd ff:ff:ff:ff:ff:ff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">77: eth0@if78: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/ether 02:42:ac:16:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inet 172.22.0.3/16 brd 172.22.255.255 scope global eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       valid_lft forever preferred_lft forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@8333e5cefb0d:/app# ps -ef | grep qemu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          19       8 29 09:15 ?        00:01:26 qemu-system-x86_64 -m 2048 -hda /vm-disks/1/disk.qcow2 -net nic,macaddr=52:54:00:12:34:00 -net tap,ifname=tap0,script=no -monitor telnet::10001,server,nowait -serial telnet::10002,server,nowait -nographic -enable-kvm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          29       8 28 09:15 ?        00:01:24 qemu-system-x86_64 -m 2048 -hda /vm-disks/2/disk.qcow2 -net nic,macaddr=52:54:00:12:34:01 -net tap,ifname=tap1,script=no -monitor telnet::10003,server,nowait -serial telnet::10004,server,nowait -nographic -enable-kvm</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here we have 2 virtual machines running.
Each virtual machine uses a <code>tap</code> interface (the <code>-net tap,ifname=tap0,script=no</code> parameter for <code>qemu</code>).
This means that the <code>ens0</code> interface inside the virtual machine corresponds to the <code>tap0</code> interface outside the virtual machine.
All the tap interfaces are bridged together into the <code>br0</code> bridge, which has the ip address <code>192.168.0.1</code>.
Also, each virtual machine has the default gateway configured to be <code>192.168.0.1</code>.</p><p>In summary, it looks something like this:</p><p><img loading="lazy" alt="os-cloud" src="/operating-systems/158/assets/images/os_cloud_networking-c27fac0c5e0a3100a184bf283728b467.svg" class="img_ev3q"></p><p>All the traffic coming from the virtual machines passes through the <code>br0</code> interface.
So, in order to make the Internet work, all we have to do is a simple <code>NAT</code>, with a command like:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@8333e5cefb0d:/app# iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j MASQUERADE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, the virtual machines should have Internet access:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@8333e5cefb0d:/app# ssh root@192.168.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~# curl google.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;TITLE&gt;301 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;H1&gt;301 Moved&lt;/H1&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The document has moved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;A HREF=&quot;http://www.google.com/&quot;&gt;here&lt;/A&gt;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/BODY&gt;&lt;/HTML&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now your task is to run the <code>iptables</code> command above automatically when the system starts, so that it&#x27;s not necessary to run it manually like we did in the above example.</p><p>A good place to do this is in the <code>create_one_network</code> function in <code>network.py</code>.
There you can add another <code>subprocess.run</code> call to run <code>iptables</code>.
The <code>192.168.0.0/24</code> value should not be hardcoded, but you can take it from the <code>ip_with_prefixlen</code> member of the <code>Net</code> object.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-create-a-new-disk-by-hand">Task: Create a New Disk by Hand<a class="hash-link" href="#task-create-a-new-disk-by-hand" title="Direct link to heading">​</a></h3><p>Navigate to <code>chapters/app-interact/os-cloud/drills/tasks/os-cloud/support</code>.
Let&#x27;s replicate the above-mentioned steps and create a new disk ourselves.</p><p>First, we have to call the 2 scripts from the <code>create_disk_from_template</code> function:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ ./disk-templates/ubuntu_22.04/create_disk_from_template.sh ./disk-templates/ubuntu_22.04/ubuntu_22.04.qcow2 my-disk.qcow2 10737418240</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Image resized.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ ls -lh my-disk.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-r--r-- 1 student student 619M Nov 20 15:41 my-disk.qcow2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ sudo ./disk-templates/ubuntu_22.04/setup_root_password.sh my-disk.qcow2 123456</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we can start a qemu instance using this disk:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ qemu-system-x86_64 -enable-kvm -m 2G -hda my-disk.qcow2 -nographic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Ubuntu 22.04 LTS ubuntu ttyS0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu login: root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here we can further run customization commands, like the ones in the <code>ubuntu_22_04_vm_prepare</code> function, or any other things that we want.</p><p>When we&#x27;re done, we run the <code>halt</code> command:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~# halt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~#          Stopping Session 1 of User root...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  OK  ] Removed slice /system/modprobe.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[  OK  ] Stopped target Graphical Interface.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         Starting System Halt...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[   86.431398] reboot: System halted</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When the <code>System halted</code> message is printed, press <code>CTRL+A X</code> to exit qemu (that is, press <code>CTRL+A</code>, release <code>CTRL</code> and <code>A</code>, press <code>X</code>).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-implement-vm_stop">Task: Implement <code>vm_stop</code><a class="hash-link" href="#task-implement-vm_stop" title="Direct link to heading">​</a></h3><p>The <code>vm_stop</code> command will stop a particular virtual machine, meaning it will stop the qemu process for that vm.
The implementation starts in <code>api_vm_stop</code> in <code>app.py</code>, which is the function that handles the <code>http</code> request for the stop operation.
Here you need to do the following:</p><ul><li><p>extract the virtual machine <code>id</code> from the request</p></li><li><p>use the <code>vm.vm_get</code> function to convert this ID into a <code>VM</code> structure</p></li><li><p>call <code>vm.vm_stop</code> and pass the <code>VM</code> object to it</p></li></ul><p>In <code>vm.vm_stop</code>:</p><ul><li><p>call <code>stop_qemu_for_vm</code></p></li><li><p>change the vm pid in the database to <code>-1</code></p></li><li><p>change the vm state in the database to <code>VM_STATE_STOPPED</code></p></li></ul><p>After modifying the code, you should run <code>docker-compose up --build</code> again.
Also, if your database became inconsistent, you can clean it up by re-running the <code>setup_db.sh</code> script.
Then delete all vm disks with <code>sudo rm -rf vm-disks/*</code>.</p><p>With <code>vm_stop</code> implemented, the system should work like this:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ curl -s localhost:5000/vm_list | jq .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;id&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;my_vm&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ curl -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;id&quot;: 1}&#x27; localhost:5000/vm_scurl -s -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;id&quot;: 1 }&#x27; localhost:5000/vm_info | jq .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;disk_size&quot;: 10737418240,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;id&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;ip&quot;: &quot;192.168.0.2&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;mem_size&quot;: 2147483648,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;name&quot;: &quot;my_vm&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;network&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;os&quot;: &quot;ubuntu_22.04&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;state&quot;: &quot;RUNNING&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The vm is in the <code>RUNNING</code> state.
Now let&#x27;s stop it:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ curl -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;id&quot;: 1}&#x27; localhost:5000/vm_stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;status&quot;:&quot;ok&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ curl -s -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;id&quot;: 1 }&#x27; localhost:5000/vm_info | jq .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;disk_size&quot;: 10737418240,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;id&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;ip&quot;: &quot;192.168.0.2&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;mem_size&quot;: 2147483648,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;name&quot;: &quot;my_vm&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;network&quot;: &quot;default&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;os&quot;: &quot;ubuntu_22.04&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;state&quot;: &quot;STOPPED&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now the state is <code>STOPPED</code>.
Inside the container, the qemu process should be gone as well:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ docker-compose exec os-cloud bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@b0600eff8903:/app# ps -ef</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UID          PID    PPID  C STIME TTY          TIME CMD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root           1       0  0 10:00 ?        00:00:00 /sbin/docker-init -- python3 -u app.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root           7       1  0 10:00 ?        00:00:00 python3 -u app.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          33       0  0 10:00 pts/3    00:00:00 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          41      33  0 10:00 pts/3    00:00:00 ps -ef</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Finally, the vm can be started again using <code>vm_start</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support$ curl -H &quot;Content-Type: application/json&quot; -d &#x27;{ &quot;id&quot;: 1}&#x27; localhost:5000/vm_start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;status&quot;:&quot;ok&quot;}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you&#x27;re having difficulties solving this exercise, go through <a href="/operating-systems/158/Application Interaction/lab12#os-cloud">this</a> reading material.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="more-implementation-details">More Implementation Details<a class="hash-link" href="#more-implementation-details" title="Direct link to heading">​</a></h3><p>The application consists of 2 containers:</p><ul><li><p><code>db</code>, which runs a <code>MySQL</code> database</p></li><li><p><code>os-cloud</code>, which runs the web application and the virtual machines</p></li></ul><p>Let&#x27;s check them.
After running <code>docker-compose up</code>, in another terminal run <code>docker-compose ps</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ docker-compose ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Name                      Command              State                    Ports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">------------------------------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os-cloud_db_1         docker-entrypoint.sh mariadbd   Up      3306/tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os-cloud_os-cloud_1   python3 -u app.py               Up      0.0.0.0:5000-&gt;5000/tcp,:::5000-&gt;5000/tcp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now let&#x27;s move inside the <code>os-cloud</code> container:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ docker-compose exec os-cloud bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@89a986d2526e:/app#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Since the virtual machines run inside this container, we should expect to see the one that we created in the previous step.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@89a986d2526e:/app# ps -ef | cat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UID          PID    PPID  C STIME TTY          TIME CMD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root           1       0  0 09:02 ?        00:00:00 /sbin/docker-init -- python3 -u app.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root           7       1  0 09:02 ?        00:00:00 python3 -u app.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          12       7  6 09:02 ?        00:00:41 qemu-system-x86_64 -enable-kvm -m 2048 -hda /vm-disks/1/disk.qcow2 -net nic,macaddr=52:54:00:12:34:00 -net tap,ifname=tap0,script=no -monitor telnet::10001,server,nowait -serial telnet::10002,server,nowait -nographic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          27       0  0 09:11 pts/3    00:00:00 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          35      27  0 09:13 pts/3    00:00:00 ps -ef</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Indeed, a <code>qemu-system-x86_64</code> process is there.
The vm should be accessible via <code>ssh</code> on the IP <code>192.168.0.2</code> with password <code>123456</code> (if you get <code>connection refused</code> here, you need to wait a bit more for the machine to boot):</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@adf6e0bf4e6e:/app# ssh root@192.168.0.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The authenticity of host &#x27;192.168.0.2 (192.168.0.2)&#x27; can&#x27;t be established.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ED25519 key fingerprint is SHA256:3Mfa1fB9y4knUDJWEmEOTz9dWOE7SVhnH/kCBJ15Y0E.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This key is not known by any other names</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Warning: Permanently added &#x27;192.168.0.2&#x27; (ED25519) to the list of known hosts.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@192.168.0.2&#x27;s password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Welcome to Ubuntu 22.04 LTS (GNU/Linux 5.15.0-40-generic x86_64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Last login: Thu Nov 17 07:49:55 2022</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The vm is also accessible on the serial console (notice the <code>-serial telnet::10002,server,nowait</code> argument to qemu).
If we start a telnet connection on port <code>10002</code>, qemu will show us the virtual machine&#x27;s serial console (basically the output that we normally see when running a virtual machine in text mode)</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@adf6e0bf4e6e:/app# telnet localhost 10002</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trying 127.0.0.1...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connected to localhost.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Escape character is &#x27;^]&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ubuntu login: root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Welcome to Ubuntu 22.04 LTS (GNU/Linux 5.15.0-40-generic x86_64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Last login: Thu Nov 17 07:50:11 UTC 2022 from 192.168.0.1 on pts/0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To exit the serial console, press <code>CTRL+]</code>, then type <code>quit</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@ubuntu:~#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">telnet&gt; quit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection closed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@adf6e0bf4e6e:/app#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="even-more-implementation-details">(Even) More Implementation Details<a class="hash-link" href="#even-more-implementation-details" title="Direct link to heading">​</a></h3><p>The architecture of the system can be summarized in the following diagram:</p><p><img loading="lazy" alt="os-cloud" src="/operating-systems/158/assets/images/os_cloud-ff20c47681f663aa8430106ab44e0cd5.svg" class="img_ev3q"></p><p>The <code>os-cloud</code> container is the core of the entire system.
It consists of a web application written in python using <code>flask</code>.
This web application exposes a virtual machine <code>API</code> that the user can interact with (like <code>vm_create</code>).</p><p>So, when we&#x27;re calling <code>curl</code> like in the example above:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -H &quot;Content-Type: application/json&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> -d &#x27;{ &quot;name&quot;: &quot;my_vm&quot;, &quot;image&quot;: &quot;ubuntu_22.04&quot;, &quot;network&quot;: &quot;default&quot;, &quot;mem_size&quot;: &quot;2G&quot;, &quot;disk_size&quot;: &quot;10G&quot;}&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> localhost:5000/vm_create</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It will do an <code>HTTP POST</code> request (because of the <code>-d</code> parameter) to <code>/vm_create</code>.
The request will be handled by the <code>api_vm_create</code> function in <code>app.py</code> (because of the <code>@app.route(&quot;/vm_create&quot;, methods=[&quot;POST&quot;])</code> line).</p><p>Inside this function, we also have access to the request payload (the string that comes after <code>-d</code> in our <code>curl</code> call).
More specifically, <code>request.json</code> will parse this payload as a <code>JSON</code> object and hand it back to us as a python dictionary.
In this dictionary we&#x27;ll find the parameters for our request, like <code>name</code>, <code>image</code>, <code>network</code>, and so on.</p><p>The function will then take the actions required to create the virtual machine: create the disk, start qemu, interact with the database, etc.
Finally, whatever is returned by the <code>api_vm_create</code> function will be received by the <code>curl</code> request as the <code>HTTP</code> response.
Here we also return <code>JSON</code> objects, like <code>{&quot;id&quot;:1,&quot;status&quot;:&quot;ok&quot;}</code>.</p><p>There are 3 objects used by the system:</p><ul><li><p><code>vm</code> - the actual virtual machine</p></li><li><p><code>disk</code> - holds information about virtual machine disks</p></li><li><p><code>network</code> - holds information about a network</p></li></ul><p>Each of these objects are stored in a table in the database.</p><p>Let&#x27;s check the database contents (take the password from the <code>setup_db.sh</code> file):</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../support/os-cloud$ docker-compose exec db mysql -u os-cloud -p os-cloud</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Enter password:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MariaDB [os-cloud]&gt; select * from vm;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------+---------+------------+------------+-------------------+------------+----------+-------------------+------------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | name  | disk_id | mem_size   | network_id | tap_interface_idx | ip         | qemu_pid | qemu_monitor_port | qemu_serial_port | state |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------+---------+------------+------------+-------------------+------------+----------+-------------------+------------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | my_vm |       1 | 2147483648 |          1 |                 0 | 3232235522 |       18 |             10001 |            10002 |     0 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------+---------+------------+------------+-------------------+------------+----------+-------------------+------------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.001 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MariaDB [os-cloud]&gt; select * from disk;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | size        | template_name |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | 10737418240 | ubuntu_22.04  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+-------------+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.000 sec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MariaDB [os-cloud]&gt; select * from network;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+----------------------+------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| id | name    | bridge_interface_idx | ip         | mask       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+----------------------+------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  1 | default |                    0 | 3232235520 | 4294901760 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----+---------+----------------------+------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 row in set (0.000 sec)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>Note: in real life, DON&#x27;T store passwords in text files inside a repository</code>.</p><p>Some observations:</p><ul><li><p>There is a <code>default</code> network already created.
That is why we specified <code>&quot;network&quot;: &quot;default&quot;</code> in the vm creation parameters, and we see that the vm is assigned to this network (<code>network_id</code> is <code>1</code>).</p></li><li><p>This network&#x27;s ip address is <code>3232235520</code>, which in hex is <code>0xC0A80000</code>, that is, <code>192.168.0.0</code>.
The netmask is <code>0xFFFF0000</code>, or <code>/16</code>.
This explains why our vm received the ip address <code>192.168.0.2</code>.</p></li><li><p>There is a disk with the size of <code>10GB</code>, based on the <code>ubuntu_22.04</code> template, exactly like we requested.
This disk is assigned to our vm (<code>disk_id</code> is <code>1</code>).
The disk file will reside in <code>support/os-cloud/vm-disks/1/disk.qcow2</code>, or <code>/vm-disks/1/disk.qcow2</code> inside the container.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="d-bus">D-Bus<a class="hash-link" href="#d-bus" title="Direct link to heading">​</a></h2><p>D-Bus is an Inter-Process Communication (IPC) mechanism that is commonly present on Linux.
It is particularly used by various components of the desktop environment (like GNOME) to communicate between one another, although the system itself is general-purpose and can be used in any other situations.</p><p>As the name suggests, the communication model is that of a bus: processes connect to the bus, then exchange messages with other processes through the bus.
The bus itself is implemented by the dbus-daemon, and there are in fact multiple buses: one system bus, accessible system-wide, and one or more session buses, each one corresponding to one user login session.</p><p>Every process that connects to D-Bus receives a unique connection name.
This name can be something human-readable, like <code>org.freedesktop.Notifications</code>, or some generated ID, like <code>:1.63</code>.
Once a process is connected, it can expose one or multiple <code>objects</code>.
An object has a path-like name, consisting of strings separated by a slash character (for example, <code>/org/freedesktop/Notifications</code>).
Each object contains one or more <code>interfaces</code>, which have the methods that can be called on that object.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-d-bus-inspection-with-d-feet">Guide: D-Bus Inspection with D-Feet<a class="hash-link" href="#guide-d-bus-inspection-with-d-feet" title="Direct link to heading">​</a></h2><p>In order to better understand these concepts, we&#x27;ll use a graphical tool (<code>D-Feet</code>) to inspect all the available D-Bus objects on our system.</p><p>Run D-Feet and select <code>Session Bus</code> from the top button:</p><p><img loading="lazy" alt="dfeet-session-bus" src="/operating-systems/158/assets/images/dfeet_session_bus-1772a989fbb5f4e3c0f5d0569771e54b.png" width="1631" height="845" class="img_ev3q"></p><p>On the left panel, we can see all the processes connected to D-Bus with their associated <code>connection names</code>.
Scroll down and find <code>org.freedesktop.Notifications</code>.
On the right side, expand <code>/org/freedesktop/Notifications</code> and then expand the <code>org.freedesktop.Notifications</code> interface.
The window should look like this:</p><p><img loading="lazy" alt="dfeet-notifications" src="/operating-systems/158/assets/images/dfeet_notifications-80931f45466247c5cd1d6164d83f97d8.png" width="1623" height="834" class="img_ev3q"></p><p>Some observations:</p><ul><li><p>The bus communication happens over a Unix socket, with the path <code>/run/user/1000/bus</code>.</p></li><li><p><code>org.freedesktop.Notifications</code> on the left panel is the <code>connection name</code>.</p></li><li><p>The process that has connected with this name is <code>/usr/bin/gjs /usr/share/gnome-shell/org.gnome.Shell.Notifications</code> and has the pid of <code>4373</code>.</p></li><li><p>This process exposes one object: <code>/org/freedesktop/Notifications</code>.
Note that the object name is the same as the connection name, where the dots have been replaced with slashes.
This is not a requirement, as the objects exposed by a process can have any name.</p></li></ul><ul><li><p>The object has 4 interfaces: <code>org.freedesktop.DBus.Introspectable</code>, <code>org.freedesktop.DBus.Peer</code>, <code>org.freedesktop.DBus.Properties</code> and <code>org.freedesktop.Notifications</code>.
Note that the last one (<code>org.freedesktop.Notifications</code>) is the same as the connection name, but this again is just a coincidence, not a requirement.</p></li><li><p>The interface <code>org.freedesktop.Notifications</code> has some methods that can be called, such as <code>Notify</code>.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-calling-d-bus-methods">Guide: Calling D-Bus Methods<a class="hash-link" href="#guide-calling-d-bus-methods" title="Direct link to heading">​</a></h2><p>The application behind <code>org.freedesktop.Notifications</code> is responsible with desktop notifications (the small bubbles of text that appear at the top of the screen when some event happens).
When an application wants to send a notification it needs to connect to D-Bus and call the <code>Notify</code> method from the <code>org.freedesktop.Notifications</code> interface.</p><p>In this example, we want to call the <code>Notify</code> method ourselves.
To do this, we must first understand the signature of this method:</p><p><code>Notify (String arg_0, UInt32 arg_1, String arg_2, String arg_3, String arg_4, Array of [String] arg_5, Dict of {String, Variant} arg_6, Int32 arg_7) ↦ (UInt32 arg_8)</code></p><p>This doesn&#x27;t tell us much, but we can find more documentation <a href="https://specifications.freedesktop.org/notification-spec/notification-spec-latest.html#basic-design" target="_blank" rel="noopener noreferrer">here</a>, since <code>freedesktop</code> is an open standard.</p><p>We&#x27;ll set the arguments to the following (for our simple case, most of them will be unused):</p><ul><li><p><code>app_name</code>: <code>&quot;&quot;</code></p></li><li><p><code>replaces_id</code>: <code>0</code></p></li><li><p><code>app_icon</code>: <code>&quot;&quot;</code></p></li><li><p><code>summary</code>: <code>&quot;This is the title&quot;</code></p></li><li><p><code>body</code>: <code>&quot;This is the content&quot;</code></p></li><li><p><code>actions</code>: <code>[]</code></p></li><li><p><code>hints</code>: <code>{}</code></p></li><li><p><code>expire_timeout</code>: <code>-1</code></p></li></ul><p>Now the question is how to actually call the method.
Normally, we would have to write an application that connects to D-Bus and executes the call.
But for demonstrative purposes there are easier ways.</p><p>One way is directly from d-feet.
If we double-click on the <code>Notify</code> method in the right-side pane of d-feet, a window will open that allows us to call the method with any arguments that we want:</p><p><img loading="lazy" alt="dfeet-execute-dialog" src="/operating-systems/158/assets/images/dfeet_execute-0e80376026099d72795e2e52e08d754b.png" width="1821" height="868" class="img_ev3q"></p><p>Then we click the <code>Execute</code> button and the notification will appear:</p><p><img loading="lazy" alt="dfeet-execute-" src="/operating-systems/158/assets/images/dfeet_execute-e3d7472f8f70d73deabbaa7d217c10bb.gif" width="1920" height="1080" class="img_ev3q"></p><p>Another way is from the command-line. There&#x27;s the <code>gdbus</code> tool that can do this:</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-inspecting-the-low-level-communication">Guide: Inspecting the Low-level Communication<a class="hash-link" href="#guide-inspecting-the-low-level-communication" title="Direct link to heading">​</a></h2><p>Let&#x27;s run <code>gdbus</code> under <code>strace</code> to see what&#x27;s happening behind the scenes.
Run the script in <code>support/dbus/send_notification_strace.sh</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">strace: Process 61888 attached</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[pid 61887] socket(AF_UNIX, SOCK_STREAM|SOCK_CLOEXEC, 0) = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[pid 61887] connect(5, {sa_family=AF_UNIX, sun_path=&quot;/run/user/1000/bus&quot;}, 110) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[pid 61887] sendmsg(5, {msg_name=NULL, msg_namelen=0, msg_iov=[{iov_base=&quot;\0&quot;, iov_len=1}], msg_iovlen=1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msg_control=[{cmsg_len=28, cmsg_level=SOL_SOCKET, cmsg_type=SCM_CREDENTIALS, cmsg_data={pid=61887,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uid=1000, gid=1000}}],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msg_controllen=32, msg_flags=0}, MSG_NOSIGNAL) = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">strace: Process 61889 attached</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[pid 61889] sendmsg(5, {msg_name=NULL, msg_namelen=0, msg_iov=[{iov_base=&quot;l\1\0\1T\0\0\0\3\0\0\0\237\0\0\0\1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\1o\0\36\0\0\0/org/freedesktop/Notifications\0\0\2\1s\0\35\0\0\0org.freedesktop.Notifications\0\0\0\6\1s\0\35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\0\0\0org.freedesktop.Notifications\0\0\0\10\1g\0\rsusssasa{sv}i\0\0\0\0\0\0\3\1s\0\6\0\0\0Notify\0\0\0\0\0\0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\21\0\0\0This is the title\0\0\0\23\0\0\0This is the content\0\0\0\0\0\0\0\0\0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\0\0\0\0\377\377\377\377&quot;, iov_len=260}], msg_iovlen=1, msg_controllen=0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> msg_flags=0}, MSG_NOSIGNAL) = 260</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[pid 61889] recvmsg(5, {msg_name=NULL, msg_namelen=0, msg_iov=[{iov_base=&quot;l\2\1\1\4\0\0\0\312\0\0\0.\0\0\0&quot;, iov_len=16}],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">msg_iovlen=1, msg_controllen=0, msg_flags=MSG_CMSG_CLOEXEC}, MSG_CMSG_CLOEXEC) = 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[pid 61889] recvmsg(5, {msg_name=NULL, msg_namelen=0, msg_iov=[{iov_base=&quot;\6\1s\0\6\0\0\0:1.497\0\0\10\1g\0\1u\0\0\5\1u\0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\3\0\0\0\7\1s\0\5\0\0\0:1.49\0\0\0\36\0\0\0&quot;, iov_len=52}], msg_iovlen=1, msg_controllen=0, msg_flags=MSG_CMSG_CLOEXEC}, MSG_CMSG_CLOEXEC) = 52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(uint32 30,)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[pid 61889] +++ exited with 0 +++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[pid 61888] +++ exited with 0 +++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ exited with 0 +++</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see a Unix socket being created and a connection made to <code>/run/user/1000/bus</code>, as expected.
Then a series of messages are exchanged on the socket, which are part of the D-Bus protocol.
On a closer look, we can even identify some strings from our notification, like <code>This is the title</code> or <code>This is the content</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[pid 61889] sendmsg(5, {msg_name=NULL, msg_namelen=0, msg_iov=[{iov_base=&quot;l\1\0\1T\0\0\0\3\0\0\0\237\0\0\0\1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\1o\0\36\0\0\0/org/freedesktop/Notifications\0\0\2\1s\0\35\0\0\0org.freedesktop.Notifications\0\0\0\6\1s\0\35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\0\0\0org.freedesktop.Notifications\0\0\0\10\1g\0\rsusssasa{sv}i\0\0\0\0\0\0\3\1s\0\6\0\0\0Notify\0\0\0\0\0\0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\21\0\0\0This is the title\0\0\0\23\0\0\0This is the content\0\0\0\0\0\0\0\0\0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\0\0\0\0\377\377\377\377&quot;, iov_len=260}], msg_iovlen=1, msg_controllen=0,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-d-bus-usage-in-python">Guide: D-Bus usage in Python<a class="hash-link" href="#guide-d-bus-usage-in-python" title="Direct link to heading">​</a></h2><p>Use the <code>dbus</code> python bindings to get the computer&#x27;s battery level using a python script.
You can start from the documentation <a href="https://dbus.freedesktop.org/doc/dbus-python/tutorial.html#" target="_blank" rel="noopener noreferrer">here</a>.
You need to read the sections <code>Connecting to the Bus</code>, <code>Proxy objects</code>, and <code>Interfaces and methods</code>.</p><p>There&#x27;s also a skeleton you can use in <code>chapters/app-interact/arena/support/dbus/get_battery_level.py</code>.</p><p>In summary, your script will start by connecting to the <code>System Bus</code>.
Then you&#x27;ll use the <code>get_object</code> method to obtain a proxy object.
On this proxy object, you can actually do the method call as explained <a href="https://dbus.freedesktop.org/doc/dbus-python/tutorial.html#interfaces-and-methods" target="_blank" rel="noopener noreferrer">here</a>:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">To call a method, call the method of the same name on the proxy object, passing in the interface name via the dbus_interface keyword argument</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So, if you want to call the method <code>this.is.an.interface.method</code> with the arguments <code>A</code> and <code>B</code> you can do it like this:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> B</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dbus_interface </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;this.is.an.interface&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-firefox">Guide: Firefox<a class="hash-link" href="#guide-firefox" title="Direct link to heading">​</a></h2><p>Let&#x27;s do the following experiment:</p><ul><li><p>Open the Firefox browser</p></li><li><p>From a terminal run <code>firefox www.google.com</code></p></li></ul><p><img loading="lazy" alt="firefox-url-open" src="/operating-systems/158/assets/images/firefox_url_open-85c4cc365a96e2d43b66891dc60c0911.gif" width="1920" height="1080" class="img_ev3q"></p><p>Notice that the URL we passed in the command-line was opened in the existing Firefox window as a new tab.
Even though we started a separate Firefox process, which should have created a separate new window, this didn&#x27;t actually happen.
Instead, the process that we started from the command-line exited immediately and the site was opened in the already running Firefox instance.</p><p>Without any precise knowledge about Firefox internals, we can guess that something like this happened:</p><ul><li><p>The newly started Firefox process detected that another instance of Firefox is already running</p></li><li><p>The newly started Firefox process sent a message to the existing running process, requesting it to open a URL in a new tab</p></li></ul><p>Since we&#x27;re talking about message passing between 2 processes, there&#x27;s a chance that maybe D-Bus was involved.
Let&#x27;s check: we&#x27;ll use a tool called <code>dbus-monitor</code> that will print all messages passed through D-Bus.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ dbus-monitor</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, in another terminal, we&#x27;ll run <code>firefox www.google.com</code> again.</p><p>Going back to the <code>dbus-monitor</code> output, we find the following:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">method call time=1655809062.813923 sender=:1.757 -&gt; destination=org.mozilla.firefox.ZGVmYXVsdC1yZWxlYXNl serial=2 path=/org/mozilla/firefox/Remote; interface=org.mozilla.firefox; member=OpenURL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   array of bytes [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      02 00 00 00 1a 00 00 00 2f 00 00 00 2f 68 6f 6d 65 2f 61 64 72 69 61 6e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      73 00 2f 6f 70 74 2f 66 69 72 65 66 6f 78 2f 66 69 72 65 66 6f 78 00 77</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      77 77 2e 67 6f 6f 67 6c 65 2e 63 6f 6d 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There was a D-Bus call to <code>org.mozilla.firefox.ZGVmYXVsdC1yZWxlYXNl</code>, on the object <code>/org/mozilla/firefox/Remote</code>, method <code>OpenURL</code> from the <code>org.mozilla.firefox</code> interface.
Indeed, we see that this object exists in d-feet as well:</p><p><img loading="lazy" alt="dfeet-firefox" src="/operating-systems/158/assets/images/dfeet_firefox-f29826be8e314acb7f0047d5b5b86431.png" width="1820" height="868" class="img_ev3q"></p><p>We can try to call the <code>OpenURL</code> method ourselves, directly from d-feet.
The method has only one argument of the type <code>Array of [Byte]</code>.
Although there&#x27;s no documentation for it, we can use the same byte array that we saw in <code>dbus-monitor</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   array of bytes [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      02 00 00 00 1a 00 00 00 2f 00 00 00 2f 68 6f 6d 65 2f 61 64 72 69 61 6e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      73 00 2f 6f 70 74 2f 66 69 72 65 66 6f 78 2f 66 69 72 65 66 6f 78 00 77</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      77 77 2e 67 6f 6f 67 6c 65 2e 63 6f 6d 00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>(Note that <code>77 77 77 2e 67 6f 6f 67 6c 65 2e 63 6f 6d</code> at the end is the string <code>www.google.com</code>, so that&#x27;s another confirmation that we&#x27;re on the right track).</p><p><img loading="lazy" alt="dfeet-url-open" src="/operating-systems/158/assets/images/dfeet_url_open-99b78cbaf472fad6a0c5dd4d550b4a55.gif" width="1920" height="1080" class="img_ev3q"></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/operating-systems/158/Application Interaction/Questions/cgroups-vs-namespaces"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Cgroups Versus namespaces</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/operating-systems/158/Assignments/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Assignments</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#task-time-server" class="table-of-contents__link toc-highlight">Task: Time server</a></li><li><a href="#task-password-cracker" class="table-of-contents__link toc-highlight">Task: Password cracker</a></li><li><a href="#task-d-bus---battery-level" class="table-of-contents__link toc-highlight">Task: D-Bus - Battery level</a></li><li><a href="#the-x-window-system" class="table-of-contents__link toc-highlight">The X Window System</a><ul><li><a href="#x-client-and-server-on-the-same-machine" class="table-of-contents__link toc-highlight">X Client and Server on the Same Machine</a></li><li><a href="#oneko" class="table-of-contents__link toc-highlight">Oneko</a></li></ul></li><li><a href="#time-server" class="table-of-contents__link toc-highlight">Time Server</a><ul><li><a href="#python-version" class="table-of-contents__link toc-highlight">Python Version</a></li></ul></li><li><a href="#password-cracker" class="table-of-contents__link toc-highlight">Password Cracker</a><ul><li><a href="#multiprocess-version" class="table-of-contents__link toc-highlight">Multiprocess Version</a></li><li><a href="#multithreaded-version" class="table-of-contents__link toc-highlight">Multithreaded Version</a></li><li><a href="#multiprocess-version-in-python-1" class="table-of-contents__link toc-highlight">Multiprocess Version in Python (1)</a></li><li><a href="#multiprocess-version-in-python-2" class="table-of-contents__link toc-highlight">Multiprocess Version in Python (2)</a></li><li><a href="#multithreaded-version-in-python" class="table-of-contents__link toc-highlight">Multithreaded Version in Python</a></li></ul></li><li><a href="#guide-containers-vs-vms" class="table-of-contents__link toc-highlight">Guide: Containers vs VMs</a><ul><li><a href="#containers" class="table-of-contents__link toc-highlight">Containers</a></li></ul></li><li><a href="#os-cloud" class="table-of-contents__link toc-highlight">OS Cloud</a><ul><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#initial-liftoff" class="table-of-contents__link toc-highlight">Initial Liftoff</a></li><li><a href="#virtual-machine-creation" class="table-of-contents__link toc-highlight">Virtual Machine Creation</a></li><li><a href="#disk-creation" class="table-of-contents__link toc-highlight">Disk Creation</a></li><li><a href="#os-cloud-more-disk-customization" class="table-of-contents__link toc-highlight">OS-Cloud: More Disk Customization</a></li><li><a href="#os-cloud-internet-access" class="table-of-contents__link toc-highlight">OS-Cloud: Internet Access</a></li><li><a href="#task-create-a-new-disk-by-hand" class="table-of-contents__link toc-highlight">Task: Create a New Disk by Hand</a></li><li><a href="#task-implement-vm_stop" class="table-of-contents__link toc-highlight">Task: Implement <code>vm_stop</code></a></li><li><a href="#more-implementation-details" class="table-of-contents__link toc-highlight">More Implementation Details</a></li><li><a href="#even-more-implementation-details" class="table-of-contents__link toc-highlight">(Even) More Implementation Details</a></li></ul></li><li><a href="#d-bus" class="table-of-contents__link toc-highlight">D-Bus</a></li><li><a href="#guide-d-bus-inspection-with-d-feet" class="table-of-contents__link toc-highlight">Guide: D-Bus Inspection with D-Feet</a></li><li><a href="#guide-calling-d-bus-methods" class="table-of-contents__link toc-highlight">Guide: Calling D-Bus Methods</a></li><li><a href="#guide-inspecting-the-low-level-communication" class="table-of-contents__link toc-highlight">Guide: Inspecting the Low-level Communication</a></li><li><a href="#guide-d-bus-usage-in-python" class="table-of-contents__link toc-highlight">Guide: D-Bus usage in Python</a></li><li><a href="#guide-firefox" class="table-of-contents__link toc-highlight">Guide: Firefox</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://curs.upb.ro" target="_blank" rel="noopener noreferrer" class="footer__link-item">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ocw.cs.pub.ro/courses/so" target="_blank" rel="noopener noreferrer" class="footer__link-item">OCW<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/sisteme.de.operare/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 SO Team</div></div></div></footer></div>
<script src="/operating-systems/158/assets/js/runtime~main.f92a7708.js"></script>
<script src="/operating-systems/158/assets/js/main.3b098d9a.js"></script>
</body>
</html>