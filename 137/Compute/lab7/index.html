<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Compute/lab7">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Lab 7 - Copy-on-Write | Operating Systems</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://localhost//operating-systems/137/Compute/lab7"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Lab 7 - Copy-on-Write | Operating Systems"><meta data-rh="true" name="description" content="Task: Investigate apache2 Using strace"><meta data-rh="true" property="og:description" content="Task: Investigate apache2 Using strace"><link data-rh="true" rel="canonical" href="http://localhost//operating-systems/137/Compute/lab7"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/137/Compute/lab7" hreflang="en"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/137/Compute/lab7" hreflang="x-default"><link rel="stylesheet" href="/operating-systems/137/assets/css/styles.a69a9d41.css">
<link rel="preload" href="/operating-systems/137/assets/js/runtime~main.05d2860a.js" as="script">
<link rel="preload" href="/operating-systems/137/assets/js/main.ef0ecfdf.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/operating-systems/137/"><div class="navbar__logo"><img src="/operating-systems/137/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/operating-systems/137/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">SO</b></a><a class="navbar__item navbar__link" href="/operating-systems/137/Software Stack">Software Stack</a><a class="navbar__item navbar__link" href="/operating-systems/137/Data">Data</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/operating-systems/137/Compute">Compute</a><a class="navbar__item navbar__link" href="/operating-systems/137/Application Interaction">Application Interaction</a><a class="navbar__item navbar__link" href="/operating-systems/137/Lecture">Lecture</a><a class="navbar__item navbar__link" href="/operating-systems/137/Assignments">Assignments</a><a class="navbar__item navbar__link" href="/operating-systems/137/Exams">Exams</a><a class="navbar__item navbar__link" href="/operating-systems/137/Hackathons">Hackathons</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/137/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/137/lab-setup">Setting up the Lab Environment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/137/Software Stack/">Software Stack</a><button aria-label="Toggle the collapsible sidebar category &#x27;Software Stack&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/137/Data/">Data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/operating-systems/137/Compute/">Compute</a><button aria-label="Toggle the collapsible sidebar category &#x27;Compute&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/137/Compute/">Slides</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/137/Compute/compute-overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/137/Compute/Questions/">Questions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Questions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/137/Compute/lab6">Lab 6 - Multiprocess and Multithread</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/operating-systems/137/Compute/lab7">Lab 7 - Copy-on-Write</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/137/Compute/lab8">Lab 8 - Syncronization</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/137/Application Interaction/">Application Interaction</a><button aria-label="Toggle the collapsible sidebar category &#x27;Application Interaction&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/137/Lecture/">Lecture</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lecture&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/137/Assignments/">Assignments</a><button aria-label="Toggle the collapsible sidebar category &#x27;Assignments&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/137/Exams/">Exams</a><button aria-label="Toggle the collapsible sidebar category &#x27;Exams&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/137/Hackathons/">Hackathons</a><button aria-label="Toggle the collapsible sidebar category &#x27;Hackathons&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/137/rules-and-grading">Rules and Grading</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/137/resources">Resources</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/operating-systems/137/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/operating-systems/137/Compute/"><span itemprop="name">Compute</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lab 7 - Copy-on-Write</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Lab 7 - Copy-on-Write</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-investigate-apache2-using-strace">Task: Investigate <code>apache2</code> Using <code>strace</code><a class="hash-link" href="#task-investigate-apache2-using-strace" title="Direct link to heading">​</a></h2><p>Enter the <code>chapters/compute/processes-threads-apache2/drills/tasks/apache2/support/</code> folder and go through the practice items below.</p><ol><li>Use <code>strace</code> to discover the server document root.
The document root is the path in the filesystem from where <code>httpd</code> serves all the files requested by the clients.</li></ol><p>First, you will have to stop the running container using <code>make stop</code>, then restart it with <code>make run-privileged</code>.</p><ol><li><p>Use <code>strace</code> inside the container to attach to the worker processes (use the <code>-p</code> option for this).
You will also have to use the <code>-f</code> flag with <code>strace</code>, so that it will follow all the threads inside the processes.</p></li><li><p>After you have attached successfully to all worker processes, use the <code>curl</code> command to send a request.</p></li><li><p>Then check the <code>strace</code> output to see what files were opened by the server.</p></li></ol><p><a href="/operating-systems/137/Compute/Questions/apache2-strace">Quiz</a></p><p>If you&#x27;re having difficulties solving this exercise, go through <a href="/operating-systems/137/Compute/lab7#guide-apache2-live-action">this</a> reading material.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-minor-and-major-page-faults">Task: Minor and Major Page Faults<a class="hash-link" href="#task-minor-and-major-page-faults" title="Direct link to heading">​</a></h2><p>The code in <code>chapters/compute/copy-on-write/drills/tasks/page-faults/support/page_faults.c</code> generates some minor and major page faults.
Open 2 terminals: one in which you will run the program, and one which will monitor the page faults of the program.
In the monitoring terminal, run the following command:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">watch -n 1 &#x27;ps -eo min_flt,maj_flt,cmd | grep ./page_faults | head -n 1&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Compile the program and run it in the other terminal.
You must press <code>enter</code> one time, before the program will prompt you to press <code>enter</code> more times.
Watch the first number on the monitoring terminal;
it increases.
Those are the minor page faults.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="minor-page-faults">Minor Page Faults<a class="hash-link" href="#minor-page-faults" title="Direct link to heading">​</a></h3><p>A minor page fault is generated whenever a requested page is present in the physical memory, as a frame, but that frame isn&#x27;t allocated to the process generating the request.
These types of page faults are the most common, and they happen when calling functions from dynamic libraries, allocating heap memory, loading programs, reading files that have been cached, and many more situations.
Now back to the program.</p><p>The monitoring command already starts with some minor page faults, generated when loading the program.</p><p>After pressing <code>enter</code>, the number increases, because a function from a dynamic library (libc) is fetched when the first <code>printf()</code> is executed.
Subsequent calls to functions that are in the same memory page as <code>printf()</code> won&#x27;t generate other page faults.</p><p>After allocating the 100 Bytes, you might not see the number of page faults increase.
This is because the &quot;bookkeeping&quot; data allocated by <code>malloc()</code> was able to fit in an already mapped page.
The second allocation, the 1GB one, will always generate one minor page fault - for the bookkeeping data about the allocated memory zone.
Notice that not all the pages for the 1GB are allocated.
They are allocated - and generate page faults - when modified.
By now you should know that this mechanism is called <a href="/operating-systems/137/Compute/lab7#copy-on-write">copy-on-write</a>.</p><p>Continue with pressing <code>enter</code> and observing the effects util you reach opening <code>file.txt</code>.</p><p>Note that neither opening a file, getting information about it, nor mapping it in memory using <code>mmap()</code>, generate page faults.
Also note the <code>posix_fadvise()</code> call after the one to <code>fstat()</code>.
With this call we force the OS to not cache the file, so we can generate a <strong>major page fault</strong>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="major-page-faults">Major Page Faults<a class="hash-link" href="#major-page-faults" title="Direct link to heading">​</a></h3><p>Major page faults happen when a page is requested, but it isn&#x27;t present in the physical memory.
These types of page faults happen in 2 situations:</p><ul><li>a page that was swapped out (to the disk), due to lack of memory, is now accessed - this case is harder to show</li><li>the OS needs to read a file from the disk, because the file contents aren&#x27;t present in the cache - the case we are showing now</li></ul><p>Press <code>enter</code> to print the file contents.
Note the second number go up in the monitoring terminal.</p><p>Comment the <code>posix_fadvise()</code> call, recompile the program, and run it again.
You won&#x27;t get any major page fault, because the file contents are cached by the OS, to avoid those page faults.
As a rule, the OS will avoid major page faults whenever possible, because they are very costly in terms of running time.</p><p>If you&#x27;re having difficulties solving this exercise, go through <a href="/operating-systems/137/Compute/lab7#guide-fork-faults">this</a> reading material.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-shared-memory">Task: Shared Memory<a class="hash-link" href="#task-shared-memory" title="Direct link to heading">​</a></h2><p>Navigate to the <code>chapters/compute/copy-on-write/drills/tasks/shared-memory/</code> directory, run <code>make skels</code> to generate the <code>support/</code> folder, enter the <code>support/src/</code> folder, open <code>shared_memory.c</code> and go through the practice items below.</p><p>Use the <code>support/tests/checker.sh</code> script to check your solution.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./checker.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"> passed </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sem_wait </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"> passed </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sem_post </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"> passed </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">match value </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. passed </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total: </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> / </span><span class="token number" style="color:#36acaa">100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you remember from the <a href="/operating-systems/137/Compute/lab3.md#process-memory">Data chapter</a>, one way to allocate a given number of pages is to use the <code>mmap()</code> syscall.</p><p>Let&#x27;s look at its <a href="https://man7.org/linux/man-pages/man2/mmap.2.html" target="_blank" rel="noopener noreferrer">man page</a>, specifically at the <code>flags</code> argument.
Its main purpose is to determine the way in which child processes interact with the mapped pages.</p><p><a href="/operating-systems/137/Compute/Questions/mmap-cow-flag">Quiz</a></p><p>Now let&#x27;s test this flag, as well as its opposite: <code>MAP_SHARED</code>.
Compile and run the code in <code>shared-memory/support/src/shared_memory.c</code>.</p><ol><li><p>See the value read by the parent is different from that written by the child.
Modify the <code>flags</code> parameter of <code>mmap()</code> so they are the same.</p></li><li><p>Create a semaphore in the shared page and use it to make the parent signal the child before it can exit.
Use the API defined in <a href="https://man7.org/linux/man-pages/man0/semaphore.h.0p.html" target="_blank" rel="noopener noreferrer"><code>semaphore.h</code></a>.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">**Be careful!**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The value written and read previously by the child and the parent, respectively, must not change.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">One way of creating a shared semaphore is to place it within a shared memory area, as we&#x27;ve just done.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This only works between &quot;related&quot; processes.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">If you want to share a semaphore or other types of memory between any two processes, you need filesystem support.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">For this, you should use **named semaphores**, created using [`sem_open()`](https://man7.org/linux/man-pages/man3/sem_open.3.html).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You&#x27;ll get more accustomed to such functions in the [Application Interaction chapter].</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-mini-shell">Task: Mini-shell<a class="hash-link" href="#task-mini-shell" title="Direct link to heading">​</a></h2><p>As you might remember, to create a new process you need to use <code>fork</code> (or <code>clone</code>) and <code>exec</code> system calls.
If you don&#x27;t, take a look at <a href="/operating-systems/137/Compute/lab6#guide-system-dissected">what happens under the hood when you use <code>system</code></a>.</p><p>Enter the <code>chapters/compute/processes/drills/tasks/mini-shell</code> directory, run <code>make skels</code>, open the <code>support/src</code> folder and go through the practice items below.</p><p>Use the <code>tests/checker.sh</code> script to check your solutions.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./checker.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mini_shell: </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"> passed </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mini_shell: </span><span class="token builtin class-name">pwd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"> passed </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mini_shell: </span><span class="token builtin class-name">echo</span><span class="token plain"> hello </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"> passed </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> / </span><span class="token number" style="color:#36acaa">100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><p>With this knowledge in mind, let&#x27;s implement our own mini-shell.</p><p>Start from the skeleton code in <code>mini_shell.c</code>.
We&#x27;re already running our Bash interpreter from the command-line, so there&#x27;s no need to <code>exec</code> another Bash from it.</p><p>Simply <code>exec</code> the command.</p><p><a href="/operating-systems/137/Compute/Questions/mini-shell-stops-after-command">Quiz</a></p><p>So we need a way to &quot;save&quot; the <code>mini_shell</code> process before <code>exec()</code>-ing our command.
Find a way to do this.</p><blockquote><p><strong>Hint</strong>:  You can see what <code>sleepy</code> does and draw inspiration from there.
Use <code>strace</code> to also list the calls to <code>clone()</code> performed by <code>sleepy</code> or its children.
<a href="/operating-systems/137/Compute/lab6#guide-threads-and-processes-clone">Remember</a> what <code>clone()</code> is used for and use its parameters to deduce which of the two scenarios happens to <code>sleepy</code>.</p></blockquote></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="usage-of-processes-and-threads-in-apache2">Usage of Processes and Threads in <code>apache2</code><a class="hash-link" href="#usage-of-processes-and-threads-in-apache2" title="Direct link to heading">​</a></h2><p>We&#x27;ll take a look at how a real-world application - the <code>apache2</code> HTTP server - makes use of processes and threads.
Since the server must be able to handle multiple clients at the same time, it must therefore use some form of concurrency.
When a new client arrives, the server offloads the work of interacting with that client to another process or thread.</p><p>The choice of whether to use multiple processes or threads is not baked into the code.
Instead, <code>apache2</code> provides a couple of modules called MPMs (Multi-Processing Modules).
Each module implements a different concurrency model, and the users can pick whatever module best fits their needs by editing the server configuration files.</p><p>The most common MPMs are</p><ul><li><code>prefork</code>: there are multiple worker processes, each process is single-threaded and handles one client request at a time</li><li><code>worker</code>: there are multiple worker processes, each process is multi-threaded, and each thread handles one client request at a time</li><li><code>event</code>: same as <code>worker</code> but designed to better handle some particular use cases</li></ul><p>In principle, <code>prefork</code> provides more stability and backwards compatibility, but it has a bigger overhead.
On the other hand, <code>worker</code> and <code>event</code> are more scalable, and thus able to handle more simultaneous connections, due to the usage of threads.
On modern systems, <code>event</code> is almost always the default.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h3><p>So far, you&#x27;ve probably seen that spawning a process can &quot;use&quot; a different program (hence the path in the args of <code>system</code> or <code>Popen</code>), but some languages such as Python allow you to spawn a process that executes a function from the same script.
A thread, however, can only start from a certain entry point <strong>within the current address space</strong>, as it is bound to the same process.
Concretely, a process is but a group of threads.
For this reason, when we talk about scheduling or synchronization, we talk about threads.
A thread is, thus, an abstraction of a task running on a CPU core.
A process is a logical group of such tasks.</p><p>We can sum up what we&#x27;ve learned so far by saying that processes are better used for separate, independent work, such as the different connections handled by a server.
Conversely, threads are better suited for replicated work: when the same task has to be performed on multiple cores.
However, replicated work can also be suited for processes.
Distributed applications, however, leverage different processes as this allows them to run on multiple physical machines at once.
This is required by the very large workloads such applications are commonly required to process.</p><p>These rules are not set in stone, though.
Like we saw in the <code>apache2</code> example, the server uses multiple threads as well as multiple processes.
This provides a degree of stability - if one worker thread crashes, it will only crash the other threads belonging to the same process - while still taking advantage of the light resource usage inherent to threads.</p><p>These kinds of trade-offs are a normal part of the development of real-world applications.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="copy-on-write">Copy-on-Write<a class="hash-link" href="#copy-on-write" title="Direct link to heading">​</a></h2><p>So far, you know that the parent and child process have separate virtual address spaces.
But how are they created, namely how are they &quot;separated&quot;?
And what about the <strong>PAS (physical address space)</strong>?
Of course, we would like the stack of the parent, for example, to be physically distinct from that of the child, so they can execute different functions and use different local variables.</p><p>But should <strong>all</strong> memory sections from the PAS of the parent be distinct from that of the child?
What about some read-only memory sections, such as <code>.text</code> and <code>.rodata</code>?
And what about the heap, where the child <em>may</em> use some data previously written by the parent and then override it with its own data.</p><p>The answer to all of these questions is a core mechanism of multiprocess operating systems called <strong>Copy-on-Write</strong>.
It works according to one very simple principle:</p><blockquote><p>The VAS of the child process initially points to the same PAS as that of the parent.
A (physical) frame is only duplicated by the child when it attempts to <strong>write</strong> data to it.</p></blockquote><p>This ensures that read-only sections remain shared, while writable sections are shared as long as their contents remain unchanged.
When changes happen, the process making the change receives a unique frame as a modified copy of the original frame <em>on demand</em>.</p><p>In the image below, we have the state of the child and parent processes right after <code>fork()</code> returns in both of them.
See how each has its own VAS, both of them being mapped to (mostly) the same PAS.</p><p><img loading="lazy" alt="Copy-on-Write" src="/operating-systems/137/assets/images/copy-on-write-initial-a3673d26b2087aaacf630bc556e0a6a8.svg" class="img_ev3q"></p><p>When one process writes data to a writeable page (in our case, the child writes to a heap page), the frame to which it corresponds is first duplicated.
Then the process&#x27; page table points the page to the newly copied frame, as you can see in the image below.</p><p><img loading="lazy" alt="Copy-on-Write" src="/operating-systems/137/assets/images/copy-on-write-final-2dfe1835636c0b38b11fed42b5b690d2.svg" class="img_ev3q"></p><p><strong>Be careful!</strong>
Do not confuse <strong>copy-on-write</strong> with <strong>demand paging</strong>.
Remember from the <a href="/operating-systems/137/Compute/lab3.md#working-with-memory">Data chapter</a> that <strong>demand paging</strong> means that when you allocate memory, the OS allocates virtual memory that remains unmapped to physical memory until it&#x27;s used.
On the other hand, <strong>copy-on-write</strong> posits that the virtual memory is already mapped to some frames.
These frames are only duplicated when one of the processes attempts to write data to them.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-apache2-live-action">Guide: <code>apache2</code> Live Action<a class="hash-link" href="#guide-apache2-live-action" title="Direct link to heading">​</a></h2><p>Let&#x27;s run an actual instance of <code>apache2</code> and see how everything works.
Go to <code>apache2/support</code> and run <code>make run</code>.
This will start a container with <code>apache2</code> running inside.</p><p>Check that the server runs as expected:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ curl localhost:8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now go inside the container and take a look at running processes:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../apache2/support$ docker exec -it apache2-test bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@56b9a761d598:/usr/local/apache2# ps -ef</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UID          PID    PPID  C STIME TTY          TIME CMD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root           1       0  0 20:38 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       9       1  0 20:38 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      10       1  0 20:38 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          25       0  0 20:40 pts/1    00:00:00 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          31      25  0 20:40 pts/1    00:00:00 ps -ef</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see 3 <code>httpd</code> processes.
The first one, running as root, is the main process, while the other 2 are the workers.</p><p>Let&#x27;s confirm that we are using the <code>event</code> mpm:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@56b9a761d598:/usr/local/apache2# grep mod_mpm conf/httpd.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LoadModule mpm_event_module modules/mod_mpm_event.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LoadModule mpm_prefork_module modules/mod_mpm_prefork.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LoadModule mpm_worker_module modules/mod_mpm_worker.so</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>event</code> mpm is enabled, so we expect each worker to be multithreaded.
Let&#x27;s check:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@56b9a761d598:/usr/local/apache2# ps -efL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UID          PID    PPID     LWP  C NLWP STIME TTY          TIME CMD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root           1       0       1  0    1 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       8       1       8  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       8       1      11  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       8       1      12  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       8       1      16  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       8       1      17  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       8       1      18  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       8       1      19  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       9       1       9  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       9       1      14  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       9       1      15  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       9       1      20  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       9       1      21  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       9       1      22  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data       9       1      23  0    7 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          24       0      24  1    1 20:56 pts/1    00:00:00 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root          30      24      30  0    1 20:56 pts/1    00:00:00 ps -efL</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Indeed, each worker has 7 threads.
In fact, the number of threads per worker is configurable, as well as the number of initial workers.</p><p>When a new connection is created, it will be handled by whatever thread is available from any worker.
If all the threads are busy, then the server will spawn more worker processes (and therefore more threads), as long as the total number of threads is below some threshold, which is also configurable.</p><p>Let&#x27;s see this dynamic scaling in action.
We need to create a number of simultaneous connections that is larger than the current number of threads.
There is a simple script in <code>/apache2/supportmake_conn.py</code> to do this:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../apache2/support$ python3 make_conn.py localhost 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Press ENTER to exit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The script has created 100 connections and will keep them open until we press Enter.</p><p>Now, in another terminal, let&#x27;s check the situation inside the container:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../apache2/support$ docker exec -it apache2-test bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@56b9a761d598:/usr/local/apache2# ps -efL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UID          PID    PPID     LWP  C NLWP STIME TTY          TIME CMD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root           1       0       1  0    1 20:56 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      40       1      40  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      40       1      45  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      40       1      46  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      40       1      51  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      40       1      52  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      40       1      53  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      40       1      54  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      55       1      55  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      55       1      58  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      55       1      60  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      55       1      62  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      55       1      63  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      55       1      65  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data      55       1      66  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data     109       1     109  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data     109       1     115  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data     109       1     116  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data     109       1     121  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data     109       1     122  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data     109       1     123  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">www-data     109       1     124  0    7 21:07 pts/0    00:00:00 httpd -DFOREGROUND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root         146       0     146  0    1 21:10 pts/1    00:00:00 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root         152     146     152  0    1 21:10 pts/1    00:00:00 ps -efL</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We see a much larger number of threads, as expected.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-fork-faults">Guide: Fork Faults<a class="hash-link" href="#guide-fork-faults" title="Direct link to heading">​</a></h2><p>Now let&#x27;s see the copy-on-write mechanism in practice.
Keep in mind that <code>fork()</code> is a function used to create a process.</p><p>Open two terminals (or better: use <a href="https://github.com/tmux/tmux/wiki" target="_blank" rel="noopener noreferrer"><code>tmux</code></a>).
In one of them, compile and run the code in <code>fork-faults/support/fork_faults.c</code>.
After each time you press <code>Enter</code> in the first terminal window, run the following command in the second window:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../fork-faults/support$ ps -o min_flt,maj_flt -p $(pidof fork_faults)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It will show you the number of minor and major page faults performed by the <code>fork_faults</code> process and its child.</p><p><a href="/operating-systems/137/Compute/Questions/parent-faults-before-fork">Quiz 1</a></p><p>Note that after <code>fork()</code>-ing, there is a second row in the output of <code>ps</code>.
That corresponds to the child process.
The first one still corresponds to the parent.</p><p><a href="/operating-systems/137/Compute/Questions/child-faults-after-write">Quiz 2</a></p><p>Now it should be clear how demand paging differs from copy-on-write.
Shared memory is a similar concept.
It&#x27;s a way of marking certain allocated pages so that copy-on-write is disabled.
As you may imagine, changes made by the parent to this memory are visible to the child and vice-versa.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/operating-systems/137/Compute/lab6"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Lab 6 - Multiprocess and Multithread</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/operating-systems/137/Compute/lab8"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Lab 8 - Syncronization</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#task-investigate-apache2-using-strace" class="table-of-contents__link toc-highlight">Task: Investigate <code>apache2</code> Using <code>strace</code></a></li><li><a href="#task-minor-and-major-page-faults" class="table-of-contents__link toc-highlight">Task: Minor and Major Page Faults</a><ul><li><a href="#minor-page-faults" class="table-of-contents__link toc-highlight">Minor Page Faults</a></li><li><a href="#major-page-faults" class="table-of-contents__link toc-highlight">Major Page Faults</a></li></ul></li><li><a href="#task-shared-memory" class="table-of-contents__link toc-highlight">Task: Shared Memory</a></li><li><a href="#task-mini-shell" class="table-of-contents__link toc-highlight">Task: Mini-shell</a></li><li><a href="#usage-of-processes-and-threads-in-apache2" class="table-of-contents__link toc-highlight">Usage of Processes and Threads in <code>apache2</code></a><ul><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></li><li><a href="#copy-on-write" class="table-of-contents__link toc-highlight">Copy-on-Write</a></li><li><a href="#guide-apache2-live-action" class="table-of-contents__link toc-highlight">Guide: <code>apache2</code> Live Action</a></li><li><a href="#guide-fork-faults" class="table-of-contents__link toc-highlight">Guide: Fork Faults</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://curs.upb.ro" target="_blank" rel="noopener noreferrer" class="footer__link-item">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ocw.cs.pub.ro/courses/so" target="_blank" rel="noopener noreferrer" class="footer__link-item">OCW<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/sisteme.de.operare/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 SO Team</div></div></div></footer></div>
<script src="/operating-systems/137/assets/js/runtime~main.05d2860a.js"></script>
<script src="/operating-systems/137/assets/js/main.ef0ecfdf.js"></script>
</body>
</html>