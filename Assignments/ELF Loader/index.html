<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Assignments/ELF Loader/README">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">ELF Loader Assignment | Operating Systems</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://localhost//operating-systems/Assignments/ELF Loader/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="ELF Loader Assignment | Operating Systems"><meta data-rh="true" name="description" content="Objecives"><meta data-rh="true" property="og:description" content="Objecives"><link data-rh="true" rel="canonical" href="http://localhost//operating-systems/Assignments/ELF Loader/"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/Assignments/ELF Loader/" hreflang="en"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/Assignments/ELF Loader/" hreflang="x-default"><link rel="stylesheet" href="/operating-systems/assets/css/styles.48876178.css">
<link rel="preload" href="/operating-systems/assets/js/runtime~main.f7ca2674.js" as="script">
<link rel="preload" href="/operating-systems/assets/js/main.e5622b0c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/operating-systems/"><div class="navbar__logo"><img src="/operating-systems/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/operating-systems/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">SO</b></a><a class="navbar__item navbar__link" href="/operating-systems/Software Stack">Software Stack</a><a class="navbar__item navbar__link" href="/operating-systems/Data">Data</a><a class="navbar__item navbar__link" href="/operating-systems/Compute">Compute</a><a class="navbar__item navbar__link" href="/operating-systems/IO">IO</a><a class="navbar__item navbar__link" href="/operating-systems/Application Interaction">Application Interaction</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/operating-systems/Assignments">Assignments</a><a class="navbar__item navbar__link" href="/operating-systems/Exams">Exams</a><a class="navbar__item navbar__link" href="/operating-systems/Hackathons">Hackathons</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/lab-setup">Setting up the Lab Environment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Software Stack/">Software Stack</a><button aria-label="Toggle the collapsible sidebar category &#x27;Software Stack&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Data/">Data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Compute/">Compute</a><button aria-label="Toggle the collapsible sidebar category &#x27;Compute&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/IO/">IO</a><button aria-label="Toggle the collapsible sidebar category &#x27;IO&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Application Interaction/">Application Interaction</a><button aria-label="Toggle the collapsible sidebar category &#x27;Application Interaction&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/operating-systems/Assignments/">Assignments</a><button aria-label="Toggle the collapsible sidebar category &#x27;Assignments&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Assignments/Mini Libc/">Mini Libc</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Assignments/Memory Allocator/">Memory Allocator</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/operating-systems/Assignments/ELF Loader/">ELF Loader</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Assignments/Parallel Firewall/">Parallel Firewall</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Assignments/Mini Shell/">Mini Shell</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Assignments/Asynchronous Web Server/">Asynchronous Web Server</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Exams/">Exams</a><button aria-label="Toggle the collapsible sidebar category &#x27;Exams&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Hackathons/">Hackathons</a><button aria-label="Toggle the collapsible sidebar category &#x27;Hackathons&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/rules-and-grading">Rules and Grading</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/resources">Resources</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/operating-systems/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/operating-systems/Assignments/"><span itemprop="name">Assignments</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">ELF Loader</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>ELF Loader Assignment</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="objecives">Objecives<a class="hash-link" href="#objecives" title="Direct link to heading">​</a></h2><ul><li>Practice working with virtual memory, memory protection, and manual relocation.</li><li>Understand the difference between different types of executables, like PIE, non-PIE, statically-linked, etc.</li><li>Understand the stack layout expected by an executable, environment variables, auxiliary vector, command-line arguments, etc.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="statement">Statement<a class="hash-link" href="#statement" title="Direct link to heading">​</a></h2><p>Implement a custom minimal ELF loader, capabale of loading and executing statically linked binaries in Linux.</p><p>Your loader must eventually support:</p><ul><li>Minimal static binaries that make direct Linux syscalls (without libc)</li><li>Statically linked <strong>non-PIE</strong> C programs using <code>libc</code></li><li>Statically linked <strong>PIE</strong> executables</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="support-code">Support Code<a class="hash-link" href="#support-code" title="Direct link to heading">​</a></h2><p>The support code consists of three directories:</p><ul><li><code>src/</code> where you will create your sollution</li><li><code>test/</code> contains the test suite and a bash script to verify your work</li></ul><p>The test suite consists of source code files (<code>.c</code> and <code>.asm</code>), that will be compiled and then executed using your loader.
You can use the <code>Makefile</code> to compile all test files.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation">Implementation<a class="hash-link" href="#implementation" title="Direct link to heading">​</a></h2><p>The assignment is split into <strong>4 graded parts</strong>, totaling <strong>90 points</strong> (10 points are given by the linter):</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-elf-header-validation-10-points">1. ELF header validation (<strong>10 points</strong>)<a class="hash-link" href="#1-elf-header-validation-10-points" title="Direct link to heading">​</a></h3><p><strong>Goal:</strong> Before loading the ELF file, check if it is a valid, 64-bit ELF.
You must check for 2 cases:</p><ul><li>Check the <a href="https://unix.stackexchange.com/questions/153352/what-is-elf-magic" target="_blank" rel="noopener noreferrer">ELF magic</a>, defined <a href="https://chromium.googlesource.com/external/elfutils/+/dts-0.168/libelf/elf.h#120" target="_blank" rel="noopener noreferrer">here</a>.</li><li>Check the <a href="https://chromium.googlesource.com/external/elfutils/+/dts-0.168/libelf/elf.h#123" target="_blank" rel="noopener noreferrer">ELF class</a>, it should be <code>ELFCLASS64</code>.</li></ul><p>In case any of the items above are wrong, print one of the following messages and exit with the corresponding error code:</p><p><code>Not a valid ELF file</code>, exit with code 3.</p><p>or</p><p><code>Not a 64-bit ELF</code>, exit with code 4.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-minimal-loader-for-syscall-only-binaries-10-points">2. Minimal loader for syscall-only binaries (<strong>10 points</strong>)<a class="hash-link" href="#2-minimal-loader-for-syscall-only-binaries-10-points" title="Direct link to heading">​</a></h3><p><strong>Goal:</strong> Make the loader work with extremely minimal ELF binaries (usually written in assembly) that make direct syscalls and do not use libc.</p><ul><li>All memory segments can be loaded with <code>RWX</code> permissions.</li><li>No need to set up <code>argv</code>, <code>envp</code>, or auxiliary vectors.</li><li>These binaries call syscall instructions directly, so <code>libc</code> is not used.</li></ul><p>For this task, you will need to:</p><ul><li>Open the file and map it somewhere in the memory</li><li>Pass through the section headers, and for the <code>PT_LOAD</code> sections create new memory regions (they can have RWX permissions for now), then copy the section from the file into the newly created memory region.</li><li>Pass the execution to the new ELF, by jumping to the entry point.</li></ul><p><strong>Examples/Resources:</strong></p><ul><li><a href="https://refspecs.linuxbase.org/elf/gabi4+/ch5.pheader.html" target="_blank" rel="noopener noreferrer">ELF Specification</a></li><li><a href="https://wiki.osdev.org/ELF" target="_blank" rel="noopener noreferrer">OSDev</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-load-memory-regions-with-correct-permissions-10-points">3. Load memory regions with correct permissions (<strong>10 points</strong>)<a class="hash-link" href="#3-load-memory-regions-with-correct-permissions-10-points" title="Direct link to heading">​</a></h3><p><strong>Goal:</strong> Instead of RWX, check the memory protection flags (<code>PF_R</code>, <code>PF_W</code>, <code>PF_X</code>) from the ELF <code>Program Headers</code>.</p><ul><li>Use <code>mprotect()</code> or map with the correct permissions directly using <code>mmap()</code>.</li></ul><p><strong>Key Concepts:</strong></p><ul><li><code>PT_LOAD</code> program headers contain <code>p_flags</code> to specify memory permissions.</li><li>These must be respected to mimic the kernel loader.</li><li><a href="https://refspecs.linuxbase.org/elf/gabi4+/ch5.pheader.html" target="_blank" rel="noopener noreferrer">ELF Specification</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-support-static-non-pie-binaries-with-libc-30-points">4. Support static non-PIE binaries with libc (<strong>30 points</strong>)<a class="hash-link" href="#4-support-static-non-pie-binaries-with-libc-30-points" title="Direct link to heading">​</a></h3><p><strong>Goal:</strong> Load and run statically linked <strong>non-PIE</strong> C binaries compiled with libc (e.g., via <code>gcc -static</code>).</p><ul><li><p>Must set up a valid process <strong>stack</strong>, including:</p><ul><li><code>argc</code>, <code>argv</code>, <code>envp</code></li><li><code>auxv</code> vector (with entries like <code>AT_PHDR</code>, <code>AT_PHENT</code>, <code>AT_PHNUM</code>, etc.)</li></ul></li></ul><p>For this, you need to map a new memory region, that will become the new stack, then copy all the required information there.</p><p>The executable expects the stack layout as seen in the figure below:</p><p><img loading="lazy" alt="Stack Layout" src="/operating-systems/assets/images/stack-layout.drawio-b9debccd9c136c179bc5373426784894.svg" class="img_ev3q"></p><p>You can see more details about the stack <a href="https://lwn.net/Articles/631631/" target="_blank" rel="noopener noreferrer">here</a>.</p><p>You will have to reserve a memory region large enough for the stack (you can use the maximum allowed stack size, using <code>getrlimit</code>, or you can use a hardcoded value large enough to fit everything).
After that, you need to copy the argc, argv and envp in the expected layout, then set up the auxv.</p><p><strong>Note:</strong> <code>argv</code> and <code>envp</code>, since they consist of strings, will be placed as the <strong>pointer to the string</strong> on the stack, not the string itself.
<strong>Note:</strong> Make sure the mapped regions have the correct length, <strong>be careful of the difference between <code>p_filesz</code> and <code>p_memsz</code></strong>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="argc-argv-5-points-out-of-30">argc, argv (5 points out of 30)<a class="hash-link" href="#argc-argv-5-points-out-of-30" title="Direct link to heading">​</a></h4><p>The command-line arguments must be placed first at the top of the stack, as seen in the picture above.
The loader can be used as <code>./elf_loader ./no-pie-exec arg1 arg2 arg3</code>.
<code>arg1</code>, <code>arg2</code> and <code>arg3</code> must be placed on the stack for the loaded executable.
<code>argc</code> will be also placed on the at the top of the stack.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="envp-5-points-out-of-30">envp (5 points out of 30)<a class="hash-link" href="#envp-5-points-out-of-30" title="Direct link to heading">​</a></h4><p>The environment variables should be placed after the command-line arguments.
For this, you just have to copy everything from the <code>char **envp</code> array and place it on the stack.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="auxv-10-points-out-of-30">auxv (10 points out of 30)<a class="hash-link" href="#auxv-10-points-out-of-30" title="Direct link to heading">​</a></h4><p>The auxiliary vector, auxv, is a mechanism for communicating information from the kernel to user space.
It&#x27;s basically a list of key-value pairs that contains different information about the state of the executable.
You can see the keys and required values of the auxv <a href="https://man7.org/linux/man-pages/man3/getauxval.3.html" target="_blank" rel="noopener noreferrer">in the man pages</a>.
For example, for the key <code>AT_PAGESZ</code> (defined as 6 in <a href="https://elixir.bootlin.com/glibc/glibc-2.42.9000/source/elf/elf.h#L1205" target="_blank" rel="noopener noreferrer">elf.h</a>), that needs to contain the value of the page size, the memory will look as follows:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0xfff......    --&gt; High Addresses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4096         # Page Size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   6           # AT_PAGESZ key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000......    --&gt; Low Addresses</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The auvx must end with an <code>AT_NULL</code> key with a 0 value, so an auxv that sets <code>AT_PAGESZ</code>, <code>AT_UID</code> and <code>AT_NULL</code> will look like this on the stack:</p><p><img loading="lazy" alt="Auxv Example" src="/operating-systems/assets/images/auxv-example.drawio-337988ad6e07792003f401b0caf2aea2.svg" class="img_ev3q"></p><p><strong>Note:</strong> Beware of the <code>AT_RANDOM</code> entry, the application will crash if you do not set it up properly.</p><p><strong>Docs:</strong></p><ul><li><a href="https://lwn.net/Articles/631631/" target="_blank" rel="noopener noreferrer">How programs get run: ELF binaries</a> (See section: <code>Populating the stack</code>)</li><li><a href="https://man7.org/linux/man-pages/man3/getauxval.3.html" target="_blank" rel="noopener noreferrer">auxv man page</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-support-static-pie-executables-30-points">5. Support static PIE executables (<strong>30 points</strong>)<a class="hash-link" href="#5-support-static-pie-executables-30-points" title="Direct link to heading">​</a></h3><p><strong>Goal:</strong> Make your loader support static <strong>PIE (Position Independent Executable)</strong> binaries.</p><ul><li>ELF type will be <code>ET_DYN</code>, and segments must be mapped at a <strong>random base address</strong>.</li><li>Entry point and memory segment virtual addresses must be adjusted by the <code>load_base</code>.</li></ul><p><strong>Additional Requirements:</strong></p><ul><li>Must still build a valid stack (<code>argc</code>, <code>argv</code>, <code>auxv</code>, etc.)</li><li>Handle relocation of entry point and program headers correctly.</li></ul><p>You will need to load all the segments relative to a random base address
Beware of the auxv entries, some of them will need to be adjusted to the offset.</p><p><strong>Docs:</strong></p><ul><li><a href="https://eli.thegreenplace.net/2011/08/25/load-time-relocation-of-shared-libraries" target="_blank" rel="noopener noreferrer">What is a PIE binary?</a></li><li><a href="https://0xc0ffee.netlify.app/osdev/22-elf-loader-p2" target="_blank" rel="noopener noreferrer">Example ELF Loader</a></li><li><a href="https://www.mgaillard.fr/2021/04/15/load-elf-user-mode.html" target="_blank" rel="noopener noreferrer">Another ELF Loader Example</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="debugging">Debugging<a class="hash-link" href="#debugging" title="Direct link to heading">​</a></h2><p>Here are some useful tips and tools to debug your ELF loader:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="general-tips">General Tips<a class="hash-link" href="#general-tips" title="Direct link to heading">​</a></h3><ul><li><strong>Start simple</strong>: First test with a syscall-only ELF binary (e.g., <code>write</code> + <code>exit</code>).</li><li><strong>Use GDB</strong>: Run <code>gdb ./elf_loader</code> and set breakpoints in the loader and inside the loaded ELF.
You can use <code>add-symbol-file path-to-elf start-address</code> to debug the libc entry and the elf execution with debugging symbols.</li><li><strong>Check memory layout</strong>: Print segment addresses and protections. You can use <code>pmap $(pidof elf-loader)</code></li><li><strong>Use PWNGDB</strong>: Use <a href="https://github.com/pwndbg/pwndbg" target="_blank" rel="noopener noreferrer"><code>PwnGDB</code></a> or other similar plugins. They provide a lot of help during debugging.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="useful-tools">Useful Tools<a class="hash-link" href="#useful-tools" title="Direct link to heading">​</a></h4><ul><li><code>readelf -l -h your_binary</code></li><li><code>objdump -d your_binary</code></li><li><code>gdb ./elf_loader</code></li><li><code>pmap $(pidof elf_loader)</code></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="debugging-example">Debugging Example<a class="hash-link" href="#debugging-example" title="Direct link to heading">​</a></h4><p>Let&#x27;s say the <code>no_pie</code> test fails with a segmentation fault, with no other messages printed.
In order to debug that, we must run <code>gdb ./src/elf-loader</code> and <code>run ./tests/snippets/no_pie</code>:</p><div class="language-gdb codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gdb codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$rax   : 0xcc0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rbx   : 0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rcx   : 0x0000000000427aee  →  0xc7a777fffff0003d (&quot;=&quot;?)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rdx   : 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rsp   : 0x00007ffff7df6bc0  →  0x0000000000401835  →  0x20ec8348e5894855</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rbp   : 0x00007ffff7df6c00  →  0x0000000000000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rsi   : 0x20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rdi   : 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$rip   : 0x0000000000403e7b  →  0x894864c030028b48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$r8    : 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$r9    : 0x00000000004a8480  →  &quot;glibc.malloc.mxfast&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$r10   : 0x53053053</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$r11   : 0x246</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$r12   : 0x00007ffff7df6c28  →  0x00007ffff7df7fe8  →  &quot;./tests/snippets/no_pie&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$r13   : 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$r14   : 0x00000000004aa000  →  0x00000000004582f0  →  0xffefc1c5fa1e0ff3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$r15   : 0x00000000004004e8  →  0x0000000000000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$eflags: [ZERO carry PARITY adjust sign trap INTERRUPT direction overflow RESUME virtualx86 identification]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7df6bc0│+0x0000: 0x0000000000401835  →  0x20ec8348e5894855    ← $rsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7df6bc8│+0x0008: 0x0000000000401710  →  0x8949ed31fa1e0ff3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7df6bd0│+0x0010: 0x0000000000000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7df6bd8│+0x0018: 0x0000000000000002</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7df6be0│+0x0020: 0x00007fffffffda98  →  0x00007fffffffde42  →  &quot;/home/stefan/projects/facultate/asist/elf-loader/a[...]&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7df6be8│+0x0028: 0x00007fffffffdab0  →  0x00007fffffffdeb0  →  &quot;SHELL=/bin/bash&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7df6bf0│+0x0030: 0x00007ffff7ff25e8  →  0x00007ffff7f42b60  →  &lt;frame_dummy+0000&gt; endbr64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7df6bf8│+0x0038: 0x0000000000000001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x403e6c                  mov    edi, r13d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x403e6f                  call   0x428e80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x403e74                  mov    rdx, QWORD PTR [rip+0xa5bcd]        # 0x4a9a48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> →   0x403e7b                  mov    rax, QWORD PTR [rdx]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x403e7e                  xor    al, al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x403e80                  mov    QWORD PTR fs:0x28, rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x403e89                  cmp    QWORD PTR [rip+0xa60f7], 0x0        # 0x4a9f88</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x403e91                  je     0x403e9f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x403e93                  call   0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#0] Id 1, Name: &quot;elf-loader&quot;, stopped 0x403e7b in ?? (), reason: SIGSEGV</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that during this tutorial we use <a href="https://github.com/hugsy/gef" target="_blank" rel="noopener noreferrer"><code>gef</code></a>, that is almost identical to <code>pwngdb</code>.
We advise you to use <code>pwngdb</code>, there will be no difference in commands used.</p><p>We can see that the program crashes somewhere with no code or debugging symbols attached, so we can assume it is inside the loaded ELF.
To test this, let&#x27;s break before we jump to the program entry point.</p><div class="language-gdb codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gdb codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ break elf-loader.c:197 # This is the line for `__asm__ __volatile__`, it will be a different line for you</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Breakpoint 1 at 0x7ffff7f437c8: file elf-loader.c, line 197.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ run ./tests/snippets/no_pie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">●→ 0x7ffff7f437c8 &lt;load_and_run+0c3c&gt; mov    rax, QWORD PTR [rbp-0x1d0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7ffff7f437cf &lt;load_and_run+0c43&gt; mov    rdx, QWORD PTR [rbp-0x190]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7ffff7f437d6 &lt;load_and_run+0c4a&gt; mov    rsp, rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7ffff7f437d9 &lt;load_and_run+0c4d&gt; xor    rbp, rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7ffff7f437dc &lt;load_and_run+0c50&gt; jmp    rdx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0x7ffff7f437de &lt;load_and_run+0c52&gt; nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── source:elf-loader.c+197 ────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    192         *(uint64_t *)sp = argc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    193</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    194         void (*entry)() = base + (void (*)())ehdr-&gt;e_entry;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    195</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    196         // Transfer control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">●→  197         __asm__ __volatile__(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    198                         &quot;mov %0, %%rsp\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    199                         &quot;xor %%rbp, %%rbp\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    200                         &quot;jmp *%1\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    201                         :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    202                         : &quot;r&quot;(sp), &quot;r&quot;(entry)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#0] Id 1, Name: &quot;elf-loader&quot;, stopped 0x7ffff7f437c8 in load_and_run (), reason: BREAKPOINT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we do some <code>ni</code> to step with every instruction, until we reach some point where no c code is available anymore (after the <code>jmp rdx</code>).</p><div class="language-gdb codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gdb codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     0x401707                  pop    rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x401708                  ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x401709                  nop    DWORD PTR [rax+0x0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> →   0x401710                  endbr64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x401714                  xor    ebp, ebp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x401716                  mov    r9, rdx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x401719                  pop    rsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x40171a                  mov    rdx, rsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x40171d                  and    rsp, 0xfffffffffffffff0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[#0] Id 1, Name: &quot;elf-loader&quot;, stopped 0x401710 in ?? (), reason: SINGLE STEP</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We check the mapping of the memory:</p><div class="language-gdb codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gdb codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vmmap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[ Legend:  Code | Stack | Heap ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Start              End                Offset             Perm Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000400000 0x0000000000401000 0x0000000000000000 r--</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401000 0x000000000047f000 0x0000000000000000 r-x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000047f000 0x00000000004a5000 0x0000000000000000 r--</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004a5000 0x00000000004b2000 0x0000000000000000 rwx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7600000 0x00007ffff7e00000 0x0000000000000000 rw-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7e72000 0x00007ffff7f33000 0x0000000000000000 r-- .../elf-loader/assignment-elf-loader/tests/snippets/no_pie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7f33000 0x00007ffff7f35000 0x0000000000000000 r-- [vvar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7f35000 0x00007ffff7f37000 0x0000000000000000 r-- [vvar_vclock]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7f37000 0x00007ffff7f39000 0x0000000000000000 r-x [vdso]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7f39000 0x00007ffff7f42000 0x0000000000000000 r-- .../elf-loader/assignment-elf-loader/src/elf-loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7f42000 0x00007ffff7fc9000 0x0000000000009000 r-x .../elf-loader/assignment-elf-loader/src/elf-loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7fc9000 0x00007ffff7ff2000 0x0000000000090000 r-- .../elf-loader/assignment-elf-loader/src/elf-loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7ff2000 0x00007ffff7ff7000 0x00000000000b9000 r-- .../elf-loader/assignment-elf-loader/src/elf-loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7ff7000 0x00007ffff7ff9000 0x00000000000be000 rw- .../elf-loader/assignment-elf-loader/src/elf-loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7ff9000 0x00007ffff7fff000 0x0000000000000000 rw-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffff7fff000 0x00007ffff8021000 0x0000000000000000 rw- [heap]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00007ffffffdd000 0x00007ffffffff000 0x0000000000000000 rw- [stack]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffffffff600000 0xffffffffff601000 0x0000000000000000 --x [vsyscall]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Our current instruction is at address <code>0x401710</code>, which is inside a memory region allocated by <code>mmap</code> for the <code>no_pie</code> file, we can use <code>add-symbol-file</code>.
<code>add-symbol-file</code> expects the <strong>start address of the <code>.text</code> section</strong>, so let&#x27;s get that.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ readelf -S tests/snippets/no_pie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> .text             PROGBITS         **0000000000401100**  00001100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       000000000007d880  0000000000000000  AX       </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> .fini             PROGBITS         000000000047e980  0007e980</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>.text</code> address is the one placed inside <code>**</code>, <code>0x0000000000401100</code>.</p><p>So, bach to <code>gdb</code>:</p><div class="language-gdb codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gdb codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ add-symbol-file tests/snippets/no_pie 0x0000000000401100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add symbol table from file &quot;tests/snippets/no_pie&quot; at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .text_addr = 0x401100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reading symbols from tests/snippets/no_pie...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$  context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> →   0x401710 &lt;_start+0000&gt;    endbr64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x401714 &lt;_start+0004&gt;    xor    ebp, ebp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x401716 &lt;_start+0006&gt;    mov    r9, rdx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x401719 &lt;_start+0009&gt;    pop    rsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we can see where we are in the code of <code>no_pie</code>, the <code>_start</code> function.
Let&#x27;s see where it crashes:</p><div class="language-gdb codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gdb codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     0x403e74 &lt;__libc_start_main_impl+0144&gt; mov    rdx, QWORD PTR [rip+0xa5bcd]        # 0x4a9a48 &lt;_dl_random+139145856&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> →   0x403e7b &lt;__libc_start_main_impl+014b&gt; mov    rax, QWORD PTR [rdx]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x403e7e &lt;__libc_start_main_impl+014e&gt; xor    al, al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0x403e80 &lt;__libc_start_main_impl+0150&gt; mov    QWORD PTR fs:0x28, rax</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Note:</strong> If the application crashes in the <code>__libc_start_main_impl</code> function, it&#x27;s most likely because of the stack (<code>AUXV</code> values), or the memory layout (make sure the mapped regions have the correct length, <strong>be careful of the difference between <code>p_filesz</code> and <code>p_memsz</code></strong>).</p><p>In our case, we can see the <code>rdx</code> register, that is dereferenced, is 0.
We can also see on the instruction above, that <code>rdx</code> is set to <code>_dl_random+139145856</code>.</p><p>The name of <code>_dl_random</code> suggests something to do with <code>auxv[AT_RANDOM]</code>.
Also, if we look into the libc source code (you are not required to do this, you should be able to solve all the issues using gdb, but sometimes looking at the source code helps), <code>_dl_random</code> <a href="https://elixir.bootlin.com/glibc/glibc-2.42.9000/source/sysdeps/unix/sysv/linux/dl-parse_auxv.h#L55" target="_blank" rel="noopener noreferrer">is actually set to <code>auxv[AT_RANDOM]</code></a>.
We did not set the <code>AT_RANDOM</code> value in our loader, so it&#x27;s <code>NULL</code>, which is why it will crash with a <code>SEGV</code>.</p><p>We set the <code>AT_RANDOM</code> value to a memory region pointing to random data, as the <a href="https://man7.org/linux/man-pages/man3/getauxval.3.html" target="_blank" rel="noopener noreferrer">man page</a> says, the crash disappears, and the <code>no_pie</code> elf is loaded properly.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-the-checker">Running the Checker<a class="hash-link" href="#running-the-checker" title="Direct link to heading">​</a></h2><p>In order to check the assignment in an environment as similar to the one on Gitlab CI, you can run the checker, including linters with:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@so:~/.../assignments/elf-loader$ ./local.sh checker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="compilation-tips">Compilation Tips<a class="hash-link" href="#compilation-tips" title="Direct link to heading">​</a></h2><p>To start the testing, run <code>make check</code> in the <code>tests/</code> directory.
You can modify the source files in <code>tests/snippets</code> and try different things.
To run the loader manually, use <code>./elf-loader ../tests/snippets/&lt;test-name&gt; arg1 arg2 ...</code>.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/operating-systems/Assignments/Memory Allocator/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Memory Allocator</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/operating-systems/Assignments/Parallel Firewall/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Parallel Firewall</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#objecives" class="table-of-contents__link toc-highlight">Objecives</a></li><li><a href="#statement" class="table-of-contents__link toc-highlight">Statement</a></li><li><a href="#support-code" class="table-of-contents__link toc-highlight">Support Code</a></li><li><a href="#implementation" class="table-of-contents__link toc-highlight">Implementation</a><ul><li><a href="#1-elf-header-validation-10-points" class="table-of-contents__link toc-highlight">1. ELF header validation (<strong>10 points</strong>)</a></li><li><a href="#2-minimal-loader-for-syscall-only-binaries-10-points" class="table-of-contents__link toc-highlight">2. Minimal loader for syscall-only binaries (<strong>10 points</strong>)</a></li><li><a href="#3-load-memory-regions-with-correct-permissions-10-points" class="table-of-contents__link toc-highlight">3. Load memory regions with correct permissions (<strong>10 points</strong>)</a></li><li><a href="#4-support-static-non-pie-binaries-with-libc-30-points" class="table-of-contents__link toc-highlight">4. Support static non-PIE binaries with libc (<strong>30 points</strong>)</a></li><li><a href="#5-support-static-pie-executables-30-points" class="table-of-contents__link toc-highlight">5. Support static PIE executables (<strong>30 points</strong>)</a></li></ul></li><li><a href="#debugging" class="table-of-contents__link toc-highlight">Debugging</a><ul><li><a href="#general-tips" class="table-of-contents__link toc-highlight">General Tips</a></li></ul></li><li><a href="#running-the-checker" class="table-of-contents__link toc-highlight">Running the Checker</a></li><li><a href="#compilation-tips" class="table-of-contents__link toc-highlight">Compilation Tips</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://curs.upb.ro" target="_blank" rel="noopener noreferrer" class="footer__link-item">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ocw.cs.pub.ro/courses/so" target="_blank" rel="noopener noreferrer" class="footer__link-item">OCW<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/sisteme.de.operare/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 SO Team</div></div></div></footer></div>
<script src="/operating-systems/assets/js/runtime~main.f7ca2674.js"></script>
<script src="/operating-systems/assets/js/main.e5622b0c.js"></script>
</body>
</html>