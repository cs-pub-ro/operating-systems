<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-IO/lab9">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Lab 9 - File Descriptors | Operating Systems</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://localhost//operating-systems/75/IO/lab9"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Lab 9 - File Descriptors | Operating Systems"><meta data-rh="true" name="description" content="Task: My cat"><meta data-rh="true" property="og:description" content="Task: My cat"><link data-rh="true" rel="canonical" href="http://localhost//operating-systems/75/IO/lab9"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/75/IO/lab9" hreflang="en"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/75/IO/lab9" hreflang="x-default"><link rel="stylesheet" href="/operating-systems/75/assets/css/styles.a69a9d41.css">
<link rel="preload" href="/operating-systems/75/assets/js/runtime~main.3030cbd7.js" as="script">
<link rel="preload" href="/operating-systems/75/assets/js/main.b9f8dcc2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/operating-systems/75/"><div class="navbar__logo"><img src="/operating-systems/75/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/operating-systems/75/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">SO</b></a><a class="navbar__item navbar__link" href="/operating-systems/75/Software Stack">Software Stack</a><a class="navbar__item navbar__link" href="/operating-systems/75/Data">Data</a><a class="navbar__item navbar__link" href="/operating-systems/75/Compute">Compute</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/operating-systems/75/IO">IO</a><a class="navbar__item navbar__link" href="/operating-systems/75/Lecture">Lecture</a><a class="navbar__item navbar__link" href="/operating-systems/75/Assignments">Assignments</a><a class="navbar__item navbar__link" href="/operating-systems/75/Exams">Exams</a><a class="navbar__item navbar__link" href="/operating-systems/75/Hackathons">Hackathons</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/75/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/75/lab-setup">Setting up the Lab Environment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Software Stack/">Software Stack</a><button aria-label="Toggle the collapsible sidebar category &#x27;Software Stack&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Data/">Data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Compute/">Compute</a><button aria-label="Toggle the collapsible sidebar category &#x27;Compute&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/operating-systems/75/IO/">IO</a><button aria-label="Toggle the collapsible sidebar category &#x27;IO&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/75/IO/">Slides</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/75/IO/io-overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/75/IO/Questions/">Questions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Questions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/operating-systems/75/IO/lab9">Lab 9 - File Descriptors</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/75/IO/lab10">Lab 10 - Inter-Process Communication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/75/IO/lab11">Lab 11 - IO Optimizations</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Lecture/">Lecture</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lecture&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Assignments/">Assignments</a><button aria-label="Toggle the collapsible sidebar category &#x27;Assignments&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Exams/">Exams</a><button aria-label="Toggle the collapsible sidebar category &#x27;Exams&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Hackathons/">Hackathons</a><button aria-label="Toggle the collapsible sidebar category &#x27;Hackathons&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/75/rules-and-grading">Rules and Grading</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/75/resources">Resources</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/operating-systems/75/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/operating-systems/75/IO/"><span itemprop="name">IO</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lab 9 - File Descriptors</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Lab 9 - File Descriptors</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-my-cat">Task: My <code>cat</code><a class="hash-link" href="#task-my-cat" title="Direct link to heading">​</a></h2><p>Navigate to <code>chapters/io/file-descriptors/drills/tasks/my-cat/support/src</code> and checkout <code>my_cat.c</code>.
We propose to implement the Linux command <code>cat</code> that reads one or more files, <strong>concatenates</strong> them (hence the name <code>cat</code>), and prints them to standard output.</p><ol><li><p>Implement <code>rread()</code> wrapper over <code>read()</code>.</p><p><code>read()</code> system call does not guarantee that it will read the requested number of bytes in a single call.
This happens when the file does not have enough bytes, or when <code>read()</code> is interrupted by a signal.
<code>rread()</code> will handle these situations, ensuring that it reads either <code>num_bytes</code> or all available bytes.</p></li><li><p>Implement <code>wwrite()</code> as a wrapper for <code>write()</code>.</p><p>The <code>write()</code> system call may not write the requested number of bytes in a single call.
This happens if <code>write()</code> is interrupted by a signal.
<code>wwrite()</code> will guarantee that it wrote the full <code>num_bytes</code>, retrying as necessary until all data is successfully written or an error occurs.</p></li><li><p>Implement <code>cat()</code>.</p><p>Use <code>rread()</code> to read an entire file and <code>wwrite()</code> to write the contents to standard output.
Keep in mind that the buffer size may not fit the entire file at once.</p></li></ol><p>If you&#x27;re having difficulties solving this exercise, go through <a href="/operating-systems/75/IO/lab9#file-descriptors">this reading material</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-copy-a-file-with-mmap">Task: Copy a File with <code>mmap()</code><a class="hash-link" href="#task-copy-a-file-with-mmap" title="Direct link to heading">​</a></h2><p>Navigate to <code>file-descriptors/drills/tasks/mmap_cp</code> and run <code>make</code> to generate <code>support</code>.
As you know <code>mmap()</code> can map files in memory, perform operations on them, and then write them back to the disk.
Let&#x27;s check how well it performs by comparing it to the <code>cp</code> command.
The benchmarking is automated by <code>benchmark_cp.sh</code> so focus on completing <code>mmap_cp.c</code> for now.</p><p><a href="/operating-systems/75/IO/Questions/syscalls-cp">Quiz: Checkout what syscalls <code>cp</code> uses</a></p><ol><li><p>Open <code>mmap_cp.c</code> and complete the TODOs to map the files in memory and copy the contents.
Do not forget to clean up by unmapping and closing the files.</p><p>To test, run <code>make test-file</code> to generate a 1MB file with random data, and then run <code>mmap_cp test-file output.txt</code>.
Ensure they have the same content with a simple <code>diff</code>: <code>diff test-file.txt output.txt</code>.</p></li><li><p>Compare your implementation to the <code>cp</code> command.
Run <code>make large-file</code> to generate a 1GB file with random data, and then run <code>./benchmark_cp.sh</code>.</p><p><a href="/operating-systems/75/IO/Questions/mmap-read-write-benchmark">Quiz: Debunk why <code>cp</code> is winning</a></p><p>If you want a more generic answer, checkout this <a href="/operating-systems/75/IO/lab9#guide-file-mappings">guide on <code>mmap</code> vs <code>read()-write()</code></a>.</p></li><li><p>This demo would not be complete without some live analysis.
Uncomment the calls to <code>wait_for_input()</code> and rerun the program.
In another terminal, run <code>cat /proc/$(pidof mmap_cp)/maps</code> to see mapped files, and <code>ps -o pid,vsz,rss &lt;PID&gt;</code> to see how demand paging happens.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-anonymous-pipes-communication">Task: Anonymous Pipes Communication<a class="hash-link" href="#task-anonymous-pipes-communication" title="Direct link to heading">​</a></h2><p>Navigate to <code>chapters/io/ipc/drills/tasks/anon-pipes</code> and run <code>make</code> to generate the <code>support/</code> folder.
In this exercise, you&#x27;ll implement client-server communication between a parent and a child process using an anonymous pipe.
The parent will act as the sender, while the child acts as the receiver, with both processes sharing messages through the pipe.
Since pipes are unidirectional, each process should close the end of the pipe it does not use.</p><ol><li><p>Use the <a href="https://man7.org/linux/man-pages/man7/pipe.7.html" target="_blank" rel="noopener noreferrer"><code>pipe()</code> syscall</a> to create the pipe.
Remember, the first file descriptor (<code>fds[0]</code>) is the read end, and the second (<code>fds[1]</code>) is the write end, similar to how <code>stdin</code> and <code>stdout</code> are represented by file descriptors <code>0</code> and <code>1</code>.</p><p><strong>Hint:</strong> Use <code>exit</code> to end the program.</p><p><a href="/operating-systems/75/IO/Questions/pipe-ends">Quiz: Discover why you cannot use either end of the pipe for reading or writing</a></p></li><li><p>Solve the TODOs in <code>parent_loop</code> and <code>child_loop</code> so that the application stops on <code>exit</code>.
Ensure each process closes the its pipe end before exiting to prevent indefinite blocking.</p><blockquote><p>Why is closing the pipe ends important?</p></blockquote><p>The child process checks for the end of communication by reading from the pipe and checking for <code>EOF</code>, which occurs when the write end is closed.
Without closing the write end, the child will block indefinitely in <code>read()</code>.
As for the parent, it will block indefinitely in <code>wait()</code>.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="file-descriptors">File Descriptors<a class="hash-link" href="#file-descriptors" title="Direct link to heading">​</a></h2><p>You&#x27;ve most likely had to deal with files in the past.
The most common command that works with files is <code>cat</code>.
For a quick refresher, let&#x27;s write something to a file, and then read its contents.</p><p>You’ve likely worked with files before;
now it’s time to see what happens behind the scenes.
The most common way to read a file in Linux is by using the <code>cat</code> command.
For a quick refresher, let’s do a demo by writing some text to a file and then reading it back.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/$ echo &quot;OS Rullz!&quot;  # Print &#x27;OS Rullz!&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OS Rullz!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/$ echo &quot;OS Rullz!&quot; &gt; newfile.txt  # redirect the output to newfile.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Let&#x27;s check the contents of newfile.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/$ cat newfile.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OS Rullz!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If we were to implement this in C, we would use the <code>FILE</code> structure and write something like this:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;newfile.txt&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;r&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// handle error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> rc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rc </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// handle error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For a complete example, check out this guide on <a href="/operating-systems/75/IO/lab9#guide-simple-file-operations">file operations in C, Python, and Java</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="file-operations-explained"><code>FILE</code> Operations Explained<a class="hash-link" href="#file-operations-explained" title="Direct link to heading">​</a></h3><p>The <code>FILE</code> structure is not the most straightforward method for performing file operations.
It is part of <code>libc</code> and functions as a handler for working with files.
This is not particular to C, as most programming languages offer similar handlers.</p><p>Running <code>strace cat newfile.txt</code> reveals that <code>fopen()</code> wraps <code>open()</code> (or <code>openat</code>), <code>fread()</code> wraps <code>read()</code>, and <code>fclose()</code> wraps <code>close()</code>.
As you can see, the <code>FILE</code>-related functions are just syscalls prefixed with <code>f-</code>.</p><table><thead><tr><th><code>FILE</code> Operation</th><th>Syscall</th><th>Description</th></tr></thead><tbody><tr><td><code>fopen()</code></td><td><a href="https://man7.org/linux/man-pages/man2/open.2.html" target="_blank" rel="noopener noreferrer"><code>open()</code></a></td><td>Opens a file and returns a file pointer.</td></tr><tr><td><code>fclose()</code></td><td><a href="https://man7.org/linux/man-pages/man2/close.2.html" target="_blank" rel="noopener noreferrer"><code>close()</code></a></td><td>Closes the file associated with the pointer.</td></tr><tr><td><code>fread()</code></td><td><a href="https://man7.org/linux/man-pages/man2/read.2.html" target="_blank" rel="noopener noreferrer"><code>read()</code></a></td><td>Reads data from the file into a buffer.</td></tr><tr><td><code>fwrite()</code></td><td><a href="https://man7.org/linux/man-pages/man2/write.2.html" target="_blank" rel="noopener noreferrer"><code>write()</code></a></td><td>Writes data from a buffer to the file.</td></tr><tr><td><code>fseek()</code></td><td><a href="https://man7.org/linux/man-pages/man2/lseek.2.html" target="_blank" rel="noopener noreferrer"><code>lseek()</code></a></td><td>Moves the file position indicator.</td></tr><tr><td><code>truncate()</code></td><td><a href="https://man7.org/linux/man-pages/man2/ftruncate.2.html" target="_blank" rel="noopener noreferrer"><code>ftruncate()</code></a></td><td>Truncates the file to a specified length.</td></tr></tbody></table><p>The main distinction between <code>FILE</code> operations and their corresponding system calls is that the latter use a <strong>file descriptor</strong> to reference a file.
<strong>File descriptors</strong> are simply indexes into the process&#x27;s <strong>File Descriptor Table</strong>, which is the list of all currently open files for that process.</p><p>This concept is not entirely new, as each process has three default channels: <code>stdin</code>, <code>stdout</code>, and <code>stderr</code>.
These are, in fact, the first three entries in every process’s <strong>File Descriptor Table</strong>.</p><p><a href="/operating-systems/75/IO/Questions/stderr-fd">Quiz: Test your intuition by finding the file descriptor of <code>stderr</code></a></p><p>Let&#x27;s translate our previous example to illustrate how this change affects the implementation:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> fd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;newfile.txt&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> O_RDONLY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fd </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// handle error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> rc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Not complete, should&#x27;ve used a while loop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rc </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// handle error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">rc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token char">&#x27;\0&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Null-terminate the buffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%s\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To better understand the <strong>file descriptor</strong> API, you can either <a href="/operating-systems/75/IO/lab9#file-descriptor-operations">keep reading about file descriptor operations</a> or checkout <a href="/operating-systems/75/IO/lab9#guide-reading-linux-directories">this guide on reading Linux directories</a>.</p><p>If you&#x27;re interested in understanding how <code>libc</code> utilizes file descriptors to simplify common operations, check out <a href="/operating-systems/75/IO/lab9#guide-libc-file-struct">this guide</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="file-descriptor-operations">File Descriptor Operations<a class="hash-link" href="#file-descriptor-operations" title="Direct link to heading">​</a></h2><p>File descriptors are the primary means of referencing files in our system.
They are created, deleted, and manipulated through file interface operations, namely <code>open()</code>, <code>close()</code> <code>read()</code>, <code>write()</code>, and <code>lseek()</code>.
From a programmer&#x27;s perspective, file descriptors are simply indexes into the process&#x27;s <strong>File Descriptor Table</strong>, which maintains a list of all currently open files for that process.</p><p>In this section, we will focus on how to utilize file descriptors to perform the same operations that <code>FILE</code> allows, and more.
If you want to delve deeper into file descriptors, we recommend exploring <a href="/operating-systems/75/IO/lab9#guide-file-descriptor-table">this guide on the <strong>File Descriptor Table</strong></a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="open"><code>open()</code><a class="hash-link" href="#open" title="Direct link to heading">​</a></h3><p>All processes start with three default file descriptors, inherited from the process&#x27;s parent:</p><ul><li><code>stdin</code> (standard input): 0</li><li><code>stdout</code> (standard output): 1</li><li><code>stderr</code> (standard error): 2</li></ul><p>To create new file descriptors (i.e. open new files), a process can use the <a href="https://man7.org/linux/man-pages/man2/open.2.html" target="_blank" rel="noopener noreferrer"><code>open()</code></a> system call.
It receives the path to the file, some flags which are akin to the <code>mode</code> string passed to <code>fopen()</code>.
An optional <code>mode</code> parameter that denotes the file&#x27;s permissions if the <code>open</code> must create it can also be provided.
If you use <code>O_CREAT</code>, just remember to also pass <code>0644</code> (<code>rw-r--r--</code> in octal, denoted by the first <code>0</code>), or permissions more restrictive.</p><p>Some other useful flags for <code>open()</code> are:</p><ul><li><code>O_APPEND</code>: place file cursor at the end</li><li><code>O_CLOEXEC</code>: close the file descriptor when <code>exec()</code> is called.
This is useful because child processes inherit the file descriptors, and this can lead to security problems.</li><li><code>O_TRUNC</code>: truncate the file to length 0.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="close"><code>close()</code><a class="hash-link" href="#close" title="Direct link to heading">​</a></h3><p>Once you are done with a file descriptor you should call <code>close()</code> to free its <strong>open file structure</strong>.
This is similar to how you free memory once you are done with it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="read-and-write"><code>read()</code> and <code>write()</code><a class="hash-link" href="#read-and-write" title="Direct link to heading">​</a></h3><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">read_bytes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num_bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">written_bytes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num_bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you know, verifying the return code of system calls is the way to go in general.
This is even more apparent when dealing with I/O syscalls, namely <code>read()</code> and <code>write()</code>, which return the number of bytes read or written.</p><p>Syscalls returning the number of bytes might seem redundant, but once you hear about partial I/O operations, it is of utmost importance.
If your process was interrupted by a signal while reading or writing, it is up to you to continue from where it left off.</p><p><strong>Remember: It is mandatory that we always use <code>read()</code> and <code>write()</code> inside <code>while</code> loops.</strong>
Higher-level functions like <code>fread()</code> and <code>fwrite()</code> also use <code>while</code> loops when calling <code>read()</code> and <code>write()</code> respectively.
You can practice this by <a href="/operating-systems/75/IO/lab9#task-my-cat">implementing your own <code>cat</code> command</a>.</p><p>In the following sections, we&#x27;ll use file descriptors and <code>read()</code> and <code>write()</code> to interact with some inter-process-communication mechanisms, such as pipes.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lseek"><code>lseek()</code><a class="hash-link" href="#lseek" title="Direct link to heading">​</a></h3><p>As you know, reading or writing from a file always continues from where it left off.
Most of the time you would read from a file monotonically so it makes sense to keep the interface clean and handle bookkeeping in the back.</p><p>For cases when you selectively update the file or jump around fetching data, or making updates, we have <a href="https://man7.org/linux/man-pages/man2/lseek.2.html" target="_blank" rel="noopener noreferrer"><code>lseek</code></a>.</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">off_t</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">off_t</span><span class="token plain"> offset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> whence</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Its parameters are pretty intuitive: <code>fd</code> stands for the file descriptor and <code>offset</code> stands for the offset.
The <code>whence</code> directive explains what <code>offset</code> is relative to, and has the following values:</p><ul><li><code>SEEK_SET</code>: the file offset is set to offset bytes.</li><li><code>SEEK_CUR</code>: The file offset is set to its current location plus offset bytes.</li><li><code>SEEK_END</code>: the file offset is set to the size of the file plus offset bytes.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pipes">Pipes<a class="hash-link" href="#pipes" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="anonymous-pipes">Anonymous Pipes<a class="hash-link" href="#anonymous-pipes" title="Direct link to heading">​</a></h3><p>In this session, we&#x27;ll explore a new mean of Inter-Process Communication (IPC), namely <strong>the pipes</strong>.
Pipes are by no means something new, and you most probably played with them already in bash:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;log_*.csv&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tr</span><span class="token plain"> -s </span><span class="token string" style="color:#e3116c">&#x27; &#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cut</span><span class="token plain"> -d </span><span class="token string" style="color:#e3116c">&#x27;,&#x27;</span><span class="token plain"> -f </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sort</span><span class="token plain"> -u </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">head</span><span class="token plain"> -n </span><span class="token number" style="color:#36acaa">10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Using pipes (denoted as <code>|</code> in the above example) enables linking the <code>stdout</code> and <code>stdin</code> of multiple processes.
The <code>stdout</code> of <code>cat</code> is the <code>stdin</code> of <code>tr</code>, whose <code>stdout</code> is the <code>stdin</code> of <code>cut</code> and so on.
This &quot;chain&quot; of commands looks like this:</p><p><img loading="lazy" alt="Piped Commands" src="/operating-systems/75/assets/images/piped-commands-118a36fba312c6bea5270dba74d653e2.svg" class="img_ev3q"></p><p>So here we have a <strong>unidirectional</strong> stream of data that starts from <code>cat</code>, is modified by each new command, and then is passed to the next one.
We can tell from the image above that the communication channel between any 2 adjacent commands allows one process to write to it while the other reads from it.
For example, there is no need for <code>cat</code> to read any of <code>tr</code>&#x27;s output, only vice versa.</p><p>In UNIX, the need for such a channel is fulfilled by the <a href="https://man7.org/linux/man-pages/man2/pipe.2.html" target="_blank" rel="noopener noreferrer"><code>pipe()</code> syscall</a>.
Imagine there&#x27;s a literal pipe between any 2 adjacent commands in the image above, where data is what flows through this pipe <strong>in only a single way</strong>.</p><p>Such pipes are known as <strong>anonymous pipes</strong> because they don’t have identifiers.
They are created by a parent process, which shares them with its children.
Data written to an anonymous pipe is stored in a kernel-managed circular buffer, where it’s available for related-processes to read.</p><p>The following example showcases a typical workflow with anonymous pipes in Unix:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">##define </span><span class="token function" style="color:#d73a49">EXIT_ON_COND</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cond</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cond</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">EXIT_FAILURE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// pipe_fd[0] -&gt; for reading</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// pipe_fd[1] -&gt; for writing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> pipe_fd</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">EXIT_ON_COND</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">pipe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pipe_fd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Create the pipe</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> pid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                   </span><span class="token comment" style="color:#999988;font-style:italic">// Fork to create a child process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">EXIT_ON_COND</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// Check for fork() failure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Child process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">EXIT_ON_COND</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pipe_fd</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// Close the read end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">EXIT_ON_COND</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pipe_fd</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;hi&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// Write &quot;hi&quot; to the pipe</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">EXIT_ON_COND</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pipe_fd</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// Close the write end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Parent process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">BUFSIZ</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">EXIT_ON_COND</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pipe_fd</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// Close the write end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">ssize_t</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pipe_fd</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Read data from the pipe into buf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">EXIT_ON_COND</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                            </span><span class="token comment" style="color:#999988;font-style:italic">// Check for read() failure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token char">&#x27;\0&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                                  </span><span class="token comment" style="color:#999988;font-style:italic">// Null-terminate the string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Received: %s\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                  </span><span class="token comment" style="color:#999988;font-style:italic">// Output the received message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In summary, the process creates the pipe and then calls <code>fork()</code> to create a child process.
By default, the file descriptors created by <code>pipe()</code> are shared with the child because the <em>(file descriptor table)</em> is copied upon creation.
To better understand how this works, please refer to <a href="/operating-systems/75/IO/lab9#guide-file-descriptor-table">this guide on the File Descriptor Table (FDT)</a>.</p><p>You can test your understanding of anonymous pipes by completing the <a href="/operating-systems/75/IO/lab9#task-anonymous-pipes-communication">Anonymous Pipes Communication task</a>.</p><p><a href="/operating-systems/75/IO/Questions/anonymous-pipes-limitation">Check your understanding by identifying the limitations of anonymous pipes</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="named-pipes-fifos">Named Pipes (FIFOs)<a class="hash-link" href="#named-pipes-fifos" title="Direct link to heading">​</a></h3><p>As we discussed, anonymous pipes are named so because they lack identifiers.
<strong>Named pipes</strong> address this limitation by creating a <em>special</em> file on disk that serves as an identifier for the pipe.</p><p>You might think that interacting with a file would result in a performance loss compared to anonymous pipes, but this is not the case.
The FIFO file acts merely as <strong>a handler</strong> within the filesystem, which is used to write data to a buffer inside the kernel.
This buffer is responsible for holding the data that is passed between processes, not the filesystem itself.</p><p>Keep in mind that reading from and writing to a FIFO is not the same as interacting with a regular file - <code>read()</code> will block if the pipe is empty and will return <code>EOF</code> when the peer closes the pipe.</p><p>You can practice working with named pipes by completing the <a href="/operating-systems/75/IO/lab10#task-named-pipes-communication">Named Pipes Communication task</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="redirections">Redirections<a class="hash-link" href="#redirections" title="Direct link to heading">​</a></h3><p>Although not directly related, redirections (e.g., <code>ls &gt; file.txt</code>) operate similarly to pipes.
A process creates a new file descriptor, updates its <code>stdout</code>, and then creates the child process.
You can explore the similarities with pipes further in <a href="/operating-systems/75/IO/lab9#guide-redirections">this guide on redirections</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-simple-file-operations">Guide: Simple File Operations<a class="hash-link" href="#guide-simple-file-operations" title="Direct link to heading">​</a></h2><p>To manipulate the file (read its contents, modify them, change its size etc.), each process must first get a <strong>handler</strong> to this file.
Think of this handler as an object by which the process can identify and refer to the file.</p><p>Now take a look at the code examples in <code>file-descriptors/guides/simple-file-operations/support</code>.
Each of them reads the contents of <code>file.txt</code>, modifies them, and then reads the previously modified file again.
Use <code>make</code> to compile the C code, and <code>make java-file-operations</code> to compile the Java code.</p><p>Now run the programs repeatedly in whatever order you wish:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../simple-file-operations/support$ python3 file_operations.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">File contents are: OS Rullz!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Wrote new data to file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">File contents are: Python was here!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../simple-file-operations/support$ ./file_operations  # from the C code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">File contents are: Python was here!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Wrote new data to file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">File contents are: C was here!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../simple-file-operations/support$ java FileOperations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">File contents are: Python was here!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Wrote new data to file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">File contents are: Java was here!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that each piece of code creates a variable, which is then used as a handler.</p><p><a href="/operating-systems/75/IO/Questions/file-handler-c">Quiz</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-redirections">Guide: Redirections<a class="hash-link" href="#guide-redirections" title="Direct link to heading">​</a></h2><p>In the <a href="/operating-systems/75/IO/lab9#file-descriptors">File Descriptors section</a>, we mentioned redirections such as <code>echo &quot;OS Rullz!&quot; &gt; newfile.txt</code>.
We said <code>file.txt</code> has to be opened at some point.
Let’s explore the relevant system calls (<code>open()</code>, <code>openat()</code>) to see this in action:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../guides/redirections$ strace -e trace=open,openat,execve,dup2 -f sh -c &quot;ls &gt; file.txt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execve(&quot;/usr/bin/sh&quot;, [&quot;sh&quot;, &quot;-c&quot;, &quot;ls &gt; file.txt&quot;], 0x7fffe1383e78 /* 36 vars */) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openat(AT_FDCWD, &quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openat(AT_FDCWD, &quot;file.txt&quot;, O_WRONLY|O_CREAT|O_TRUNC, 0666) = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dup2(3, 1)                              = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">strace: Process 77547 attached</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[pid 77547] execve(&quot;/usr/bin/ls&quot;, [&quot;ls&quot;], 0x55ebb9b2dbf8 /* 36 vars */) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Notice that we used <code>sh -c</code> to run <code>ls &gt; file.txt</code>.
Running <code>strace -e trace=open,openat,execve,dup2 -f ls &gt; file.txt</code> would instead redirect the <code>strace</code> output to <code>file.txt</code>, hiding any system calls related to <code>file.txt</code>.
This happens because, as we discussed earlier, redirection is transparent for the process being redirected.
The process still writes to its <code>stdout</code>, but <code>stdout</code> itself is now directed to the specified file.</p><p>Remember how processes are created using <code>fork()</code> and <code>exec()</code>, as shown in this diagram:</p><p><img loading="lazy" alt="Launching a new command in Bash" src="/operating-systems/75/assets/images/fork-exec-e8ff2e7cb057592463ccc850bdaa0228.svg" class="img_ev3q"></p><p>In our case, the main process is <code>sh -c &quot;ls &gt; file.txt&quot;</code>.
In the <code>strace</code> output, we see it opens <code>file.txt</code> on file descriptor <code>3</code>, then uses <a href="https://man7.org/linux/man-pages/man2/dup.2.html" target="_blank" rel="noopener noreferrer"><code>dup2(3, 1)</code></a> to redirect file descriptor <code>1</code> to the same <strong>open file structure</strong>.
It then <strong>forks</strong> a child process and calls <code>execve()</code>.</p><p><code>execve</code> replaces the virtual address space (VAS) of the current process but retains the <a href="/operating-systems/75/IO/lab9#guide-file-descriptor-table">file descriptor table</a>.
This preserve the <code>stdout</code> of the parent process, thus the redirection to <code>file.txt</code> remains effective in the new process as well.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dupdup2---atomic-io"><code>dup()/dup2()</code> - Atomic IO<a class="hash-link" href="#dupdup2---atomic-io" title="Direct link to heading">​</a></h3><p>If you&#x27;re not familiar with the <a href="https://man7.org/linux/man-pages/man2/dup.2.html" target="_blank" rel="noopener noreferrer"><code>dup()</code> syscall</a>, it essentially creates a new file descriptor pointing to an existing <strong>open file structure</strong>.
Unlike <code>open()</code>, as discussed in the <a href="/operating-systems/75/IO/lab9#guide-file-descriptor-table">file descriptor table guide</a>, <code>dup()</code> doesn’t create a fresh open file structure.</p><p>The <code>dup2(old_fd, new_fd)</code> variant closes <code>new_fd</code> before making it point to the same open file structure as <code>old_fd</code>.
While this might seem like a combination of <code>close(new_fd)</code> and <code>open(old_fd)</code>, <code>dup2()</code> is actually atomic, which prevents race conditions.</p><p>To see why atomicity matters, review the code in <code>support/redirect_parallel.c</code>, compile it, and run it.</p><p>You’ll find that <code>redirect_stderr_file.txt</code> contains <code>Message for STDOUT</code>, and <code>redirect_stdout_file.txt</code> contains <code>Message for STDERR</code>.
Investigate the code to understand where the race condition occurred.</p><p>While a <code>mutex</code> around the <code>close()</code> and <code>open()</code> sequence could fix this, it can make the code cumbersome.
Instead, follow the <code>FIXME</code> comments for a more elegant solution using <code>dup2()</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-file-descriptor-table">Guide: File Descriptor Table<a class="hash-link" href="#guide-file-descriptor-table" title="Direct link to heading">​</a></h2><p>Just as each process has its own Virtual Address Space for memory access, it also maintains its own <strong>File Descriptor Table</strong> (FDT) for managing open files.
In this section we will explore how the process structures change when executing syscalls like <code>open()</code>, <code>read()</code>, <code>write()</code>, and <code>close()</code>.</p><p>Upon startup, every process has three <strong>file descriptors</strong> that correspond to standard input (<code>stdin</code>), standard output (<code>stdout</code>), and standard error (<code>stderr</code>).
These descriptors are inherited from the parent process and occupy the <strong>first three</strong> entries in the process&#x27;s <strong>FDT</strong>.</p><table><thead><tr><th>fd</th><th>Open File Struct</th></tr></thead><tbody><tr><td>0</td><td><code>stdin</code></td></tr><tr><td>1</td><td><code>stdout</code></td></tr><tr><td>2</td><td><code>stderr</code></td></tr></tbody></table><p>Each entry <strong>points to</strong> an <strong>open file structure</strong> which stores data about the current session:</p><ul><li><strong>Permissions</strong>: define how the file can be accessed (read, write, or execute);
these are the options passed to <code>open()</code>.</li><li><strong>Offset</strong>: the current position inside the file from which the next read or write operation will occur.</li><li><strong>Reference Count</strong>: The number of file descriptors referencing this open file structure.</li><li><strong>Inode Pointer</strong>: A pointer to the inode structure that contains both the data and metadata associated with the file.</li></ul><p>These <strong>Open File Structures</strong> are held in the <strong>Open File Table (OFT)</strong>, which is global across the system.
Whenever a new file is opened, a new entry is created in this table.</p><p>To illustrate this, let&#x27;s consider a code snippet and examine how the File Descriptor Table and Open File Table would appear.
We will focus on <code>fd</code>, permissions, offset, and reference count, as the inode pointer is not relevant at this moment.
For simplicity, we&#x27;ll also omit the standard file descriptors, as they remain unchanged.</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> fd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;file.txt&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> O_RDONLY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> fd2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;file2.txt&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> O_WRONLY </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> O_APPEND</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> fd3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;file.txt&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> O_RDWR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th>OFT index</th><th>Path</th><th>Perm</th><th>Off</th><th><code>RefCount</code></th></tr></thead><tbody><tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><td>123</td><td><code>file.txt</code></td><td>r--</td><td>0</td><td>1</td></tr><tr><td>140</td><td><code>file2.txt</code></td><td>-w-</td><td>150</td><td>1</td></tr><tr><td>142</td><td><code>file.txt</code></td><td>rw-</td><td>0</td><td>1</td></tr></tbody></table><table><thead><tr><th>fd</th><th>Open File Struct (OFT index)</th></tr></thead><tbody><tr><td>3</td><td>123</td></tr><tr><td>4</td><td>140</td></tr><tr><td>5</td><td>142</td></tr></tbody></table><p>Let&#x27;s discuss the changes from the OFT and FDT to understand what happened:</p><ul><li><code>open(&quot;file.txt&quot;, O_RDONLY)</code> created a new <strong>open file structure</strong> in the <strong>Open File Table</strong> for <code>file.txt</code>.
The entry has read-only (<code>O_RDONLY</code>) permissions and offset <code>0</code>, representing the start of the file.
Subsequently, file descriptor <code>3</code> was assigned to point to this OFT entry, and the reference counter was set to <code>1</code>.</li><li><code>open(&quot;file2.txt&quot;, O_WRONLY)</code> created a similar structure in the OFT for <code>file2.txt</code>, but with write-only (<code>O_WRONLY</code>) permissions and an offset of <code>150</code>, representing the end of the file (<code>O_APPEND</code>).
It then assigned this entry to file descriptor <code>4</code>.</li><li><code>open(&quot;file.txt&quot;, O_RDWR)</code> created a new <strong>open file structure</strong> for <code>file.txt</code> and assigned it to file descriptor <code>5</code>.</li></ul><p>At this point, one might wonder why the last <code>open()</code> call didn&#x27;t reuse the entry at file descriptor <code>3</code> and increase its reference counter instead.
It might seem logical, but doing so would lead to conflicts with the <strong>permissions</strong> and <strong>offset</strong> of the two open file structures.
<strong>Remember:</strong> each <code>open()</code> call creates a new <strong>open file structure</strong> in the <strong>Open File Table</strong>.</p><p>This raises the question about the necessity for a reference counter.
The short answer is <code>dup()</code> (or <code>dup2()</code>) syscall, which duplicates a file descriptor.
Let&#x27;s continue our previous example with the following snippet:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// fd = 3 (from the previous snippet)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> fd4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th>OFT index</th><th>Path</th><th>Perm</th><th>Offset</th><th><code>RefCount</code></th></tr></thead><tbody><tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><td>123</td><td><code>file.txt</code></td><td>r--</td><td>0</td><td>2</td></tr><tr><td>140</td><td><code>file2.txt</code></td><td>-w-</td><td>150</td><td>1</td></tr><tr><td>142</td><td><code>file.txt</code></td><td>rw-</td><td>0</td><td>1</td></tr></tbody></table><table><thead><tr><th>fd</th><th>Open File Struct (OFT index)</th></tr></thead><tbody><tr><td>3</td><td>123</td></tr><tr><td>4</td><td>140</td></tr><tr><td>5</td><td>142</td></tr><tr><td>6</td><td>123</td></tr></tbody></table><p>The call to <code>dup(fd)</code> created a new file descriptor (<code>6</code>) that points to the same <strong>open file structure</strong> as its argument <code>fd</code> (which equals <code>3</code> in our example).
This operation also incremented the reference counter for the entry <code>123</code> in the <strong>Open File Table</strong>.</p><p>As a result, operations performed on file descriptor <code>3</code> and file descriptor <code>6</code> are equivalent.
For instance, <code>read(3)</code> and <code>read(6)</code> will both increment the shared file offset, while the offset of file descriptor <code>5</code> will remain unchanged.
If you want to see a concrete example of when duplicating file descriptors is useful, check out <code>file-descriptors/guides/fd-table/support/redirect-stdout.c</code>.</p><p>Now that you know how to create entries in the <strong>File Descriptor Table</strong> and the <strong>Open File Table</strong>, it’s important to understand how to remove them.
Calling <code>close()</code> will <strong>always</strong> free a file descriptor, but it will <strong>only decrement</strong> the reference counter of the <strong>open file structure</strong>.
The actual closing of the file occurs when the reference counter reaches <code>0</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-libc-file-struct">Guide: libc <code>FILE</code> struct<a class="hash-link" href="#guide-libc-file-struct" title="Direct link to heading">​</a></h2><p>Now, we will take a short look at how the <a href="/operating-systems/75/IO/lab9#file-descriptors">file descriptors</a> are handled in libc.
The Software Stack chapter has taught us that applications generally interact with libraries which expose wrappers on top of syscalls.
The most important library in a POSIX system (such as Linux) is libc.
Among many others, it provides higher-level abstractions over I/O-related syscalls.</p><p><strong>Musl</strong> (read just like &quot;muscle&quot;) is a lightweight implementation of libc, which exposes the same API that you have used so far, while also being fit for embedded and OS development.
For example, <a href="https://unikraft.org/" target="_blank" rel="noopener noreferrer">Unikraft</a> <a href="https://unikraft.org/docs/concepts/" target="_blank" rel="noopener noreferrer">unikernels</a> may <a href="https://github.com/unikraft/lib-musl" target="_blank" rel="noopener noreferrer">use musl</a>.</p><p>First, it provides a <code>struct</code> that groups together multiple data that is necessary when handling files.
We know from the example in <code>support/simple-file-operations/file_operations.c</code> that the file handler employed by libc is <code>FILE *</code>.
<code>FILE</code> is just a <code>typedef</code> for <a href="https://elixir.bootlin.com/musl/v1.2.3/source/src/internal/stdio_impl.h#L21" target="_blank" rel="noopener noreferrer"><code>struct _IO_FILE</code></a>.
Here are the most important fields in <code>struct _IO_FILE</code>:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">_IO_FILE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> fd</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">/* File descriptor */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* Flags with which `open()` was called */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> mode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">/* File permissions; passed to `open()` */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">off_t</span><span class="token plain"> off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">/* File offset from where to read / write */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * Internal buffer used to make fewer costly `read()`/`write()`</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     * syscalls.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token plain"> buf_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Pointers for reading and writing from/to the buffer defined above. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rpos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rend</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wend</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wpos</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Function pointers to syscall wrappers. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">size_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">size_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">off_t</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">seek</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">off_t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">close</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Lock for concurrent file access. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">volatile</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> lock</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you might have imagined, this structure contains the underlying file descriptor, the <code>mode</code> (read, write, truncate etc.) with which the file was opened, as well as the offset within the file from which the next read / write will start.</p><p>Libc also defines its own wrappers over commonly-used syscalls, such as <code>read()</code>, <code>write()</code>, <code>close()</code> and <code>lseek()</code>.
These syscalls themselves need to be implemented by the driver for each file system.
This is done by writing the required functions for each syscall and then populating <a href="https://elixir.bootlin.com/linux/v6.0.9/source/include/linux/fs.h#L2093" target="_blank" rel="noopener noreferrer">this structure</a> with pointers to them.
You will recognise quite a few syscalls: <code>open()</code>, <code>close()</code> <code>read()</code>, <code>write()</code>, <code>mmap()</code> etc.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="printf-buffering"><code>printf()</code> Buffering<a class="hash-link" href="#printf-buffering" title="Direct link to heading">​</a></h3><ol><li><p>Navigate to <code>buffering/support/printf_buffering.c</code>.
Those <code>printf()</code> calls obviously end up calling <code>write()</code> at some point.
Run the code under <code>strace</code>.</p><p><a href="/operating-systems/75/IO/Questions/strace-printf">Quiz: What syscall does <code>printf</code> use?</a></p><p>Since there is only one <code>write()</code> syscall despite multiple calls to <code>printf()</code>, it means that the strings given to <code>printf()</code> as arguments are kept <em>somewhere</em> until the syscall is made.
That <em>somewhere</em> is precisely that buffer inside <code>struct _IO_FILE</code> that we highlighted above.
Remember that syscalls cause the system to change from user mode to kernel mode, which is time-consuming.
Instead of performing one <code>write()</code> syscall per call to <code>printf()</code>, it is more efficient to copy the string passed to <code>printf()</code> to an <strong>internal buffer</strong> inside libc (the <code>unsigned char *buf</code> from above) and then at a given time (like when the buffer is full for example) <code>write()</code> the whole buffer.
This results in far fewer <code>write()</code> syscalls.</p></li><li><p>Now, it is interesting to see how we can force libc to dump that internal buffer.
The most direct way is by using the <code>fflush()</code> library call, which is made for this exact purpose.
But we can be more subtle.
Add a <code>\n</code> in some of the strings printed in <code>buffering/support/printf_buffering.c</code>.
Place them wherever you want (at the beginning, at the end, in the middle).
Recompile the code and observe its change in behaviour under <code>strace</code>.</p><p><a href="/operating-systems/75/IO/Questions/flush-libc-buffer">Quiz: How to get data out of <code>printf</code>&#x27;s buffer?</a></p><p>Now we know that I/O buffering <strong>does happen</strong> within libc.
If you need further convincing, check out the Musl implementation of <a href="https://elixir.bootlin.com/musl/v1.2.3/source/src/stdio/fread.c#L6" target="_blank" rel="noopener noreferrer"><code>fread()</code></a>, for example.
It first copies the <a href="https://elixir.bootlin.com/musl/v1.2.3/source/src/stdio/fread.c#L16" target="_blank" rel="noopener noreferrer">data previously saved in the internal buffer</a>:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rpos </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> f</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rend</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* First exhaust the buffer. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    k </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">MIN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rend </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> f</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rpos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> l</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">memcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dest</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rpos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rpos </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dest </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    l </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, if more data is requested and the internal buffer isn&#x27;t full, it refills it using <a href="https://elixir.bootlin.com/musl/v1.2.3/source/src/stdio/fread.c#L27" target="_blank" rel="noopener noreferrer">the internal <code>read()</code> wrapper</a>.
This wrapper also places the data inside the destination buffer.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-file-mappings">Guide: File Mappings<a class="hash-link" href="#guide-file-mappings" title="Direct link to heading">​</a></h2><p>Mapping a file to the VAS of a process is similar to how shared libraries are loaded into the same VAS.
It&#x27;s a fancier way of saying that the contents of a file are copied from a given offset within that file to a given address.
What&#x27;s nice about this is that the OS handles all offsets, addresses and memory allocations on its own, with a single highly versatile syscall: <code>mmap()</code>.</p><p>Let&#x27;s run a <code>sleep</code> process and inspect its memory zones:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ sleep 1000 &amp;  # start a `sleep` process in the background</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] 17579</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ cat /proc/$(pidof sleep)/maps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55b7b646f000-55b7b6471000 r--p 00000000 103:07 6423964                   /usr/bin/sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55b7b6471000-55b7b6475000 r-xp 00002000 103:07 6423964                   /usr/bin/sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55b7b6475000-55b7b6477000 r--p 00006000 103:07 6423964                   /usr/bin/sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55b7b6478000-55b7b6479000 r--p 00008000 103:07 6423964                   /usr/bin/sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55b7b6479000-55b7b647a000 rw-p 00009000 103:07 6423964                   /usr/bin/sleep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">55b7b677c000-55b7b679d000 rw-p 00000000 00:00 0                          [heap]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fe442f61000-7fe44379d000 r--p 00000000 103:07 6423902                   /usr/lib/locale/locale-archive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fe44379d000-7fe4437bf000 r--p 00000000 103:07 6432810                   /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fe4437bf000-7fe443937000 r-xp 00022000 103:07 6432810                   /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fe443937000-7fe443985000 r--p 0019a000 103:07 6432810                   /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fe443985000-7fe443989000 r--p 001e7000 103:07 6432810                   /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fe443989000-7fe44398b000 rw-p 001eb000 103:07 6432810                   /usr/lib/x86_64-linux-gnu/libc-2.31.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fe44398b000-7fe443991000 rw-p 00000000 00:00 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fe4439ad000-7fe4439ae000 r--p 00000000 103:07 6429709                   /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fe4439ae000-7fe4439d1000 r-xp 00001000 103:07 6429709                   /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fe4439d1000-7fe4439d9000 r--p 00024000 103:07 6429709                   /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fe4439da000-7fe4439db000 r--p 0002c000 103:07 6429709                   /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fe4439db000-7fe4439dc000 rw-p 0002d000 103:07 6429709                   /usr/lib/x86_64-linux-gnu/ld-2.31.so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7fe4439dc000-7fe4439dd000 rw-p 00000000 00:00 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7ffd07aeb000-7ffd07b0c000 rw-p 00000000 00:00 0                          [stack]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7ffd07b8b000-7ffd07b8e000 r--p 00000000 00:00 0                          [vvar]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7ffd07b8e000-7ffd07b8f000 r-xp 00000000 00:00 0                          [vdso]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0                  [vsyscall]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the output above, you can see that the <code>.text</code>, <code>.rodata</code>, and <code>.data</code> sections for each dynamic library are mapped into the process’s VAS, along with the sections of the main executable.</p><p>To understand how these mappings are created, let’s explore a simpler example.
Below is an illustration of how <code>libc</code> is loaded (or mapped) into the VAS of an <code>ls</code> process.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ strace ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap(NULL, 2037344, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fb313c9c000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap(0x7fb313cbe000, 1540096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x22000) = 0x7fb313cbe000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap(0x7fb313e36000, 319488, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19a000) = 0x7fb313e36000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mmap(0x7fb313e84000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7fb313e84000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For a quick recap on <code>mmap(addr, length, prot, flags, fd, offset)</code>, the fifth argument specifies the <strong>file descriptor</strong> to copy data from, while the sixth is the offset within the file from where to start copying.</p><p>In summary, when an executable runs, the loader uses <code>mmap()</code> to reserve memory zones for its shared libraries.
Performance is not affected by this since pages are populated <strong>on-demand</strong>, when they’re accessed for the first time.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="file-io-vs-mmap">File I/O vs <code>mmap()</code><a class="hash-link" href="#file-io-vs-mmap" title="Direct link to heading">​</a></h3><p>When it comes to dynamic libraries, <code>mmap</code> is unmatched.
With a single call, it handles <strong>address mapping</strong>, <strong>permission setting</strong>, and leverages demand paging to populate pages only when accessed.
Additionally, <code>mmap()</code> fully supports <strong>copy-on-write (COW)</strong>, allowing libraries to share the same physical frames across multiple processes, which conserves memory and reduces load time.</p><p>In contrast, using <code>read</code> and <code>write</code> would require loading the entire library into physical memory for each process individually, missing out on both the <strong>copy-on-write</strong> and <strong>demand paging</strong> benefits.</p><p>For regular files, however, the choice isn’t always straightforward.
The main sources of overhead for <code>mmap()</code> include managing virtual memory mappings - which can lead to <strong>TLB flushes</strong> - and the cost of page faults due to <strong>demand paging</strong>.</p><p>On the plus side, <code>mmap()</code> excels with random access patterns, efficiently reusing mapped pages.
It is also great for operating large amounts of data, as it enables the kernel to automatically unload and reload pages as needed when memory when under memory pressure.</p><p>A concrete scenario where these downsides outweigh the benefits of <code>mmap()</code> is one-time, sequential I/O.
If you’re simply planning to read or write a file in one go, <code>read()</code> and <code>write()</code> are the way to go.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-reading-linux-directories">Guide: Reading Linux Directories<a class="hash-link" href="#guide-reading-linux-directories" title="Direct link to heading">​</a></h2><p><strong>Everything in Linux is a file.</strong>
This statement says that the Linux OS treats every entry in a file system (regular file, directory, block device, char device, link, UNIX socket) as a file.
This unified approach simplifies file handling, allowing a single interface to interact with various types of entries.
Let&#x27;s see how this works in practice:</p><ol><li><p>Navigate to <code>guides/reading-linux-dirs/support/</code> and checkout <code>dir_ops.c</code>.
This code creates a directory <code>dir</code>, if it does not exists, and attempts to open it the same way we would open a regular file.
Compile and run the code.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../reading-linux-dirs/support$ ./dir_ops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">12:45:34 FATAL dir_ops.c:17: fopen: Is a directory</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The error message is crystal clear: we cannot use <code>fopen()</code> on directories.
So the <code>FILE</code> structure is unsuited for directories.
Therefore, this handler is not generic enough for a regular Linux filesystem, and we have to use a lower-level function.</p><p><a href="/operating-systems/75/IO/Questions/fopen-syscall">Quiz - What syscall does fopen() use?</a></p></li><li><p>Now that we know that <code>fopen()</code> relies <code>openat()</code>, let&#x27;s try using <a href="https://man7.org/linux/man-pages/man2/open.2.html" target="_blank" rel="noopener noreferrer"><code>open()</code></a>, which wraps <code>openat()</code> but offers a simpler interface.</p><p>Inspect, compile and run the code <code>dir_ops_syscalls.c</code>.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/...reading-linux-dirs/support$ ./dir_ops_syscalls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Directory file descriptor is: 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This output proves that the <code>open()</code> syscall is capable of also handling directories, so it&#x27;s closer to what we want.</p><p><strong>Note:</strong> that it is rather uncommon to use <code>open()</code> for directories.
Most of the time, <a href="https://man7.org/linux/man-pages/man3/opendir.3.html" target="_blank" rel="noopener noreferrer"><code>opendir()</code></a> is used instead.</p></li></ol><p>In conclusion, the key difference between <code>fopen()</code> and <code>open()</code> is in the type of handler they return.
The <code>FILE</code> structure from <code>fopen()</code> is suited only for regular files, while the <strong>file descriptor</strong> returned by <code>open()</code> is more flexible.
The differences between the two handlers are explored in the <a href="/operating-systems/75/IO/lab9#file-descriptors">file descriptors section</a>.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/operating-systems/75/IO/Questions/fopen-syscall"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Syscall Used by `fopen()`</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/operating-systems/75/IO/lab10"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Lab 10 - Inter-Process Communication</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#task-my-cat" class="table-of-contents__link toc-highlight">Task: My <code>cat</code></a></li><li><a href="#task-copy-a-file-with-mmap" class="table-of-contents__link toc-highlight">Task: Copy a File with <code>mmap()</code></a></li><li><a href="#task-anonymous-pipes-communication" class="table-of-contents__link toc-highlight">Task: Anonymous Pipes Communication</a></li><li><a href="#file-descriptors" class="table-of-contents__link toc-highlight">File Descriptors</a><ul><li><a href="#file-operations-explained" class="table-of-contents__link toc-highlight"><code>FILE</code> Operations Explained</a></li></ul></li><li><a href="#file-descriptor-operations" class="table-of-contents__link toc-highlight">File Descriptor Operations</a><ul><li><a href="#open" class="table-of-contents__link toc-highlight"><code>open()</code></a></li><li><a href="#close" class="table-of-contents__link toc-highlight"><code>close()</code></a></li><li><a href="#read-and-write" class="table-of-contents__link toc-highlight"><code>read()</code> and <code>write()</code></a></li><li><a href="#lseek" class="table-of-contents__link toc-highlight"><code>lseek()</code></a></li></ul></li><li><a href="#pipes" class="table-of-contents__link toc-highlight">Pipes</a><ul><li><a href="#anonymous-pipes" class="table-of-contents__link toc-highlight">Anonymous Pipes</a></li><li><a href="#named-pipes-fifos" class="table-of-contents__link toc-highlight">Named Pipes (FIFOs)</a></li><li><a href="#redirections" class="table-of-contents__link toc-highlight">Redirections</a></li></ul></li><li><a href="#guide-simple-file-operations" class="table-of-contents__link toc-highlight">Guide: Simple File Operations</a></li><li><a href="#guide-redirections" class="table-of-contents__link toc-highlight">Guide: Redirections</a><ul><li><a href="#dupdup2---atomic-io" class="table-of-contents__link toc-highlight"><code>dup()/dup2()</code> - Atomic IO</a></li></ul></li><li><a href="#guide-file-descriptor-table" class="table-of-contents__link toc-highlight">Guide: File Descriptor Table</a></li><li><a href="#guide-libc-file-struct" class="table-of-contents__link toc-highlight">Guide: libc <code>FILE</code> struct</a><ul><li><a href="#printf-buffering" class="table-of-contents__link toc-highlight"><code>printf()</code> Buffering</a></li></ul></li><li><a href="#guide-file-mappings" class="table-of-contents__link toc-highlight">Guide: File Mappings</a><ul><li><a href="#file-io-vs-mmap" class="table-of-contents__link toc-highlight">File I/O vs <code>mmap()</code></a></li></ul></li><li><a href="#guide-reading-linux-directories" class="table-of-contents__link toc-highlight">Guide: Reading Linux Directories</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://curs.upb.ro" target="_blank" rel="noopener noreferrer" class="footer__link-item">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ocw.cs.pub.ro/courses/so" target="_blank" rel="noopener noreferrer" class="footer__link-item">OCW<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/sisteme.de.operare/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 SO Team</div></div></div></footer></div>
<script src="/operating-systems/75/assets/js/runtime~main.3030cbd7.js"></script>
<script src="/operating-systems/75/assets/js/main.b9f8dcc2.js"></script>
</body>
</html>