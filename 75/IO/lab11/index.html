<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-IO/lab11">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Lab 11 - IO Optimizations | Operating Systems</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://localhost//operating-systems/75/IO/lab11"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Lab 11 - IO Optimizations | Operating Systems"><meta data-rh="true" name="description" content="Task: Ordered Client-Server Communication"><meta data-rh="true" property="og:description" content="Task: Ordered Client-Server Communication"><link data-rh="true" rel="canonical" href="http://localhost//operating-systems/75/IO/lab11"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/75/IO/lab11" hreflang="en"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/75/IO/lab11" hreflang="x-default"><link rel="stylesheet" href="/operating-systems/75/assets/css/styles.a69a9d41.css">
<link rel="preload" href="/operating-systems/75/assets/js/runtime~main.0fc4e57f.js" as="script">
<link rel="preload" href="/operating-systems/75/assets/js/main.7cb9414d.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/operating-systems/75/"><div class="navbar__logo"><img src="/operating-systems/75/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/operating-systems/75/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">SO</b></a><a class="navbar__item navbar__link" href="/operating-systems/75/Software Stack">Software Stack</a><a class="navbar__item navbar__link" href="/operating-systems/75/Data">Data</a><a class="navbar__item navbar__link" href="/operating-systems/75/Compute">Compute</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/operating-systems/75/IO">IO</a><a class="navbar__item navbar__link" href="/operating-systems/75/Lecture">Lecture</a><a class="navbar__item navbar__link" href="/operating-systems/75/Assignments">Assignments</a><a class="navbar__item navbar__link" href="/operating-systems/75/Exams">Exams</a><a class="navbar__item navbar__link" href="/operating-systems/75/Hackathons">Hackathons</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/75/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/75/lab-setup">Setting up the Lab Environment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Software Stack/">Software Stack</a><button aria-label="Toggle the collapsible sidebar category &#x27;Software Stack&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Data/">Data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Compute/">Compute</a><button aria-label="Toggle the collapsible sidebar category &#x27;Compute&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/operating-systems/75/IO/">IO</a><button aria-label="Toggle the collapsible sidebar category &#x27;IO&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/75/IO/">Slides</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/75/IO/io-overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/75/IO/Questions/">Questions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Questions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/75/IO/lab9">Lab 9 - File Descriptors</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/75/IO/lab10">Lab 10 - Inter-Process Communication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/operating-systems/75/IO/lab11">Lab 11 - IO Optimizations</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Lecture/">Lecture</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lecture&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Assignments/">Assignments</a><button aria-label="Toggle the collapsible sidebar category &#x27;Assignments&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Exams/">Exams</a><button aria-label="Toggle the collapsible sidebar category &#x27;Exams&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/75/Hackathons/">Hackathons</a><button aria-label="Toggle the collapsible sidebar category &#x27;Hackathons&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/75/rules-and-grading">Rules and Grading</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/75/resources">Resources</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/operating-systems/75/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/operating-systems/75/IO/"><span itemprop="name">IO</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lab 11 - IO Optimizations</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Lab 11 - IO Optimizations</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-ordered-client-server-communication">Task: Ordered Client-Server Communication<a class="hash-link" href="#task-ordered-client-server-communication" title="Direct link to heading">​</a></h2><p>Navigate to <code>chapters/io/ipc/drills/tasks/client-server/</code> and run <code>make</code> to generate the <code>support</code> directory.
This exercise will guide you in creating a basic messaging protocol between a server and a client.
Although in real-world applications a server typically handles multiple connections at once, here we focus on a single connection.
Handling multiple connections is further explored in <a href="/operating-systems/75/IO/lab11#i/o-multiplexing">I/O multiplexing</a>.</p><p>Our application protocol is defined as follows:</p><ul><li>The <strong>server</strong> listens for connections on <strong>localhost</strong> and a specified <strong>port</strong>.</li><li>The <strong>client</strong> connects to <code>localhost:port</code>.</li><li>The <strong>client</strong> sends a message, which the <strong>server</strong> then prints, responds to, and the <strong>client</strong> prints the reply.
This sequence repeats in a loop.</li><li>The communication ends when either the <strong>client</strong> or the <strong>server</strong> sends the message <code>exit</code>.</li></ul><p>Since we are blocking on <code>recv()</code>, the message order is fixed - the client <strong>must</strong> initiate communication.
In real-world applications, this constraint can be avoided with <a href="/operating-systems/75/IO/lab11#i/o-multiplexing">I/O multiplexing</a>.</p><ol><li><p>Open <code>support/client.c</code> and complete the TODOs to enable message exchange with the server.
Test your client by running <code>python server.py</code> in one terminal and then <code>./client</code> in another.
If correctly implemented, you should be able to exchange messages as outlined above.</p><p><strong>Bonus Question:</strong> Why is it OK for the client to be implemented in C while the server is implemented in Python?</p></li><li><p>Open <code>support/server.c</code> and complete the TODOs to enable message exchange with the client.
Test your server by running <code>./server</code> in one terminal and then <code>python client.py</code> in another.
If implemented correctly, you should be able to exchange messages as outlined above.</p></li></ol><p>If you&#x27;re having difficulties solving this exercise, go through <a href="/operating-systems/75/IO/lab10#unix-sockets">the sockets API</a> and <a href="/operating-systems/75/IO/lab10#client-server-model">the client-server model</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-multiplexed-client-server">Task: Multiplexed Client Server<a class="hash-link" href="#task-multiplexed-client-server" title="Direct link to heading">​</a></h2><p>Navigate to <code>chapters/io/optimizations/drills/tasks/client-server-epoll</code> and run <code>make</code> to generate the <code>support</code> files.</p><p>This task builds on the previous implementation of a <a href="/operating-systems/75/IO/lab11#task-ordered-client-server-communication">client-server ordered communication</a>.
Previously, the client and server followed a strict, sequential communication pattern: each peer had to send a message and wait for a reply before proceeding.</p><p>We plan to build a group chat where clients can send messages at any time, and each message is broadcast to all other connected clients.
To accomplish this, we’ll implement I/O multiplexing mechanisms that notify us only when data is available on a file descriptor.
This non-blocking approach allows for smooth, unhindered communication between clients.</p><ol><li><p>We’ll use the <a href="https://man7.org/linux/man-pages/man7/epoll.7.html" target="_blank" rel="noopener noreferrer"><code>epoll</code></a> interface to manage multiple file descriptors.
Begin by opening <code>w_epoll.h</code> and completing the TODOs.
We will define wrapper functions to <strong>add</strong> and <strong>remove</strong> file descriptors from the <code>epoll</code> instance, making the main code more readable.
<strong>Note:</strong> Ensure that each wrapper returns the result of the <code>epoll_ctl()</code> for error handling.</p></li><li><p>Complete the TODOs in <code>support/client.c</code> to enable multiplexing of the available file descriptors.
The file descriptors are <code>stdin</code> (for receiving user messages) and <code>sockfd</code> (for communication with the server).
Use <code>epoll_create()</code>, <code>epoll_wait()</code>, and the wrappers defined in <code>w_epoll.h</code> to handle these descriptors without blocking.
Remember to close the sockets before exiting.</p><p>To test, start <code>python server.py</code> in one terminal and run your client implementation in two separate terminals.
If successful, the clients should be able to communicate through the server.</p></li><li><p>Complete the TODOs in <code>support/server.c</code> to multiplex I/O with clients.
You will need to create an <code>epoll</code> instance and dynamically <strong>add</strong> and <strong>remove</strong> clients as they connect and disconnect.
Use <code>epoll_create()</code>, <code>epoll_wait()</code>, and the wrappers defined in <code>w_epoll.h</code> to achieve this functionality.
<strong>Remember</strong> to remove the client sockets from the <code>epoll</code> instance before closing them.</p><p>To test your implementation, run <code>./server</code> in one terminal and <code>./client</code> (or <code>python client.py</code>) in two separate terminals.
If everything works correctly, the clients should be able to communicate with each other via the server.</p></li></ol><p>If you&#x27;re having difficulties solving this exercise, go through the <code>epoll</code> API from <a href="/operating-systems/75/IO/lab11#i/o-multiplexing">I/O Multiplexing</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-async-server">Task: Async Server<a class="hash-link" href="#task-async-server" title="Direct link to heading">​</a></h2><p>Navigate to <code>chapters/io/optimizations/drills/tasks/async-server</code> and run <code>make</code> to generate the <code>support</code> files.
Enter <code>support</code> and run <code>make test-file.txt</code> to generate the test file.</p><p>This task builds on the previous example of a <a href="/operating-systems/75/IO/lab11#task-multiplexed-client-server">multiplexed client-server</a>.
The server accepts connections from clients and downloads a file of <code>1 GB</code> from each.
After uploading the file, the clients close the connection.</p><ol><li><p>Open <code>server.c</code> and complete the TODOs in the main function to setup IO multiplexing using <a href="https://man7.org/linux/man-pages/man7/epoll.7.html" target="_blank" rel="noopener noreferrer"><code>epoll</code></a>.
Use <code>epoll_create()</code>, <code>epoll_wait()</code>, and the wrappers defined in <code>w_epoll.h</code> to handle descriptors without blocking.
<strong>Remember</strong> to remove the client sockets from the <code>epoll</code> instance before closing them.</p><p>To test, run <code>./server</code> in one terminal and <code>./client</code> in another terminal.s
If successful, the clients should print the upload progress.</p></li><li><p>There is a problem with our current implementation.
Try to start two clients at the same time - the first one will start uploading, and the second one will block at <code>connect()</code>.
This happens because, even though we are multiplexing file descriptors on the server-side, it is busy with another client.
To account for this, complete the TODOs in <code>handle_client()</code> to serve each client on a different process.</p><p>To test, start <code>python server.py</code> in one terminal and run your client implementation in two separate terminals.
If successful, the clients should be able to upload at the same time.</p></li></ol><p>If you&#x27;re having difficulties solving this exercise, go through <a href="/operating-systems/75/IO/lab11#asynchronous-i/o">Async I/O</a> and <a href="/operating-systems/75/IO/lab11#i/o-multiplexing">I/O Multiplexing</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="io-multiplexing">I/O Multiplexing<a class="hash-link" href="#io-multiplexing" title="Direct link to heading">​</a></h2><p>I/O multiplexing is the ability to serve multiple I/O channels (or anything that can be referenced via a file descriptor / handle) simultaneously.
If a given application, such a server, has multiple sockets on which it serves connection, it may be the case that operating on one socket blocks the server.
One solution is using asynchronous operations, with different backends.
The other solution is using I/O multiplexing.</p><p>The classical functions for I/O multiplexing are <a href="https://man7.org/linux/man-pages/man2/select.2.html" target="_blank" rel="noopener noreferrer"><code>select</code></a> and <a href="https://man7.org/linux/man-pages/man2/poll.2.html" target="_blank" rel="noopener noreferrer"><code>poll</code></a>.
Due to several limitations, modern operating systems provide advanced (non-portable) variants to these:</p><ul><li>Windows provides <a href="https://learn.microsoft.com/en-us/windows/win32/fileio/i-o-completion-ports" target="_blank" rel="noopener noreferrer">I/O completion ports (<code>IOCP</code>)</a>.</li><li>BSD provides <a href="https://www.freebsd.org/cgi/man.cgi?kqueue" target="_blank" rel="noopener noreferrer"><code>kqueue</code></a>.</li><li>Linux provides <a href="https://man7.org/linux/man-pages/man7/epoll.7.html" target="_blank" rel="noopener noreferrer"><code>epoll()</code></a>.</li></ul><blockquote><p><strong>Note</strong> that I/O multiplexing is orthogonal to <a href="/operating-systems/75/IO/lab11#asynchronous-i/o">asynchronous I/O</a>.
You could tie them together if the completion of the asynchronous operation sends a notification that can be handled via a file descriptor / handle.
This is the case with Windows asynchronous I/O (called <a href="https://learn.microsoft.com/en-us/windows/win32/fileio/synchronous-and-asynchronous-i-o" target="_blank" rel="noopener noreferrer">overlapped I/O</a>).</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-epoll-api">The <code>epoll</code> API<a class="hash-link" href="#the-epoll-api" title="Direct link to heading">​</a></h3><p>The <code>epoll</code> API allows user-space programs to efficiently monitor multiple file descriptors and be notified when one of them has data to read.
It provides a powerful, event-driven interface concentrated in three primary functions:</p><ul><li><code>int epoll_create1(int flags)</code>: Creates an <code>epoll</code> instance.
The <code>flags</code> argument specifies additional options for the instance.
The default value is <code>0</code>.</li><li><code>int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout)</code>: Waits for events on the monitored file descriptors.<ul><li><code>epfd</code>: The file descriptor returned by <code>epoll_create1()</code>.</li><li><code>events</code>: An array of <code>struct epoll_event</code> that will store the events that have occurred.
It only contains events that are ready (i.e., received data).</li><li><code>maxevents</code>: The maximum number of events that can be stored in the <code>events</code> array.</li><li><code>timeout</code>: The maximum time (in milliseconds) that <code>epoll_wait()</code> will block.
A value of <code>-1</code> means it will block indefinitely.</li></ul></li><li><code>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)</code>: Modifies the set of file descriptors monitored by <code>epoll</code>.<ul><li><code>epfd</code>: The file descriptor returned by <code>epoll_create1()</code>.</li><li>The <code>op</code> argument specifies the operation to perform, which can be:<ul><li><code>EPOLL_CTL_ADD</code>: Adds a file descriptor to the monitoring list.</li><li><code>EPOLL_CTL_MOD</code>: Modifies an existing file descriptor’s event list.</li><li><code>EPOLL_CTL_DEL</code>: Removes a file descriptor from the monitoring list.</li></ul></li><li>The <code>fd</code> argument is the file descriptor to be added, modified, or removed.</li><li>The <code>event</code> argument is a pointer to a <code>struct epoll_event</code> that defines the events associated with the file descriptor.</li></ul></li></ul><p>The <a href="https://man7.org/linux/man-pages/man3/epoll_event.3type.html" target="_blank" rel="noopener noreferrer"><code>struct epoll_event</code></a> is the core structure used to interact with <code>epoll</code>.
It is used to return events to user space after <code>epoll_wait()</code> is called and to pass parameters to <code>epoll_ctl()</code> when modifying the set of monitored file descriptors.
While the internal workings of <code>epoll</code> are complex, understanding how to use these functions and structures will cover most use cases.</p><p>Here is an example demonstrating how to use the <code>epoll</code> interface:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">efd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">epoll_create1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">efd </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// handle error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Add fd to monitored set</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">epoll_event</span><span class="token plain"> ev</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">events </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> EPOLLIN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// monitor fd for reading</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ev</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fd</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">epoll_ctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">efd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> EPOLL_CTL_ADD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rc </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// handle error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">epoll_event</span><span class="token plain"> events</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">n </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">epoll_wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">efd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> events</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Wait indefinitely</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// handle error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Iterate through the events to get active file descriptors</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%d received data\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> events</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Test your <code>epoll</code> understanding by implementing <a href="/operating-systems/75/IO/lab11#task-multiplexed-client-server">I/O multiplexing in a client-server app</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="asynchronous-io">Asynchronous I/O<a class="hash-link" href="#asynchronous-io" title="Direct link to heading">​</a></h2><p>Asynchronous I/O (async I/O) provides an efficient way to handle input/output operations that are typically slower than CPU operations by allowing programs to continue executing while waiting for I/O operations to complete.
Here’s a breakdown of I/O operation types and how asynchronous I/O compares to synchronous operations:</p><ol><li><p><strong>Synchronous Blocking Operation</strong>:</p><ul><li>This is the simplest and most common form of I/O (e.g., <code>read()</code> and <code>write()</code>).</li><li>It’s <strong>synchronous</strong>, meaning the program waits for a response to proceed.</li><li>It’s <strong>blocking</strong>, so if the requested data isn’t available (e.g., no data in the buffer for <code>read()</code>), the program waits for the operation to finish.</li></ul></li><li><p><strong>Synchronous Non-blocking Operation</strong>:</p><ul><li>This gives more control, especially in situations where waiting isn’t ideal.</li><li>Opening a file using <code>open()</code> alongside <code>O_NONBLOCK</code> flag ensures the operation returns immediately instead of blocking.</li><li>If data isn’t available right away, the operation notifies the program, which can try again later, avoiding unnecessary waiting.</li></ul></li><li><p><strong>Asynchronous Operation</strong>:</p><ul><li>Here, the function call returns immediately, allowing the program to continue <strong>without waiting for the result</strong>.</li><li>A notification or callback is sent when the operation completes, or the program can check its status periodically.</li></ul></li></ol><p>Keep in mind the async I/O is not the same thing as I/O multiplexing.
While both techniques improve I/O efficiency, they’re conceptually different:</p><ul><li><strong>Asynchronous I/O</strong> schedules operations concurrently, allowing the program to proceed without blocking.</li><li><a href="/operating-systems/75/IO/lab11#i/o-multiplexing"><strong>I/O Multiplexing</strong></a> (e.g., <code>select()</code>, <code>poll()</code>, <code>epoll()</code>) monitors multiple channels simultaneously and informs the program when a channel has data ready.
Blocking could still occur if the program cannot proceed without data from a channel.</li></ul><p>Think of them as <strong>complementary</strong>: multiplexing helps monitor multiple channels, while async I/O allows the program to do other things while waiting.</p><p>There are several ways asynchronous I/O can be implemented in practice:</p><ol><li><p><strong>Multiprocess Backend</strong>: Each request runs in a <strong>separate process</strong>, isolating tasks and preventing blocking between them.</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Handle requests with processes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handle_client_proc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> client_sockfd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token class-name">pid_t</span><span class="token plain"> pid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// handle error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Child process: handle client connection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">server_sockfd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Close the server socket in the child</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// compute and send answer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">client_sockfd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Close client socket when done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// Exit child process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">client_sockfd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// close client socket in parent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>Multithreaded Backend</strong>: Each request runs in a <strong>separate thread</strong>, allowing concurrent operations within the same process.</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Handle requests with threads</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> client_sockfd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">arg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">                   </span><span class="token comment" style="color:#999988;font-style:italic">// compute and send answer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">client_sockfd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// Close client socket when done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handle_client_thread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sockfd_p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// use the heap to pass the address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sockfd_p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sockfd</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> rc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pthread_create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">thread_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> handler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client_sock_ptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rc </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">// handle error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token function" style="color:#d73a49">pthread_detach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">thread_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Let the thread clean up after itself</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><strong>Event-based Backend</strong>: An action is scheduled with a <strong>callback</strong>, which is invoked upon completion, using event loops to manage tasks.
A callback is simply a function pointer, allowing the system to execute the function later or when a specific event is triggered.</p></li></ol><p>Test your understanding by solving the <a href="/operating-systems/75/IO/lab11#task-async-server">Async Server task</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zero-copy">Zero-Copy<a class="hash-link" href="#zero-copy" title="Direct link to heading">​</a></h2><p>Imagine a server that responds with files that it stores locally.
Its actions would be those highlighted in the image below:</p><ol><li>Receive a new request and extract the filename</li><li>Read the filename from the disk into memory</li><li>Send the file from memory to the client</li></ol><p><img loading="lazy" alt="Client-Server Steps" src="/operating-systems/75/assets/images/client-server-file-c21c08a102e6557188be7f080092a12c.svg" class="img_ev3q"></p><p><a href="/operating-systems/75/IO/Questions/server-copies">Quiz: How many copies does the OS make?</a></p><p>As you might have guessed, 2 of these copies are useless.
Since the app doesn&#x27;t modify the file, there&#x27;s no need for it to store the file in its own buffer.
It would be more efficient to use <strong>a single</strong> kernel buffer as intermediate storage between the disk and the NIC (Network Interface Card), as shown in the image below.</p><p><img loading="lazy" alt="Server Copies - Zero-Copy" src="/operating-systems/75/assets/images/server-copies-zero-copy-fc1fa1195f2444d92486d7d63dfc81a3.svg" class="img_ev3q"></p><p>For an easier comparison with the &quot;classic&quot; <code>read()</code> + <code>send()</code> model, here&#x27;s the first version again:</p><p><img loading="lazy" alt="Server Copies - Read-Send" src="/operating-systems/75/assets/images/server-copies-normal-7e82d53d42a478d0313cb85917335f94.svg" class="img_ev3q"></p><p>It should be obvious that the former approach is more efficient than the latter.</p><p><a href="/operating-systems/75/IO/Questions/fewer-than-2-copies">Quiz: Almost zero copies</a></p><p>These diagrams capture the essence of <strong>zero-copy</strong>: transferring data directly between kernel buffers, avoiding intermediate user-space buffers.
This approach is ideal for serving requests, whether forwarding data between clients or reading from disk.
It relies on the OS to retrieve and send data efficiently without extra copying steps.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sendfile"><code>sendfile()</code><a class="hash-link" href="#sendfile" title="Direct link to heading">​</a></h3><p>The syscall with which we can leverage <strong>zero-copy</strong> is called <a href="https://man7.org/linux/man-pages/man2/sendfile.2.html" target="_blank" rel="noopener noreferrer"><code>sendfile()</code></a>.
Here are some practical examples on how to use it:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// file to file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> in_fd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;input_file.txt&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> O_RDONLY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// src</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> out_fd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;output_socket&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> O_WRONLY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// dst</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">ssize_t</span><span class="token plain"> bytes_sent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sendfile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">out_fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in_fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">offset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4096</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Transfer 4096 bytes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bytes_sent </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// handle error</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// file to network</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> in_fd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;input_file.txt&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> O_RDONLY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// src</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> sockfd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">socket</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SOCK_STREAM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// dst</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> rc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sock_fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">server_addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">server_addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rc </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// handle error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">ssize_t</span><span class="token plain"> bytes_sent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sendfile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">out_fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in_fd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">offset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4096</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Transfer 4096 bytes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bytes_sent </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// handle error</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can read a slightly more detailed article about zero-copy <a href="https://developer.ibm.com/articles/j-zerocopy/" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-benchmarking-sendfile">Guide: Benchmarking <code>sendfile()</code><a class="hash-link" href="#guide-benchmarking-sendfile" title="Direct link to heading">​</a></h2><p>Navigate to <code>chapters/io/optimizations/guides/benchmarking-sendfile/support</code> and run <code>make</code> to prepare the test file.</p><p><code>sendfile()</code> transfers data between two file descriptors directly within the kernel, bypassing user-space buffers.
This process is known as <a href="/operating-systems/75/IO/lab11#zero-copy">zero-copy</a>.
Having established that <code>sendfile()</code> is likely faster than traditional I/O operations, it&#x27;s time to put this theory to the test!</p><p>The code in <code>server.py</code> creates two threads that behave nearly identically.
One listens on port <code>8081</code> and handles connections using <code>read()</code> and <code>send()</code>, while the other listens on port <code>8082</code> and uses <code>sendfile()</code>.
Start the server in one terminal with <code>python server.py</code>.
In a second terminal, run <code>benchmark_client.py read-send</code> followed by <code>benchmark_client.py sendfile</code> to compare the performance.</p><p>The results below are generic, and your outcomes may vary significantly depending on factors such as disk performance, network interface card (NIC), kernel version, Python version, and system load.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:/.../benchmarking-sendfile/support$ python3 benchmark_client.py read-send</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time taken: 7.175773588009179 seconds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:/.../benchmarking-sendfile/support$ python3 benchmark_client.py sendfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time taken: 3.71454380400246 seconds</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Using <code>sendfile()</code> <strong>halves the number of copies</strong> required, reducing it from 4 to 2.
This should translate to a roughly halved running time as well, making <code>sendfile()</code> a clear performance improvement over traditional methods.</p><p>You can explore another example of <strong>zero-copy</strong> in practice in this <a href="/operating-systems/75/IO/Questions/mmap-read-write-benchmark">Quiz: Why is <code>cp</code> faster than <code>mmap()</code>-based <code>cp</code></a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-kernel-caching">Guide: Kernel Caching<a class="hash-link" href="#guide-kernel-caching" title="Direct link to heading">​</a></h2><p>I/O is critical to system efficiency, but also often its weakest link.
Techniques to improve I/O performance include <a href="/operating-systems/75/IO/guides/libc-FILE-struct/">buffering</a>, <a href="/operating-systems/75/IO/lab11#zero-copy">zero-copy</a>, and <a href="/operating-systems/75/IO/lab11#asynchronous-i/o">async I/O</a>.
Among these, buffering is the most common and powerful.</p><p>Remember <code>buffering/support/benchmark_buffering.sh</code> or <code>file-mappings/support/benchmark_cp.sh</code>.
They both used this line:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sh</span><span class="token plain"> -c </span><span class="token string" style="color:#e3116c">&quot;sync; echo 3 &gt; /proc/sys/vm/drop_caches&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The line invalidates caches, forcing the OS to perform I/O operations directly from the disk.
This ensures that the scripts benchmark the C code&#x27;s performance alone, without any speedup from cached data.</p><p>The kernel goes even further with <strong>buffering</strong>.
This time, it’s at a level beyond syscalls like <code>read()</code> and <code>write()</code>, using a strategy known as <strong>caching</strong>.
While buffering helps with handling the <strong>next data</strong> efficiently by reading in advance or delaying writes, caching is about speeding up repeated access to the <strong>same data</strong>.
Just as your browser caches frequently visited pages or your CPU caches recent addresses, the OS caches files that are accessed often, such as logs or configuration files.</p><p>When the OS encounters a file access, it stores portions of that file in memory so that subsequent requests can read or modify data from RAM rather than waiting on the slower disk.
This makes I/O faster.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="caching-in-action">Caching in action<a class="hash-link" href="#caching-in-action" title="Direct link to heading">​</a></h3><p>Navigate to <code>chapters/io/optimizations/guides/kernel-caching/support</code> and run <code>make</code> to create a large file that we&#x27;ll use for benchmarking.
We have two scripts to benchmark the <code>cp</code> command with and without caching:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:/.../kernel-caching/support$ ./benchmark_cp.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make: &#x27;large-file.txt&#x27; is up to date.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Benchmarking cp on a 1 GB file...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">real    0m1.473s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user    0m0.001s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys     0m0.985s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:/.../kernel-caching/support$ ./benchmark_cp_allow_caching.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">make: &#x27;large-file.txt&#x27; is up to date.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Benchmarking cp on a 1 GB file...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">real    0m0.813s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user    0m0.000s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys     0m0.837s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Each subsequent benchmark actually reads the data from the caches populated or refreshed by the previous one.
So running the script multiple times might improve the results.</p><p>You can use <code>free -h</code> to view how much data your kernel is caching.
Look at the <code>buff/cache</code> column.
One possible output is shown below.
It says the OS is caching 7 GB of data.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ free -h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              total        used        free      shared  buff/cache   available</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Mem:           15Gi       8,1Gi       503Mi       691Mi       7,0Gi       6,5Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Swap:         7,6Gi       234Mi       7,4Gi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-async">Guide: Async<a class="hash-link" href="#guide-async" title="Direct link to heading">​</a></h2><p>Enter the <code>chapters/io/optimizations/guide/async/</code> folder for some implementations of a simple request-reply server in C.
Here we have the implementation of a server that computes the n-th fibonacci number.
The server serves requests in different ways:</p><ul><li><strong>synchronous</strong> server: <code>server.c</code></li><li><strong>multiprocess</strong> server: <code>mp_server.c</code></li><li><strong>multithreaded</strong> server: <code>mt_server.c</code></li></ul><p><strong>Note:</strong> There is no asynchronous C variant, because of the unstable API of <a href="https://pagure.io/libaio" target="_blank" rel="noopener noreferrer"><code>libaio</code></a> and <a href="https://unixism.net/loti/what_is_io_uring.html" target="_blank" rel="noopener noreferrer"><code>io_uring</code></a>.</p><ol><li><p>Benchmark the synchronous server to have a reference point.
Run <code>./server 2999</code> in one terminal and <code>time ./client_bench.sh 2999</code> in another.
<code>client_bench.sh</code> we&#x27;ll run <code>8</code> instances of <code>client.py</code> that make a request.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/async/support$ time ./client_bench.sh 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root: Connected to localhost:2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root: Sending 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function(30): 1346269</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">real    0m1.075s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user    0m0.301s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys     0m0.029s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The value you obtain might be different, but you should observe a speed-up when benchmarking the other two solutions.</p></li><li><p>Benchmark the multiprocess and multithreaded alternatives and see which one got the best speed increase.
You can obtain more relevant values by tweaking parameters in <code>client_bench.sh</code>.
For example, you could increase the <strong>number of clients</strong> or the <strong>fibonacci value to compute</strong>.</p></li><li><p>Begin by benchmarking the synchronous server to establish a baseline.
Run <code>./server 2999</code> in one terminal and <code>time ./client_bench.sh 2999</code> in another.
The <code>client_bench.sh</code> script will initiate <code>8</code> instances of <code>client.py</code>, each making a request.
The output might look like this:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/async/support$ time ./client_bench.sh 2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root: Connected to localhost:2000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root: Sending 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function(30): 1346269</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">real    0m1.075s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user    0m0.301s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys     0m0.029s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Although the actual value may vary, you should observe a noticeable speed-up when testing the other two solutions.</p></li><li><p>Next, benchmark the multiprocess and multithreaded alternatives to determine which offers the best performance improvement.
To obtain more meaningful results, adjust parameters in <code>client_bench.sh</code>, such as increasing the <strong>number of clients</strong> or the <strong>Fibonacci value to compute</strong>.</p></li></ol><p>If you&#x27;re having difficulties understanding the support code, go through <a href="/operating-systems/75/IO/lab11#asynchronous-i/o">this reading material</a>.
If you want to practice this yourself, go through the <a href="/operating-systems/75/IO/lab11#task-async-server">Async Server task</a>.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/operating-systems/75/IO/lab10"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Lab 10 - Inter-Process Communication</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/operating-systems/75/Lecture/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Lecture</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#task-ordered-client-server-communication" class="table-of-contents__link toc-highlight">Task: Ordered Client-Server Communication</a></li><li><a href="#task-multiplexed-client-server" class="table-of-contents__link toc-highlight">Task: Multiplexed Client Server</a></li><li><a href="#task-async-server" class="table-of-contents__link toc-highlight">Task: Async Server</a></li><li><a href="#io-multiplexing" class="table-of-contents__link toc-highlight">I/O Multiplexing</a><ul><li><a href="#the-epoll-api" class="table-of-contents__link toc-highlight">The <code>epoll</code> API</a></li></ul></li><li><a href="#asynchronous-io" class="table-of-contents__link toc-highlight">Asynchronous I/O</a></li><li><a href="#zero-copy" class="table-of-contents__link toc-highlight">Zero-Copy</a><ul><li><a href="#sendfile" class="table-of-contents__link toc-highlight"><code>sendfile()</code></a></li></ul></li><li><a href="#guide-benchmarking-sendfile" class="table-of-contents__link toc-highlight">Guide: Benchmarking <code>sendfile()</code></a></li><li><a href="#guide-kernel-caching" class="table-of-contents__link toc-highlight">Guide: Kernel Caching</a><ul><li><a href="#caching-in-action" class="table-of-contents__link toc-highlight">Caching in action</a></li></ul></li><li><a href="#guide-async" class="table-of-contents__link toc-highlight">Guide: Async</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://curs.upb.ro" target="_blank" rel="noopener noreferrer" class="footer__link-item">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ocw.cs.pub.ro/courses/so" target="_blank" rel="noopener noreferrer" class="footer__link-item">OCW<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/sisteme.de.operare/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 SO Team</div></div></div></footer></div>
<script src="/operating-systems/75/assets/js/runtime~main.0fc4e57f.js"></script>
<script src="/operating-systems/75/assets/js/main.7cb9414d.js"></script>
</body>
</html>