"use strict";(self.webpackChunkso=self.webpackChunkso||[]).push([[5757],{1160:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>s,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>p});var t=a(8168),r=(a(6540),a(5680));const i={},l="ELF Loader Assignment",o={unversionedId:"Assignments/ELF Loader/README",id:"Assignments/ELF Loader/README",title:"ELF Loader Assignment",description:"Objecives",source:"@site/docs/Assignments/ELF Loader/README.md",sourceDirName:"Assignments/ELF Loader",slug:"/Assignments/ELF Loader/",permalink:"/operating-systems/162/Assignments/ELF Loader/",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"sidebar",previous:{title:"Memory Allocator",permalink:"/operating-systems/162/Assignments/Memory Allocator/"},next:{title:"Parallel Firewall",permalink:"/operating-systems/162/Assignments/Parallel Firewall/"}},s={},p=[{value:"Objecives",id:"objecives",level:2},{value:"Statement",id:"statement",level:2},{value:"Support Code",id:"support-code",level:2},{value:"Implementation",id:"implementation",level:2},{value:"1. Minimal loader for syscall-only binaries (<strong>10 points</strong>)",id:"1-minimal-loader-for-syscall-only-binaries-10-points",level:3},{value:"2. Load memory regions with correct permissions (<strong>20 points</strong>)",id:"2-load-memory-regions-with-correct-permissions-20-points",level:3},{value:"3. Support static non-PIE binaries with libc (<strong>30 points</strong>)",id:"3-support-static-non-pie-binaries-with-libc-30-points",level:3},{value:"argc, argv (5 points out of 30)",id:"argc-argv-5-points-out-of-30",level:4},{value:"envp (5 points out of 30)",id:"envp-5-points-out-of-30",level:4},{value:"auxv (10 points out of 30)",id:"auxv-10-points-out-of-30",level:4},{value:"4. Support static PIE executables (<strong>30 points</strong>)",id:"4-support-static-pie-executables-30-points",level:3},{value:"Debugging",id:"debugging",level:2},{value:"General Tips",id:"general-tips",level:3},{value:"Useful Tools",id:"useful-tools",level:4},{value:"Debugging Example",id:"debugging-example",level:4},{value:"Compilation Tips",id:"compilation-tips",level:2}],f={toc:p},g="wrapper";function d({components:e,...n}){return(0,r.yg)(g,(0,t.A)({},f,n,{components:e,mdxType:"MDXLayout"}),(0,r.yg)("h1",{id:"elf-loader-assignment"},"ELF Loader Assignment"),(0,r.yg)("h2",{id:"objecives"},"Objecives"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Practice working with virtual memory, memory protection, and manual relocation."),(0,r.yg)("li",{parentName:"ul"},"Understand the difference between different types of executables, like PIE, non-PIE, staticly-linked, etc."),(0,r.yg)("li",{parentName:"ul"},"Understand the stack layout expected by an executable, environment variables, auxiliary vector, command-line arguments, etc.")),(0,r.yg)("h2",{id:"statement"},"Statement"),(0,r.yg)("p",null,"Implement a custom minimal ELF loader, capabale of loading and executing statically linked binaries in Linux."),(0,r.yg)("p",null,"Your loader must eventually support:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Minimal static binaries that make direct Linux syscalls (without libc)"),(0,r.yg)("li",{parentName:"ul"},"Statically linked ",(0,r.yg)("strong",{parentName:"li"},"non-PIE")," C programs using ",(0,r.yg)("inlineCode",{parentName:"li"},"libc")),(0,r.yg)("li",{parentName:"ul"},"Statically linked ",(0,r.yg)("strong",{parentName:"li"},"PIE")," executables")),(0,r.yg)("h2",{id:"support-code"},"Support Code"),(0,r.yg)("p",null,"The support code consists of three directories:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"src/")," where you will create your sollution"),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"test/")," contains the test suite and a Python script to verify your work")),(0,r.yg)("p",null,"The test suite consists of source code files (",(0,r.yg)("inlineCode",{parentName:"p"},".c")," and ",(0,r.yg)("inlineCode",{parentName:"p"},".asm"),"), that will be compiled and then executed using your loader.\nYou can use the ",(0,r.yg)("inlineCode",{parentName:"p"},"Makefile")," to compile all test files."),(0,r.yg)("h2",{id:"implementation"},"Implementation"),(0,r.yg)("p",null,"The assignment is split into ",(0,r.yg)("strong",{parentName:"p"},"4 graded parts"),", totaling ",(0,r.yg)("strong",{parentName:"p"},"90 points")," (10 points are given by the linter):"),(0,r.yg)("h3",{id:"1-minimal-loader-for-syscall-only-binaries-10-points"},"1. Minimal loader for syscall-only binaries (",(0,r.yg)("strong",{parentName:"h3"},"10 points"),")"),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Goal:")," Make the loader work with extremely minimal ELF binaries (usually written in assembly) that make direct syscalls and do not use libc."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"All memory segments can be loaded with ",(0,r.yg)("inlineCode",{parentName:"li"},"RWX")," permissions."),(0,r.yg)("li",{parentName:"ul"},"No need to set up ",(0,r.yg)("inlineCode",{parentName:"li"},"argv"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"envp"),", or auxiliary vectors."),(0,r.yg)("li",{parentName:"ul"},"These binaries call syscall instructions directly, so ",(0,r.yg)("inlineCode",{parentName:"li"},"libc")," is not used.")),(0,r.yg)("p",null,"For this task, you will need to:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Open the file and map it somewhere in the memory"),(0,r.yg)("li",{parentName:"ul"},"Validate the ELF file (parse the header, check that it is an ELF file)"),(0,r.yg)("li",{parentName:"ul"},"Pass through the section headers, and for the ",(0,r.yg)("inlineCode",{parentName:"li"},"PT_LOAD")," sections create new memory regions (they can have RWX permissions for now), then copy the section from the file into the newly created memory region."),(0,r.yg)("li",{parentName:"ul"},"Pass the execution to the new ELF, by jumping to the entry point.")),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Examples/Resources:")),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://refspecs.linuxbase.org/elf/gabi4+/ch5.pheader.html"},"ELF Specification"))),(0,r.yg)("h3",{id:"2-load-memory-regions-with-correct-permissions-20-points"},"2. Load memory regions with correct permissions (",(0,r.yg)("strong",{parentName:"h3"},"20 points"),")"),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Goal:")," Instead of RWX, check the memory protection flags (",(0,r.yg)("inlineCode",{parentName:"p"},"PF_R"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"PF_W"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"PF_X"),") from the ELF ",(0,r.yg)("inlineCode",{parentName:"p"},"Program Headers"),"."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Use ",(0,r.yg)("inlineCode",{parentName:"li"},"mprotect()")," or map with the correct permissions directly using ",(0,r.yg)("inlineCode",{parentName:"li"},"mmap()"),".")),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Key Concepts:")),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"PT_LOAD")," program headers contain ",(0,r.yg)("inlineCode",{parentName:"li"},"p_flags")," to specify memory permissions."),(0,r.yg)("li",{parentName:"ul"},"These must be respected to mimic the kernel loader."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://refspecs.linuxbase.org/elf/gabi4+/ch5.pheader.html"},"ELF Specification"))),(0,r.yg)("h3",{id:"3-support-static-non-pie-binaries-with-libc-30-points"},"3. Support static non-PIE binaries with libc (",(0,r.yg)("strong",{parentName:"h3"},"30 points"),")"),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Goal:")," Load and run statically linked ",(0,r.yg)("strong",{parentName:"p"},"non-PIE")," C binaries compiled with libc (e.g., via ",(0,r.yg)("inlineCode",{parentName:"p"},"gcc -static"),")."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},"Must set up a valid process ",(0,r.yg)("strong",{parentName:"p"},"stack"),", including:"),(0,r.yg)("ul",{parentName:"li"},(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"argc"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"argv"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"envp")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"auxv")," vector (with entries like ",(0,r.yg)("inlineCode",{parentName:"li"},"AT_PHDR"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"AT_PHENT"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"AT_PHNUM"),", etc.)")))),(0,r.yg)("p",null,"For this, you need to map a new memory region, that will become the new stack, then copy all the required information there."),(0,r.yg)("p",null,"The executable expects the stack layout as seen in the figure below:"),(0,r.yg)("p",null,(0,r.yg)("img",{alt:"Stack Layout",src:a(4062).A})),(0,r.yg)("p",null,"You can see more details about the stack ",(0,r.yg)("a",{parentName:"p",href:"https://lwn.net/Articles/631631/"},"here"),"."),(0,r.yg)("p",null,"You will have to reserve a memory region large enough for the stack (you can use the maximum allowed stack size, using ",(0,r.yg)("inlineCode",{parentName:"p"},"getrlimit"),", or you can use a harcoded value large enough to fit everything).\nAfter that, you need to copy the argc, argv and envp in the expected layout, then set up the auxv."),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Note:")," ",(0,r.yg)("inlineCode",{parentName:"p"},"argv")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"envp"),", since they consist of strings, will be placed as the ",(0,r.yg)("strong",{parentName:"p"},"pointer to the string")," on the stack, not the string itself.\n",(0,r.yg)("strong",{parentName:"p"},"Note:")," Make sure the mapped regions have the correct length, ",(0,r.yg)("strong",{parentName:"p"},"be careful of the difference between ",(0,r.yg)("inlineCode",{parentName:"strong"},"p_filesz")," and ",(0,r.yg)("inlineCode",{parentName:"strong"},"p_memsz")),"."),(0,r.yg)("h4",{id:"argc-argv-5-points-out-of-30"},"argc, argv (5 points out of 30)"),(0,r.yg)("p",null,"The command line arguments must be placed first at the top of the stack, as seen in the picture above.\nThe loader can be used as ",(0,r.yg)("inlineCode",{parentName:"p"},"./elf_loader ./no-pie-exec arg1 arg2 arg3"),".\n",(0,r.yg)("inlineCode",{parentName:"p"},"arg1"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"arg2")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"arg3")," must be placed on the stack for the loaded executable.\n",(0,r.yg)("inlineCode",{parentName:"p"},"argc")," will be also placed on the at the top of the stack."),(0,r.yg)("h4",{id:"envp-5-points-out-of-30"},"envp (5 points out of 30)"),(0,r.yg)("p",null,"The environment variables should be placed after the command line arguments.\nFor this, you just have to copy everything from the ",(0,r.yg)("inlineCode",{parentName:"p"},"char **envp")," array and place it on the stack."),(0,r.yg)("h4",{id:"auxv-10-points-out-of-30"},"auxv (10 points out of 30)"),(0,r.yg)("p",null,"The auxiliary vector, auxv, is a mechanism for communicating information from the kernel to user space.\nIt's basically a list of key-value pairs that contains different information about the state of the executable.\nYou can see the keys and required values of the auxv ",(0,r.yg)("a",{parentName:"p",href:"https://man7.org/linux/man-pages/man3/getauxval.3.html"},"in the man pages"),".\nFor example, for the key ",(0,r.yg)("inlineCode",{parentName:"p"},"AT_PAGESZ")," (defined as 6 in ",(0,r.yg)("a",{parentName:"p",href:"https://elixir.bootlin.com/glibc/glibc-2.42.9000/source/elf/elf.h#L1205"},"elf.h"),"), that needs to contain the value of the page size, the memory will look as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-text"},"0xfff......    --\x3e High Addresses\n-----------\n  4096         # Page Size\n   6           # AT_PAGESZ key\n-----------\n-----------\n0x000......    --\x3e Low Addresses\n")),(0,r.yg)("p",null,"The auvx must end with an ",(0,r.yg)("inlineCode",{parentName:"p"},"AT_NULL")," key with a 0 value, so an auxv that sets ",(0,r.yg)("inlineCode",{parentName:"p"},"AT_PAGESZ"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"AT_UID")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"AT_NULL")," will look like this on the stack:"),(0,r.yg)("p",null,(0,r.yg)("img",{alt:"Auxv Example",src:a(2088).A})),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Note:")," Beware of the ",(0,r.yg)("inlineCode",{parentName:"p"},"AT_RANDOM")," entry, the application will crash if you do not set it up properly."),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Docs:")),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://lwn.net/Articles/631631/"},"How programs get run: ELF binaries")," (See section: ",(0,r.yg)("inlineCode",{parentName:"li"},"Populating the stack"),")"),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://man7.org/linux/man-pages/man3/getauxval.3.html"},"auxv man page"))),(0,r.yg)("h3",{id:"4-support-static-pie-executables-30-points"},"4. Support static PIE executables (",(0,r.yg)("strong",{parentName:"h3"},"30 points"),")"),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Goal:")," Make your loader support static ",(0,r.yg)("strong",{parentName:"p"},"PIE (Position Independent Executable)")," binaries."),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"ELF type will be ",(0,r.yg)("inlineCode",{parentName:"li"},"ET_DYN"),", and segments must be mapped at a ",(0,r.yg)("strong",{parentName:"li"},"random base address"),"."),(0,r.yg)("li",{parentName:"ul"},"Entry point and memory segment virtual addresses must be adjusted by the ",(0,r.yg)("inlineCode",{parentName:"li"},"load_base"),".")),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Additional Requirements:")),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Must still build a valid stack (",(0,r.yg)("inlineCode",{parentName:"li"},"argc"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"argv"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"auxv"),", etc.)"),(0,r.yg)("li",{parentName:"ul"},"Handle relocation of entry point and program headers correctly.")),(0,r.yg)("p",null,"You will need to load all the segments at a random offset.\nBeware of the auxv entries, some of them will need to be adjusted to the offset."),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Docs:")),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://eli.thegreenplace.net/2011/08/25/load-time-relocation-of-shared-libraries"},"What is a PIE binary?")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://0xc0ffee.netlify.app/osdev/22-elf-loader-p2"},"Example ELF Loader")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"https://www.mgaillard.fr/2021/04/15/load-elf-user-mode.html"},"Another ELF Loader Example"))),(0,r.yg)("h2",{id:"debugging"},"Debugging"),(0,r.yg)("p",null,"Here are some useful tips and tools to debug your ELF loader:"),(0,r.yg)("h3",{id:"general-tips"},"General Tips"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Start simple"),": First test with a syscall-only ELF binary (e.g., ",(0,r.yg)("inlineCode",{parentName:"li"},"write")," + ",(0,r.yg)("inlineCode",{parentName:"li"},"exit"),")."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Use GDB"),": Run ",(0,r.yg)("inlineCode",{parentName:"li"},"gdb ./elf_loader")," and set breakpoints in the loader and inside the loaded ELF. You can use ",(0,r.yg)("inlineCode",{parentName:"li"},"add-symbol-file path-to-elf start-address")," to debug the libc entry and the elf execution with debugging symbols."),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Check memory layout"),": Print segment addresses and protections. You can use ",(0,r.yg)("inlineCode",{parentName:"li"},"pmap $(pidof elf-loader)")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Use PWNGDB"),": Use ",(0,r.yg)("a",{parentName:"li",href:"https://github.com/pwndbg/pwndbg"},(0,r.yg)("inlineCode",{parentName:"a"},"PwnGDB"))," or other similar plugins. They provide a lot of help during debugging.")),(0,r.yg)("h4",{id:"useful-tools"},"Useful Tools"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"readelf -l -h your_binary")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"objdump -d your_binary")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"gdb ./elf_loader")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"pmap $(pidof elf_loader)"))),(0,r.yg)("h4",{id:"debugging-example"},"Debugging Example"),(0,r.yg)("p",null,"Let's say the ",(0,r.yg)("inlineCode",{parentName:"p"},"no_pie")," test fails with a segmentation fault, with no other messages printed.\nIn order to debug that, we must run ",(0,r.yg)("inlineCode",{parentName:"p"},"gdb ./src/elf-loader")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"run ./tests/snippets/no_pie"),":"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-gdb"},'$rax   : 0xcc0\n$rbx   : 0x1\n$rcx   : 0x0000000000427aee  \u2192  0xc7a777fffff0003d ("="?)\n$rdx   : 0x0\n$rsp   : 0x00007ffff7df6bc0  \u2192  0x0000000000401835  \u2192  0x20ec8348e5894855\n$rbp   : 0x00007ffff7df6c00  \u2192  0x0000000000000000\n$rsi   : 0x20\n$rdi   : 0x0\n$rip   : 0x0000000000403e7b  \u2192  0x894864c030028b48\n$r8    : 0x0\n$r9    : 0x00000000004a8480  \u2192  "glibc.malloc.mxfast"\n$r10   : 0x53053053\n$r11   : 0x246\n$r12   : 0x00007ffff7df6c28  \u2192  0x00007ffff7df7fe8  \u2192  "./tests/snippets/no_pie"\n$r13   : 0x0\n$r14   : 0x00000000004aa000  \u2192  0x00000000004582f0  \u2192  0xffefc1c5fa1e0ff3\n$r15   : 0x00000000004004e8  \u2192  0x0000000000000000\n$eflags: [ZERO carry PARITY adjust sign trap INTERRUPT direction overflow RESUME virtualx86 identification]\n$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 stack \u2500\u2500\u2500\u2500\n0x00007ffff7df6bc0\u2502+0x0000: 0x0000000000401835  \u2192  0x20ec8348e5894855    \u2190 $rsp\n0x00007ffff7df6bc8\u2502+0x0008: 0x0000000000401710  \u2192  0x8949ed31fa1e0ff3\n0x00007ffff7df6bd0\u2502+0x0010: 0x0000000000000000\n0x00007ffff7df6bd8\u2502+0x0018: 0x0000000000000002\n0x00007ffff7df6be0\u2502+0x0020: 0x00007fffffffda98  \u2192  0x00007fffffffde42  \u2192  "/home/stefan/projects/facultate/asist/elf-loader/a[...]"\n0x00007ffff7df6be8\u2502+0x0028: 0x00007fffffffdab0  \u2192  0x00007fffffffdeb0  \u2192  "SHELL=/bin/bash"\n0x00007ffff7df6bf0\u2502+0x0030: 0x00007ffff7ff25e8  \u2192  0x00007ffff7f42b60  \u2192  <frame_dummy+0000> endbr64\n0x00007ffff7df6bf8\u2502+0x0038: 0x0000000000000001\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 code:x86:64 \u2500\u2500\u2500\u2500\n     0x403e6c                  mov    edi, r13d\n     0x403e6f                  call   0x428e80\n     0x403e74                  mov    rdx, QWORD PTR [rip+0xa5bcd]        # 0x4a9a48\n \u2192   0x403e7b                  mov    rax, QWORD PTR [rdx]\n     0x403e7e                  xor    al, al\n     0x403e80                  mov    QWORD PTR fs:0x28, rax\n     0x403e89                  cmp    QWORD PTR [rip+0xa60f7], 0x0        # 0x4a9f88\n     0x403e91                  je     0x403e9f\n     0x403e93                  call   0x0\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 threads \u2500\u2500\u2500\u2500\n[#0] Id 1, Name: "elf-loader", stopped 0x403e7b in ?? (), reason: SIGSEGV\n')),(0,r.yg)("p",null,"Note that during this tutorial we use ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/hugsy/gef"},(0,r.yg)("inlineCode",{parentName:"a"},"gef")),", that is almost identical to ",(0,r.yg)("inlineCode",{parentName:"p"},"pwngdb"),".\nWe advise you to use ",(0,r.yg)("inlineCode",{parentName:"p"},"pwngdb"),", there will be no difference in commands used."),(0,r.yg)("p",null,"We can see that the program crashes somewhere with no code or debugging symbols attached, so we can assume it is inside the loaded ELF.\nTo test this, let's break before we jump to the program entry point."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-gdb"},'$ break elf-loader.c:197 # This is the line for `__asm__ __volatile__`, it will be a different line for you\nBreakpoint 1 at 0x7ffff7f437c8: file elf-loader.c, line 197.\n$ run ./tests/snippets/no_pie\n\u25cf\u2192 0x7ffff7f437c8 <load_and_run+0c3c> mov    rax, QWORD PTR [rbp-0x1d0]\n   0x7ffff7f437cf <load_and_run+0c43> mov    rdx, QWORD PTR [rbp-0x190]\n   0x7ffff7f437d6 <load_and_run+0c4a> mov    rsp, rax\n   0x7ffff7f437d9 <load_and_run+0c4d> xor    rbp, rbp\n   0x7ffff7f437dc <load_and_run+0c50> jmp    rdx\n   0x7ffff7f437de <load_and_run+0c52> nop\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 source:elf-loader.c+197 \u2500\u2500\u2500\u2500\n    192         *(uint64_t *)sp = argc;\n    193\n    194         void (*entry)() = base + (void (*)())ehdr->e_entry;\n    195\n    196         // Transfer control\n\u25cf\u2192  197         __asm__ __volatile__(\n    198                         "mov %0, %%rsp\\n"\n    199                         "xor %%rbp, %%rbp\\n"\n    200                         "jmp *%1\\n"\n    201                         :\n    202                         : "r"(sp), "r"(entry)\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 threads \u2500\u2500\u2500\u2500\n[#0] Id 1, Name: "elf-loader", stopped 0x7ffff7f437c8 in load_and_run (), reason: BREAKPOINT\n')),(0,r.yg)("p",null,"Now we do some ",(0,r.yg)("inlineCode",{parentName:"p"},"ni")," to step with every instruction, until we reach some point where no c code is available anymore (after the ",(0,r.yg)("inlineCode",{parentName:"p"},"jmp rdx"),")."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-gdb"},'     0x401707                  pop    rbp\n     0x401708                  ret\n     0x401709                  nop    DWORD PTR [rax+0x0]\n \u2192   0x401710                  endbr64\n     0x401714                  xor    ebp, ebp\n     0x401716                  mov    r9, rdx\n     0x401719                  pop    rsi\n     0x40171a                  mov    rdx, rsp\n     0x40171d                  and    rsp, 0xfffffffffffffff0\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 threads \u2500\u2500\u2500\u2500\n[#0] Id 1, Name: "elf-loader", stopped 0x401710 in ?? (), reason: SINGLE STEP\n')),(0,r.yg)("p",null,"We check the mapping of the memory:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-gdb"},"$ vmmap\n[ Legend:  Code | Stack | Heap ]\nStart              End                Offset             Perm Path\n0x0000000000400000 0x0000000000401000 0x0000000000000000 r--\n0x0000000000401000 0x000000000047f000 0x0000000000000000 r-x\n0x000000000047f000 0x00000000004a5000 0x0000000000000000 r--\n0x00000000004a5000 0x00000000004b2000 0x0000000000000000 rwx\n0x00007ffff7600000 0x00007ffff7e00000 0x0000000000000000 rw-\n0x00007ffff7e72000 0x00007ffff7f33000 0x0000000000000000 r-- .../elf-loader/assignment-elf-loader/tests/snippets/no_pie\n0x00007ffff7f33000 0x00007ffff7f35000 0x0000000000000000 r-- [vvar]\n0x00007ffff7f35000 0x00007ffff7f37000 0x0000000000000000 r-- [vvar_vclock]\n0x00007ffff7f37000 0x00007ffff7f39000 0x0000000000000000 r-x [vdso]\n0x00007ffff7f39000 0x00007ffff7f42000 0x0000000000000000 r-- .../elf-loader/assignment-elf-loader/src/elf-loader\n0x00007ffff7f42000 0x00007ffff7fc9000 0x0000000000009000 r-x .../elf-loader/assignment-elf-loader/src/elf-loader\n0x00007ffff7fc9000 0x00007ffff7ff2000 0x0000000000090000 r-- .../elf-loader/assignment-elf-loader/src/elf-loader\n0x00007ffff7ff2000 0x00007ffff7ff7000 0x00000000000b9000 r-- .../elf-loader/assignment-elf-loader/src/elf-loader\n0x00007ffff7ff7000 0x00007ffff7ff9000 0x00000000000be000 rw- .../elf-loader/assignment-elf-loader/src/elf-loader\n0x00007ffff7ff9000 0x00007ffff7fff000 0x0000000000000000 rw-\n0x00007ffff7fff000 0x00007ffff8021000 0x0000000000000000 rw- [heap]\n0x00007ffffffdd000 0x00007ffffffff000 0x0000000000000000 rw- [stack]\n0xffffffffff600000 0xffffffffff601000 0x0000000000000000 --x [vsyscall]\n")),(0,r.yg)("p",null,"Our current instruction is at address ",(0,r.yg)("inlineCode",{parentName:"p"},"0x401710"),", which is inside a memory region allocated by ",(0,r.yg)("inlineCode",{parentName:"p"},"mmap")," for the ",(0,r.yg)("inlineCode",{parentName:"p"},"no_pie")," file, we can use ",(0,r.yg)("inlineCode",{parentName:"p"},"add-symbol-file"),".\n",(0,r.yg)("inlineCode",{parentName:"p"},"add-symbol-file")," expects the ",(0,r.yg)("strong",{parentName:"p"},"start address of the .text section"),", so let's get that."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"$ readelf -S tests/snippets/no_pie\n\n[...]\n  [ 7] .text             PROGBITS         **0000000000401100**  00001100\n       000000000007d880  0000000000000000  AX       0     0     64\n  [ 8] .fini             PROGBITS         000000000047e980  0007e980\n")),(0,r.yg)("p",null,"The ",(0,r.yg)("inlineCode",{parentName:"p"},".text")," address is the one placed inside ",(0,r.yg)("inlineCode",{parentName:"p"},"**"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"0x0000000000401100"),"."),(0,r.yg)("p",null,"So, bach to ",(0,r.yg)("inlineCode",{parentName:"p"},"gdb"),":"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-gdb"},'$ add-symbol-file tests/snippets/no_pie 0x0000000000401100\nadd symbol table from file "tests/snippets/no_pie" at\n        .text_addr = 0x401100\nReading symbols from tests/snippets/no_pie...\n$  context\n...\n \u2192   0x401710 <_start+0000>    endbr64 \n     0x401714 <_start+0004>    xor    ebp, ebp\n     0x401716 <_start+0006>    mov    r9, rdx\n     0x401719 <_start+0009>    pop    rsi\n...\n')),(0,r.yg)("p",null,"Now we can see where we are in the code of ",(0,r.yg)("inlineCode",{parentName:"p"},"no_pie"),", the ",(0,r.yg)("inlineCode",{parentName:"p"},"_start")," function.\nLet's see where it crashes:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-gdb"},"     0x403e74 <__libc_start_main_impl+0144> mov    rdx, QWORD PTR [rip+0xa5bcd]        # 0x4a9a48 <_dl_random+139145856>\n \u2192   0x403e7b <__libc_start_main_impl+014b> mov    rax, QWORD PTR [rdx]\n     0x403e7e <__libc_start_main_impl+014e> xor    al, al\n     0x403e80 <__libc_start_main_impl+0150> mov    QWORD PTR fs:0x28, rax\n")),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"Note:")," If the application crashes in the ",(0,r.yg)("inlineCode",{parentName:"p"},"__libc_start_main_impl")," function, it's most likely because of the stack (",(0,r.yg)("inlineCode",{parentName:"p"},"AUXV")," values), or the memory layout (make sure the mapped regions have the correct length, ",(0,r.yg)("strong",{parentName:"p"},"be careful of the difference between ",(0,r.yg)("inlineCode",{parentName:"strong"},"p_filesz")," and ",(0,r.yg)("inlineCode",{parentName:"strong"},"p_memsz")),")."),(0,r.yg)("p",null,"In our case, we can see the ",(0,r.yg)("inlineCode",{parentName:"p"},"rdx")," register, that is dereferenced, is 0.\nWe can also see on the instruction above, that ",(0,r.yg)("inlineCode",{parentName:"p"},"rdx")," is set to ",(0,r.yg)("inlineCode",{parentName:"p"},"_dl_random+139145856"),"."),(0,r.yg)("p",null,"The name of ",(0,r.yg)("inlineCode",{parentName:"p"},"_dl_random")," suggests something to do with ",(0,r.yg)("inlineCode",{parentName:"p"},"auxv[AT_RANDOM]"),".\nAlso, if we look into the libc source code (you are not required to do this, you should be able to solve all the issues using gdb, but sometimes looking at the source code helps), ",(0,r.yg)("inlineCode",{parentName:"p"},"_dl_random")," ",(0,r.yg)("a",{parentName:"p",href:"https://elixir.bootlin.com/glibc/glibc-2.42.9000/source/sysdeps/unix/sysv/linux/dl-parse_auxv.h#L55"},"is actually set to ",(0,r.yg)("inlineCode",{parentName:"a"},"auxv[AT_RANDOM]")),".\nWe did not set the ",(0,r.yg)("inlineCode",{parentName:"p"},"AT_RANDOM")," value in our loader, so it's ",(0,r.yg)("inlineCode",{parentName:"p"},"NULL"),", which is why it will crash with a ",(0,r.yg)("inlineCode",{parentName:"p"},"SEGV"),"."),(0,r.yg)("p",null,"We set the ",(0,r.yg)("inlineCode",{parentName:"p"},"AT_RANDOM")," value to a memory region pointing to random data, as the ",(0,r.yg)("a",{parentName:"p",href:"https://man7.org/linux/man-pages/man3/getauxval.3.html"},"man page")," says, the crash disappears, and the ",(0,r.yg)("inlineCode",{parentName:"p"},"no_pie")," elf is loaded properly."),(0,r.yg)("h2",{id:"compilation-tips"},"Compilation Tips"),(0,r.yg)("p",null,"To start the testing, run ",(0,r.yg)("inlineCode",{parentName:"p"},"make check")," in the ",(0,r.yg)("inlineCode",{parentName:"p"},"tests/")," directory.\nYou can modify the source files in ",(0,r.yg)("inlineCode",{parentName:"p"},"tests/snippets")," and try different things.\nTo run the loader manually, use ",(0,r.yg)("inlineCode",{parentName:"p"},"./elf-loader ../tests/snippets/<test-name> arg1 arg2 ..."),"."))}d.isMDXComponent=!0},2088:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/auxv-example.drawio-337988ad6e07792003f401b0caf2aea2.svg"},4062:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/stack-layout.drawio-b9debccd9c136c179bc5373426784894.svg"},5680:(e,n,a)=>{a.d(n,{xA:()=>f,yg:()=>u});var t=a(6540);function r(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function i(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),a.push.apply(a,t)}return a}function l(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?i(Object(a),!0).forEach(function(n){r(e,n,a[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))})}return e}function o(e,n){if(null==e)return{};var a,t,r=function(e,n){if(null==e)return{};var a,t,r={},i=Object.keys(e);for(t=0;t<i.length;t++)a=i[t],n.indexOf(a)>=0||(r[a]=e[a]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)a=i[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=t.createContext({}),p=function(e){var n=t.useContext(s),a=n;return e&&(a="function"==typeof e?e(n):l(l({},n),e)),a},f=function(e){var n=p(e.components);return t.createElement(s.Provider,{value:n},e.children)},g="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},m=t.forwardRef(function(e,n){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,f=o(e,["components","mdxType","originalType","parentName"]),g=p(a),m=r,u=g["".concat(s,".").concat(m)]||g[m]||d[m]||i;return a?t.createElement(u,l(l({ref:n},f),{},{components:a})):t.createElement(u,l({ref:n},f))});function u(e,n){var a=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=a.length,l=new Array(i);l[0]=m;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o[g]="string"==typeof e?e:r,l[1]=o;for(var p=2;p<i;p++)l[p]=a[p];return t.createElement.apply(null,l)}return t.createElement.apply(null,a)}m.displayName="MDXCreateElement"}}]);