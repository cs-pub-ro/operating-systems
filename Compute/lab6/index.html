<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Compute/lab6">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Lab 6 - Multiprocess and Multithread | Operating Systems</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://localhost//operating-systems/Compute/lab6"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Lab 6 - Multiprocess and Multithread | Operating Systems"><meta data-rh="true" name="description" content="Task: Creating a process"><meta data-rh="true" property="og:description" content="Task: Creating a process"><link data-rh="true" rel="canonical" href="http://localhost//operating-systems/Compute/lab6"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/Compute/lab6" hreflang="en"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/Compute/lab6" hreflang="x-default"><link rel="stylesheet" href="/operating-systems/assets/css/styles.a69a9d41.css">
<link rel="preload" href="/operating-systems/assets/js/runtime~main.cf1d83f1.js" as="script">
<link rel="preload" href="/operating-systems/assets/js/main.abededcd.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/operating-systems/"><div class="navbar__logo"><img src="/operating-systems/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/operating-systems/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">SO</b></a><a class="navbar__item navbar__link" href="/operating-systems/Software Stack">Software Stack</a><a class="navbar__item navbar__link" href="/operating-systems/Data">Data</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/operating-systems/Compute">Compute</a><a class="navbar__item navbar__link" href="/operating-systems/Lecture">Lecture</a><a class="navbar__item navbar__link" href="/operating-systems/Assignments">Assignments</a><a class="navbar__item navbar__link" href="/operating-systems/Exams">Exams</a><a class="navbar__item navbar__link" href="/operating-systems/Hackathons">Hackathons</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/lab-setup">Setting up the Lab Environment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Software Stack/">Software Stack</a><button aria-label="Toggle the collapsible sidebar category &#x27;Software Stack&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Data/">Data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/operating-systems/Compute/">Compute</a><button aria-label="Toggle the collapsible sidebar category &#x27;Compute&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Compute/">Slides</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Compute/compute-overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/Compute/Questions/">Questions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Questions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/operating-systems/Compute/lab6">Lab 6 - Multiprocess and Multithread</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Compute/lab7">Lab 7 - Copy-on-Write</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Compute/lab8">Lab 8 - Syncronization</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Lecture/">Lecture</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lecture&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Assignments/">Assignments</a><button aria-label="Toggle the collapsible sidebar category &#x27;Assignments&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Exams/">Exams</a><button aria-label="Toggle the collapsible sidebar category &#x27;Exams&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Hackathons/">Hackathons</a><button aria-label="Toggle the collapsible sidebar category &#x27;Hackathons&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/rules-and-grading">Rules and Grading</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/resources">Resources</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/operating-systems/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/operating-systems/Compute/"><span itemprop="name">Compute</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lab 6 - Multiprocess and Multithread</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Lab 6 - Multiprocess and Multithread</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-creating-a-process">Task: Creating a process<a class="hash-link" href="#task-creating-a-process" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="higher-level---python">Higher level - Python<a class="hash-link" href="#higher-level---python" title="Direct link to heading">​</a></h3><p>Enter the <code>chapters/compute/processes/drills/tasks/sleepy</code> directory, run <code>make skels</code>, open the <code>support/src</code> folder and go through the practice items below.</p><p>Use the <code>tests/checker.sh</code> script to check your solutions.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./checker.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sleepy_creator </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"> passed </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sleepy_creator_wait </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. passed </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sleepy_creator_c </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"> passed </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token number" style="color:#36acaa">40</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> / </span><span class="token number" style="color:#36acaa">100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Head over to <code>sleepy_creator.py</code>.</p><ol><li><p>Solve the <code>TODO</code>: use <code>subprocess.Popen()</code> to spawn 10 <code>sleep 1000</code> processes.</p><p>Start the script:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../tasks/sleepy/support$ python3 sleepy_creator.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Look for the parent process:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ ps -e -H -o pid,ppid,cmd | (head -1; grep &quot;python3 sleepy_creator.py&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It is a <code>python3</code> process, as this is the interpreter that runs the script, but we call it the <code>sleepy_creator.py</code> process for simplicity.
No output will be provided by the above command, as the parent process (<code>sleepy_creator.py</code>) dies before its child processes (the 10 <code>sleep 1000</code> subprocesses) finish their execution.
The parent process of the newly created child processes is an <code>init</code>-like process: either <code>systemd</code>/<code>init</code> or another system process that adopts orphan processes.
Look for the <code>sleep</code> child processes using:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ ps -e -H -o pid,ppid,cmd | (head -1; grep sleep)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> PID    PPID         CMD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4164    1680     sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4165    1680     sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4166    1680     sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4167    1680     sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4168    1680     sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4169    1680     sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4170    1680     sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4171    1680     sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4172    1680     sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4173    1680     sleep 1000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Notice that the child processes do not have <code>sleepy_creator.py</code> as a parent.
What&#x27;s more, as you saw above, <code>sleepy_creator.py</code> doesn&#x27;t even exist anymore.
The child processes have been adopted by an <code>init</code>-like process (in the output above, that process has PID <code>1680</code> - <code>PPID</code> stands for <em>parent process ID</em>).</p><p><a href="/operating-systems/Compute/Questions/parent-of-sleep-processes">Quiz</a></p></li><li><p>Solve the <code>TODO</code>: change the code in <code>sleepy_creator_wait.py</code> so that the <code>sleep 1000</code> processes remain the children of <code>sleepy_creator_wait.py</code>.
This means that the parent / creator process must <strong>not</strong> exit until its children have finished their execution.
In other words, the parent / creator process must <strong>wait</strong> for the termination of its children.
Check out <a href="https://docs.python.org/3/library/subprocess.html#subprocess.Popen.wait" target="_blank" rel="noopener noreferrer"><code>Popen.wait()</code></a> and add the code that makes the parent / creator process wait for its children.
Before anything, terminate the <code>sleep</code> processes created above:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ pkill sleep</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Start the program, again, as you did before:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../tasks/sleepy/support$ python3 sleepy_creator.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On another terminal, verify that <code>sleepy_creator_wait.py</code> remains the parent of the <code>sleep</code> processes it creates:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ ps -e -H -o pid,ppid,cmd | (head -1; grep sleep)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> PID    PPID                CMD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16107   9855         python3 sleepy_creator.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16108   16107           sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16109   16107           sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16110   16107           sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16111   16107           sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16112   16107           sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16113   16107           sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16114   16107           sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16115   16107           sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16116   16107           sleep 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">16117   16107           sleep 1000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that the parent process <code>sleepy_creator_wait.py</code> (<code>PID 16107</code>) is still alive, and its child processes (the 10 <code>sleep 1000</code>) have its ID as their <code>PPID</code>.
You&#x27;ve successfully waited for the child processes to finish their execution.</p><p>If you&#x27;re having difficulties solving this exercise, go through <a href="/operating-systems/Compute/lab6#guide-baby-steps---python">this</a> reading material.</p></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lower-level---c">Lower level - C<a class="hash-link" href="#lower-level---c" title="Direct link to heading">​</a></h3><p>Now let&#x27;s see how to create a child process in C.
There are multiple ways of doing this.
For now, we&#x27;ll start with a higher-level approach.</p><p>Go to <code>sleepy_creator.c</code> and use <a href="https://man7.org/linux/man-pages/man3/system.3.html" target="_blank" rel="noopener noreferrer"><code>system</code></a> to create a <code>sleep 1000</code> process.</p><p><a href="/operating-systems/Compute/Questions/create-sleepy-process-ending">Quiz</a></p><p>The <code>man</code> page also mentions that <code>system</code> calls <code>fork()</code> and <code>exec()</code> to run the command it&#x27;s given.
If you want to find out more about them, head over to the <a href="/operating-systems/Compute/lab7#task-mini-shell">Arena and create your own mini-shell</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-wait-for-me">Task: Wait for Me<a class="hash-link" href="#task-wait-for-me" title="Direct link to heading">​</a></h2><p>Enter the <code>chapters/compute/processes/drills/tasks/wait-for-me-processes/</code> directory, run <code>make skels</code>, open the <code>support/src</code> folder and go through the practice items below.</p><p>Use the <code>tests/checker.sh</code> script to check your solutions.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wait_for_me_processes </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"> passed </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> / </span><span class="token number" style="color:#36acaa">100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><p>Run the code in <code>wait_for_me_processes.py</code> (e.g: <code>python3 wait_for_me_processes.py</code>).
The parent process creates one child that writes and message to the given file.
Then the parent reads that message.
Simple enough, right?
But running the code raises a <code>FileNotFoundError</code>.
If you inspect the file you gave the script as an argument, it does contain a string.
What&#x27;s going on?</p><p><a href="/operating-systems/Compute/Questions/cause-of-file-not-found-error">Quiz</a></p><p>In order to solve race conditions, we need <strong>synchronization</strong>.
This is a mechanism similar to a set of traffic lights in a crossroads.
Just like traffic lights allow some cars to pass only after others have already passed, synchronization is a means for threads to communicate with each other and tell each other to access a resource or not.</p><p>The most basic form of synchronization is <strong>waiting</strong>.
Concretely, if the parent process <strong>waits</strong> for the child to end, we are sure the file is created and its contents are written.</p></li><li><p>Use <code>join()</code> to make the parent wait for its child before reading the file.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-create-process">Task: Create Process<a class="hash-link" href="#task-create-process" title="Direct link to heading">​</a></h2><p>Enter the <code>chapters/compute/processes/drills/tasks/create-process/</code> directory, run <code>make skels</code>, open the <code>support/src</code> folder and go through the practice items below.</p><p>Use the <code>tests/checker.sh</code> script to check your solutions.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./checker.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exit_code22 </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"> passed </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">second_fork </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain"> passed </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">. </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> / </span><span class="token number" style="color:#36acaa">100</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><p>Change the return value of the child process to 22 so that the value displayed by the parent is changed.</p></li><li><p>Create a child process of the newly created child.</p></li></ol><p>Use a similar logic and a similar set of prints to those in the support code.
Take a look at the printed PIDs.
Make sure the PPID of the &quot;grandchild&quot; is the PID of the child, whose PPID is, in turn, the PID of the parent.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-multithreaded">Task: Multithreaded<a class="hash-link" href="#task-multithreaded" title="Direct link to heading">​</a></h2><p>Enter the <code>chapters/compute/threads/drills/tasks/multithreaded/</code> folder, run <code>make skels</code>, and go through the practice items below in the <code>support/</code> directory.</p><ol><li><p>Use the Makefile to compile <code>multithread.c</code>, run it and follow the instructions.</p><p>The aim of this task is to familiarize you with the <code>pthreads</code> library.
In order to use it, you have to add <code>#include &lt;pthread.h&gt;</code> in <code>multithreaded.c</code> and <code>-lpthread</code> in the compiler options.</p><p>The executable creates 5 threads besides the main thread, puts each of them to sleep for <strong>5 seconds</strong>, then waits for all of them to finish.
Give it a run and notice that the total waiting time is around <strong>5 seconds</strong> since you started the last thread.
That is the whole point - they each run in parallel.</p></li><li><p>Make each thread print its ID once it is done sleeping.</p><p>Create a new function <code>sleep_wrapper2()</code> identical to <code>sleep_wrapper()</code> to organize your work.
So far, the <code>data</code> argument is unused (mind the <code>__unused</code> attribute), so that is your starting point.
You cannot change <code>sleep_wrapper2()</code> definition, since <code>pthreads_create()</code> expects a pointer to a function that receives a <code>void *</code> argument.
What you can and should do is to pass a pointer to a <code>int</code> as argument, and then cast <code>data</code> to <code>int *</code> inside <code>sleep_wrapper2()</code>.</p><p><strong>Note:</strong> Do not simply pass <code>&amp;i</code> as argument to the function.
This will make all threads to use the <strong>same integer</strong> as their ID.</p><p><strong>Note:</strong> Do not use global variables.</p><p>If you get stuck you can google <code>pthread example</code> and you will probably stumble upon <a href="https://gist.github.com/ankurs/179778" target="_blank" rel="noopener noreferrer">this</a>.</p></li><li><p>On top of printing its ID upon completion, make each thread sleep for a different amount of time.</p><p>Create a new function <code>sleep_wrapper3()</code> identical to <code>sleep_wrapper()</code> to organize your work.
The idea is to repeat what you did on the previous exercise and use the right argument for <code>sleep_wrapper3()</code>.
Keep in mind that you cannot change its definition.
Bonus points if you do not use the thread&#x27;s ID as the sleeping amount.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-libraries-for-parallel-processing">Task: Libraries for Parallel Processing<a class="hash-link" href="#task-libraries-for-parallel-processing" title="Direct link to heading">​</a></h2><p>In <code>chapters/compute/threads/drills/tasks/sum-array/support/c/sum_array_threads.c</code> we spawned threads &quot;manually&quot; by using the <code>pthread_create()</code> function.
This is <strong>not</strong> a syscall, but a wrapper over the common syscall used by both <code>fork()</code> (which is also not a syscall) and <code>pthread_create()</code>.</p><p>Still, <code>pthread_create()</code> is not yet a syscall.
In order to see what syscall <code>pthread_create()</code> uses, check out <a href="/operating-systems/Compute/lab6#guide-threads-and-processes-clone">this section</a>.</p><p>Most programming languages provide a more advanced API for handling parallel computation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="stdparallelism-in-d"><code>std.parallelism</code> in D<a class="hash-link" href="#stdparallelism-in-d" title="Direct link to heading">​</a></h3><p>D language&#x27;s standard library exposes the <a href="https://dlang.org/phobos/std_parallelism.html" target="_blank" rel="noopener noreferrer"><code>std.parallelism</code></a>, which provides a series of parallel processing functions.
One such function is <code>reduce()</code>, which splits an array between a given number of threads and applies a given operation to these chunks.
In our case, the operation simply adds the elements to an accumulator: <code>a + b</code>.
Follow and run the code in <code>sum-array/support/d/sum_array_threads_reduce.d</code>.</p><p>The number of threads is used within a <a href="https://dlang.org/phobos/std_parallelism.html#.TaskPool" target="_blank" rel="noopener noreferrer"><code>TaskPool</code></a>.
This structure is a thread manager (not scheduler).
It silently creates the number of threads we request and then <code>reduce()</code> spreads its workload between these threads.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="openmp-for-c">OpenMP for C<a class="hash-link" href="#openmp-for-c" title="Direct link to heading">​</a></h3><p>Unlike D, C does not support parallel computation by design.
It needs a library to do advanced things, like <code>reduce()</code> from D.
We have chosen to use the OpenMP library for this.
Follow the code in <code>support/sum-array/c/sum_array_threads_openmp.c</code>.</p><p>The <code>#pragma</code> used in the code instructs the compiler to enable the <code>omp</code> module, and to parallelise the code.
In this case, we instruct the compiler to perform a reduce of the array, using the <code>+</code> operator, and to store the results in the <code>result</code> variable.
This reduction uses threads to calculate the sum, similar to <code>sum_array_threads.c</code>, but in a much more optimised form.</p><p>Now compile and run the <code>sum_array_threads_openmp</code> binary using 1, 2, 4, and 8 threads as before.
You&#x27;ll see lower running times than <code>sum_array_threads</code> due to the highly-optimised code emitted by the compiler.
For this reason and because library functions are usually much better tested than your own code, it is always preferred to use a library function for a given task.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="array-sum-in-python">Array Sum in Python<a class="hash-link" href="#array-sum-in-python" title="Direct link to heading">​</a></h3><p>Let&#x27;s first probe this by implementing two parallel versions of the code in <code>sum-array/support/python/sum_array_sequential.py</code>.
One version should use threads and the other should use processes.
Run each of them using 1, 2, 4, and 8 threads / processes respectively and compare the running times.
Notice that the running times of the multithreaded implementation do not decrease.
This is because the GIL makes it so that those threads that you create essentially run sequentially.</p><p>The GIL also makes it so that individual Python instructions are atomic.
Run the code in <code>chapters/compute/synchronization/drills/tasks/race-condition/support/python/race_condition.py</code>.
Every time, <code>var</code> will be 0 because the GIL doesn&#x27;t allow the two threads to run in parallel and reach the critical section at the same time.
This means that the instructions <code>var += 1</code> and <code>var -= 1</code> become atomic.</p><p>If you&#x27;re having difficulties solving this exercise, go through <a href="/operating-systems/Compute/lab6#guide-sum-array-threads">this</a> reading material.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-wait-for-it">Task: Wait for It<a class="hash-link" href="#task-wait-for-it" title="Direct link to heading">​</a></h2><p>The process that spawns all the others and subsequently calls <code>waitpid</code> to wait for them to finish can also get their return codes.
Update the code in <code>chapters/compute/threads/drills/tasks/sum-array-bugs/support/seg-fault/sum_array_processes.c</code> and modify the call to <code>waitpid</code> to obtain and investigate this return code.
Display an appropriate message if one of the child processes returns an error.</p><p>Remember to use the appropriate <a href="https://linux.die.net/man/2/waitpid" target="_blank" rel="noopener noreferrer">macros</a> for handling the <code>status</code> variable that is modified by <code>waitpid()</code>, as it is a bit-field.
When a process runs into a system error, it receives a signal.
A signal is a means to interrupt the normal execution of a program from the outside.
It is associated with a number.
Use <code>kill -l</code> to find the full list of signals.</p><p><a href="/operating-systems/Compute/Questions/seg-fault-exit-code">Quiz</a></p><p>So up to this point we&#x27;ve seen that one advantage of processes is that they offer better safety than threads.
Because they use separate virtual address spaces, sibling processes are better isolated than threads.
Thus, an application that uses processes can be more robust to errors than if it were using threads.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="memory-corruption">Memory Corruption<a class="hash-link" href="#memory-corruption" title="Direct link to heading">​</a></h3><p>Because they share the same address space, threads run the risk of corrupting each other&#x27;s data.
Take a look at the code in <code>sum-array-bugs/support/memory-corruption/python/</code>.
The two programs only differ in how they spread their workload.
One uses threads while the other uses processes.</p><p>Run both programs with and without memory corruption.
Pass any value as a third argument to trigger the corruption.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../sum-array-bugs/support/memory-corruption/python$ python3 memory_corruption_processes.py &lt;number_of_processes&gt;  # no memory corruption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../sum-array-bugs/support/memory-corruption/python$ python3 memory_corruption_processes.py &lt;number_of_processes&gt; 1  # do memory corruption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The one using threads will most likely print a negative sum, while the other displays the correct sum.
This happens because all threads refer to the same memory for the array <code>arr</code>.
What happens to the processes is a bit more complicated.</p><p><a href="/operating-systems/Compute/lab7#copy-on-write">Later in this lab</a>, we will see that initially, the page tables of all processes point to the same physical frames or <code>arr</code>.
When the malicious process tries to corrupt this array by <strong>writing data to it</strong>, the OS duplicates the original frames of <code>arr</code> so that the malicious process writes the corrupted values to these new frames, while leaving the original ones untouched.
This mechanism is called <strong>Copy-on-Write</strong> and is an OS optimisation so that memory is shared between the parent and the child process, until one of them attempts to write to it.
At this point, this process receives its own separate copies of the previously shared frames.</p><p>Note that in order for the processes to share the <code>sums</code> dictionary, it is not created as a regular dictionary, but using the <code>Manager</code> module.
This module provides some special data structures that are allocated in <strong>shared memory</strong> so that all processes can access them.
You can learn more about shared memory and its various implementations <a href="/operating-systems/Compute/tasks/shared-memory/README.md">in this section</a>.</p><p>If you&#x27;re having difficulties solving this exercise, go through <a href="/operating-systems/Compute/guides/sum-array-processes/README.md">this</a> reading material.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hardware-perspective">Hardware Perspective<a class="hash-link" href="#hardware-perspective" title="Direct link to heading">​</a></h2><p>The main criterion we use to rank CPUs is their <em>computation power</em>, i.e. their ability to crunch numbers and do math.
Numerous benchmarks exist out there, and they are publicly displayed on sites such as <a href="https://www.cpubenchmark.net/" target="_blank" rel="noopener noreferrer">CPUBenchmark</a>.</p><p>For example, a benchmark can measure the performance of the computer&#x27;s CPU in a variety of scenarios:</p><ul><li>its ability to perform integer operations</li><li>its speed in floating point arithmetic</li><li>data encryption and compression</li><li>sorting algorithms and others</li></ul><p>You can take a look at what exactly is measured using <a href="https://www.cpubenchmark.net/cpu.php?cpu=AMD+Ryzen+Threadripper+PRO+5995WX" target="_blank" rel="noopener noreferrer">this link</a>.
It displays the scores obtained by a high-end CPU.
Apart from the tests above, other benchmarks might focus on different performance metrics, such as branch prediction or prefetching.</p><p>Other approaches are less artificial, measuring performance on real-world applications such as compile times and performance in the latest (and most resource-demanding) video games.
The latter metric revolves around how many average FPS (frames per second) a given CPU is able to crank out in a specific video game.
You can find a lot of articles online on how CPU benchmarking is done.</p><p>Most benchmarks, unfortunately, are not open source, especially the more popular ones, such as <a href="https://browser.geekbench.com/processor-benchmarks" target="_blank" rel="noopener noreferrer">Geekbench 5</a>.
Despite this shortcoming, benchmarks are widely used to compare the performance of various computer <strong>hardware</strong>, CPUs included.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-role-of-the-operating-system">The Role of the Operating System<a class="hash-link" href="#the-role-of-the-operating-system" title="Direct link to heading">​</a></h3><p>As you&#x27;ve seen so far, the CPU provides the &quot;muscle&quot; required for fast computation, i.e. the highly optimised hardware and multiple ALUs, FPUs
and cores necessary to perform those computations.
However, it is the <strong>operating system</strong> that provides the &quot;brains&quot; for this computation.
Specifically, modern CPUs have the capacity to run multiple tasks in parallel.
But they do not provide a means to decide which task to run at each moment.
The OS comes as an <em>orchestrator</em> to <strong>schedule</strong> the way these tasks (that we will later call threads) are allowed to run and use the CPU&#x27;s resources.
This way, the OS tells the CPU what code to run on each CPU core so that it reaches a good balance between high throughput (running many instructions) and fair access to CPU cores.</p><p>It is cumbersome for a user-level application to interact directly with the CPU.
The developer would have to write hardware-specific code, which is not scalable and is difficult to maintain.
In addition, doing so would leave it up to the developer to isolate their application from the others that are present on the system.
This leaves applications vulnerable to countless bugs and exploits.</p><p>To guard apps from these pitfalls, the OS comes and mediates interactions between regular programs and the CPU by providing a set of <strong>abstractions</strong>.
These abstractions offer a safe, uniform and also isolated way to leverage the CPU&#x27;s resources, i.e. its cores.
There are 2 main abstractions: <strong>processes</strong> and <strong>threads</strong>.</p><p><img loading="lazy" alt="Interaction between applications, OS and CPU" src="/operating-systems/assets/images/app-os-cpu-interaction-ca7fbdbb7da380e0992c95467ef267ce.svg" class="img_ev3q"></p><p>As we can see from the image above, an application can spawn one or more processes.
Each of these is handled and maintained by the OS.
Similarly, each process can spawn however many threads, which are also managed by the OS.
The OS decides when and on what CPU core to make each thread run.
This is in line with the general interaction between an application and the hardware: it is always mediated by the OS.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="processes">Processes<a class="hash-link" href="#processes" title="Direct link to heading">​</a></h2><p>A process is simply a running program.
Let&#x27;s take the <code>ls</code> command as a trivial example.
<code>ls</code> is a <strong>program</strong> on your system.
It has a binary file which you can find and inspect with the help of the <code>which</code> command:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ which ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/bin/ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ file /usr/bin/ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/bin/ls: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=6e3da6f0bc36b6398b8651bbc2e08831a21a90da, for GNU/Linux 3.2.0, stripped</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When you run it, the <code>ls</code> binary stored <strong>on the disk</strong> at <code>/usr/bin/ls</code> is read by another application called the <strong>loader</strong>.
The loader spawns a <strong>process</strong> by copying some of the contents <code>/usr/bin/ls</code> in memory (such as the <code>.text</code>, <code>.rodata</code> and <code>.data</code> sections).
Using <code>strace</code>, we can see the <a href="https://man7.org/linux/man-pages/man2/execve.2.html" target="_blank" rel="noopener noreferrer"><code>execve</code></a> system call:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ strace -s 100 ls -a  # -s 100 limits strings to 100 bytes instead of the default 32</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execve(&quot;/usr/bin/ls&quot;, [&quot;ls&quot;, &quot;-a&quot;], 0x7fffa7e0d008 /* 61 vars */) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">write(1, &quot;.  ..  content\tCONTRIBUTING.md  COPYING.md  .git  .gitignore  README.md  REVIEWING.md\n&quot;, 86.  ..  content CONTRIBUTING.md  COPYING.md  .git  .gitignore  README.md  REVIEWING.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) = 86</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">close(1)                                = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">close(2)                                = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exit_group(0)                           = ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ exited with 0 +++</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Look at its parameters:</p><ul><li>the path to the <strong>program</strong>: <code>/usr/bin/ls</code></li><li>the list of arguments: <code>&quot;ls&quot;, &quot;-a&quot;</code></li><li>the environment variables: the rest of the syscall&#x27;s arguments</li></ul><p><code>execve</code> invokes the loader to load the VAS of the <code>ls</code> process <strong>by replacing that of the existing process</strong>.
All subsequent syscalls are performed by the newly spawned <code>ls</code> process.
We will get into more details regarding <code>execve</code> <a href="/operating-systems/Compute/lab6#guide-system-dissected">towards the end of this lab</a>.</p><p><img loading="lazy" alt="Loading of `ls` Process" src="/operating-systems/assets/images/loading-of-ls-process-0dec67c0d0a826710e06f980224d5eb4.svg" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fork">Fork<a class="hash-link" href="#fork" title="Direct link to heading">​</a></h3><p>Up to now we&#x27;ve been creating processes using various high-level APIs, such as <code>Popen()</code>, <code>Process()</code> and <code>system()</code>.
Yes, despite being a C function, as you&#x27;ve seen from its man page, <code>system()</code> itself calls 2 other functions: <code>fork()</code> to create a process and <code>execve()</code> to execute the given command.
As you already know from the <a href="/operating-systems/Compute/lab2.md#libraries-and-libc">Software Stack</a> chapter, library functions may call one or more underlying system calls or other functions.
Now we will move one step lower on the call stack and call <code>fork()</code> ourselves.</p><p><code>fork()</code> creates one child process that is <em>almost</em> identical to its parent.
We say that <code>fork()</code> returns <strong>twice</strong>: once in the parent process and once more in the child process.
This means that after <code>fork()</code> returns, assuming no error has occurred, both the child and the parent resume execution from the same place: the instruction following the call to <code>fork()</code>.
What&#x27;s different between the two processes is the value returned by <code>fork()</code>:</p><ul><li><strong>child process</strong>: <code>fork()</code> returns 0</li><li><strong>parent process</strong>: <code>fork()</code> returns the PID of the child process (&gt; 0)</li><li><strong>on error</strong>: <code>fork()</code> returns -1, only once, in the initial process</li></ul><p>Therefore, the typical code for handling a <code>fork()</code> is available in <code>create-process/support/fork.c</code>.
Take a look at it and then run it.
Notice what each of the two processes prints:</p><ul><li>the PID of the child is also known by the parent</li><li>the PPID of the child is the PID of the parent</li></ul><p>Unlike <code>system()</code>, who also waits for its child, when using <code>fork()</code> we must do the waiting ourselves.
In order to wait for a process to end, we use the <a href="https://linux.die.net/man/2/waitpid" target="_blank" rel="noopener noreferrer"><code>waitpid()</code></a> syscall.
It places the exit code of the child process in the <code>status</code> parameter.
This argument is actually a bit-field containing more information than merely the exit code.
To retrieve the exit code, we use the <code>WEXITSTATUS</code> macro.
Keep in mind that <code>WEXITSTATUS</code> only makes sense if <code>WIFEXITED</code> is true, i.e. if the child process finished on its own and wasn&#x27;t killed by another one or by an illegal action (such as a segfault or illegal instruction) for example.
Otherwise, <code>WEXITSTATUS</code> will return something meaningless.
You can view the rest of the information stored in the <code>status</code> bit-field <a href="https://linux.die.net/man/2/waitpid" target="_blank" rel="noopener noreferrer">in the man page</a>.</p><p><strong>Moral of the story</strong>: Usually the execution flow is:</p><ol><li><p><code>fork()</code>, followed by</p></li><li><p><code>wait()</code> (called by the parent)</p></li><li><p><code>exit()</code>, called by the child.</p></li></ol><p>The order of last 2 steps may be swapped.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="threads">Threads<a class="hash-link" href="#threads" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="threads-vs-processes">Threads vs Processes<a class="hash-link" href="#threads-vs-processes" title="Direct link to heading">​</a></h3><p>So why use the implementation that spawns more processes if it&#x27;s slower than the one using threads?
The table below lists the differences between threads and processes.
Generally, if we only want to do some computing, we use threads.
If we need to drastically change the behaviour of the program, we need a new program altogether, or we need more than computing (e.g. communication on the network to create a computing cluster), we use processes.</p><table><thead><tr><th align="left">PROCESS</th><th align="left">THREAD</th></tr></thead><tbody><tr><td align="left">independent</td><td align="left">part of a process</td></tr><tr><td align="left">collection of threads</td><td align="left">shares VAS with other threads</td></tr><tr><td align="left">slower creation (new page table must be created)</td><td align="left">faster creation</td></tr><tr><td align="left">longer context switch duration (TLB must be flushed)</td><td align="left">shorter context switch duration (part of the same process, so same TLB)</td></tr><tr><td align="left">ending means ending all threads</td><td align="left">other threads continue when finished</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="safety">Safety<a class="hash-link" href="#safety" title="Direct link to heading">​</a></h4><p>Compile and run the two programs in <code>chapters/compute/threads/drills/tasks/sum-array-bugs/support/seg-fault/</code>, first with 2 processes and threads and then with 4.
They do the same thing as before: compute the sum of the elements in an array, but with a twist: each of them contains a bug causing a segfault.
Notice that <code>sum_array_threads</code> doesn&#x27;t print anything with 4 threads, but merely a &quot;Segmentation fault&quot; message.
On the other hand, <code>sum_array_processes</code> prints a sum and a running time, albeit different from the sums we&#x27;ve seen so far.</p><p>The reason is that signals such as <code>SIGSEGV</code>, which is used when a segmentation fault happens affect the entire process that handles them.
Therefore, when we split our workload between several threads and one of them causes an error such as a segfault, that error is going to terminate the entire process.
The same thing happens when we use processes instead of threads: one process causes an error, which gets it killed, but the other processes continue their work unhindered.
This is why we end up with a lower sum in the end: because one process died too early and didn&#x27;t manage to write the partial sum it had computed to the <code>results</code> array.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="memory-layout-of-multithreaded-programs">Memory Layout of Multithreaded Programs<a class="hash-link" href="#memory-layout-of-multithreaded-programs" title="Direct link to heading">​</a></h3><p>When a new thread is created, a new stack is allocated for a thread.
The default stack size if <code>8 MB</code> / <code>8192 KB</code>:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ ulimit -s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8192</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Enter the <code>chapters/compute/threads/drills/tasks/multithreaded/support/</code> directory to observe the update of the memory layout when creating new threads.</p><p>Build the <code>multithreaded</code> executable:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../multithreaded/support$ make</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Start the program:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../multithreaded/support$ ./multithreaded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Press key to start creating threads ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[...]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And investigate it with <code>pmap</code> on another console, while pressing a key to create new threads.</p><p>As you can see, there is a new <code>8192 KB</code> area created for every thread, also increasing the total virtual size.</p><p><a href="/operating-systems/Compute/Questions/thread-memory">Quiz</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-baby-steps---python">Guide: Baby steps - Python<a class="hash-link" href="#guide-baby-steps---python" title="Direct link to heading">​</a></h2><p>Run the code in <code>chapters/compute/processes/guides/create-process/support/popen.py</code>.
It simply spawns a new process running the <code>ls</code> command using <a href="https://docs.python.org/3/library/subprocess.html#subprocess.Popen" target="_blank" rel="noopener noreferrer"><code>subprocess.Popen()</code></a>.
Do not worry about the huge list of arguments that <code>Popen()</code> takes.
They are used for <strong>inter-process-communication</strong>.
You&#x27;ll learn more about this in the <!-- -->[Application Interaction chapter]<!-- -->.</p><p>Note that this usage of <code>Popen()</code> is not entirely correct.
You&#x27;ll discover why later, but for now focus on simply understanding how to use <code>Popen()</code> on its own.</p><p>Now change the command to anything you want.
Also give it some arguments.
From the outside, it&#x27;s as if you were running these commands from the terminal.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-sum-array-processes">Guide: Sum Array Processes<a class="hash-link" href="#guide-sum-array-processes" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sum-of-the-elements-in-an-array">Sum of the Elements in an Array<a class="hash-link" href="#sum-of-the-elements-in-an-array" title="Direct link to heading">​</a></h3><p>Let&#x27;s assume we only have one process on our system, and that process knows how to add the numbers in an array.
It can use however many resources it wants, since there is no other process to contest it.
It would probably look like the code in <code>chapters/compute/processes/guides/sum-array-processes/support/c/sum_array_sequential.c</code>.
The program also measures the time spent computing the sum.
Let&#x27;s compile and run it:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../sum-array/support/c$ ./sum_array_sequential</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Array sum is: 49945994146</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time spent: 127 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You will most likely get a different sum (because the array is made up of random numbers) and a different time than the ones shown above.
This is perfectly fine.
Use these examples qualitatively, not quantitatively.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spreading-the-work-among-other-processes">Spreading the Work Among Other Processes<a class="hash-link" href="#spreading-the-work-among-other-processes" title="Direct link to heading">​</a></h3><p>Due to how it&#x27;s implemented so far, our program only uses one of our CPU&#x27;s cores.
We never tell it to distribute its workload to other cores.
This is wasteful as the rest of our cores remain unused:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ lscpu | grep ^CPU\(s\):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CPU(s):                          8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We have 7 more cores waiting to add numbers in our array.</p><p><img loading="lazy" alt="What if we used 100% of the CPU?" src="/operating-systems/assets/images/100-percent-cpu-1138186529f154d864f643179e25cea1.jpeg" width="541" height="500" class="img_ev3q"></p><p>What if we use 7 more processes and spread the task of adding the numbers in this array between them?
If we split the array into several equal parts and designate a separate process to calculate the sum of each part, we should get a speedup because now the work performed by each individual process is reduced.</p><p>Let&#x27;s take it methodically.
Compile and run <code>sum_array_processes.c</code> using 1, 2, 4 and 8 processes respectively.
If your system only has 4 cores (<a href="https://www.intel.com/content/www/us/en/gaming/resources/hyper-threading.html" target="_blank" rel="noopener noreferrer">hyperthreading</a> included), limit your runs to 4 processes.
Note the running times for each number of processes.
We expect the speedups compared to our reference run to be 1, 2, 4 and 8 respectively, right?</p><p><a href="/operating-systems/Compute/Questions/processes-speedup">Quiz</a></p><p>You most likely did get some speedup, especially when using 8 processes.
Now we will try to improve this speedup by using <strong>threads</strong> instead.</p><p>Also notice that we&#x27;re not using hundreds or thousands of processes.
Assuming our system has 8 cores, only 8 <em>threads</em> can run at the same time.
In general, <strong>the maximum number of threads that can run at the same time is equal to the number of cores</strong>.
In our example, each process only has one thread: its main thread.
So by consequence and by forcing the terminology (because it&#x27;s the main thread of these processes that is running, not the processes themselves), we can only run in parallel a number of processes equal to at most the number of cores.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-system-dissected">Guide: <code>system</code> Dissected<a class="hash-link" href="#guide-system-dissected" title="Direct link to heading">​</a></h2><p>You already know that <code>system</code> calls <code>fork()</code> and <code>execve()</code> to create the new process.
Let&#x27;s see how and why.
First, we run the following command to trace the <code>execve()</code> syscalls used by <code>sleepy_creator</code>.
We&#x27;ll leave <code>fork()</code> for later.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../sleepy/support$ strace -e execve -ff -o syscalls ./sleepy_creator</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At this point, you will get two files whose names start with <code>syscalls</code>, followed by some numbers.
Those numbers are the PIDs of the parent and the child process.
Therefore, the file with the higher number contains logs of the <code>execve</code> and <code>clone</code> syscalls issued by the parent process, while
the other logs those two syscalls when made by the child process.
Let&#x27;s take a look at them.
The numbers below will differ from those on your system:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../sleepy/support:$ cat syscalls.2523393  # syscalls from parent process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execve(&quot;sleepy_creator&quot;, [&quot;sleepy_creator&quot;], 0x7ffd2c157758 /* 39 vars */) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=2523394, si_uid=1052093, si_status=0, si_utime=0, si_stime=0} ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ exited with 0 +++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../sleepy/support:$ cat syscalls.2523394  # syscalls from child process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execve(&quot;/bin/sh&quot;, [&quot;sh&quot;, &quot;-c&quot;, &quot;sleep 10&quot;], 0x7ffd36253be8 /* 39 vars */) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execve(&quot;/usr/bin/sleep&quot;, [&quot;sleep&quot;, &quot;10&quot;], 0x560f41659d40 /* 38 vars */) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ exited with 0 +++</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><a href="/operating-systems/Compute/Questions/who-calls-execve-parent">Quiz</a></p><p>Now notice that the child process doesn&#x27;t simply call <code>execve(&quot;/usr/bin/sleep&quot; ...)</code>.
It first changes its virtual address space (VAS) to that of a <code>bash</code> process (<code>execve(&quot;/bin/sh&quot; ...)</code>) and then that <code>bash</code> process switches its VAS to <code>sleep</code>.
Therefore, calling <code>system(&lt;some_command&gt;)</code> is equivalent to running <code>&lt;some_command&gt;</code> in the command-line.</p><p><strong>Moral of the story</strong>: When spawning a new command, the call order is:</p><ul><li>parent: <code>fork()</code>, <code>exec()</code>, <code>wait()</code></li><li>child: <code>exit()</code></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-sum-array-threads">Guide: Sum array Threads<a class="hash-link" href="#guide-sum-array-threads" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spreading-the-work-among-other-threads">Spreading the Work Among Other Threads<a class="hash-link" href="#spreading-the-work-among-other-threads" title="Direct link to heading">​</a></h3><p>Compile the code in <code>chapters/compute/threads/guides/sum-array-threads/support/c/sum_array_threads.c</code> and run it using 1, 2, 4 and 8 threads as you did before.
Each thread runs the <code>calculate_array_part_sum()</code> function and then finishes.
Running times should be <em>slightly</em> smaller than the implementation using processes.
This slight time difference is caused by process creation actions, which are costlier than thread creation actions.
Because a process needs a separate virtual address space (VAS) and needs to duplicate some internal structures such as the file descriptor table and page table, it takes the operating system more time to create it than to create a thread.
On the other hand, threads belonging to the same process share the same VAS and, implicitly, the same OS-internal structures.
Therefore, they are more lightweight than processes.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-threads-and-processes-clone">Guide: Threads and Processes: <code>clone</code><a class="hash-link" href="#guide-threads-and-processes-clone" title="Direct link to heading">​</a></h2><p>Let&#x27;s go back to our initial demos that used threads and processes.
We&#x27;ll see that in order to create both threads and processes, the underlying Linux syscall is <code>clone</code>.
For this, we&#x27;ll run both <code>sum_array_threads</code> and <code>sum_array_processes</code> under <code>strace</code>.
As we&#x27;ve already established, we&#x27;re only interested in the <code>clone</code> syscall:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../sum-array/support/c$ strace -e clone,clone3 ./sum_array_threads 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clone(child_stack=0x7f60b56482b0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tid=[1819693], tls=0x7f60b5649640, child_tidptr=0x7f60b5649910) = 1819693</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clone(child_stack=0x7f60b4e472b0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tid=[1819694], tls=0x7f60b4e48640, child_tidptr=0x7f60b4e48910) = 1819694</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../sum-array/support/c$ strace -e clone,clone3 ./sum_array_processes 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clone(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7f7a4e346650) = 1820599</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clone(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7f7a4e346650) = 1820600</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We ran each program with an argument of 2, so we have 2 calls to <code>clone</code>.
Notice that in the case of threads, the <code>clone3</code> syscall receives more arguments.
The relevant flags passed as arguments when creating threads are documented in <a href="https://man.archlinux.org/man/clone3.2.en" target="_blank" rel="noopener noreferrer"><code>clone</code>&#x27;s man page</a>:</p><ul><li><code>CLONE_VM</code>: the child and the parent process share the same VAS</li><li><code>CLONE_{FS,FILES,SIGHAND}</code>: the new thread shares the filesystem information, file and signal handlers with the one that created it.
The syscall also receives valid pointers to the new thread&#x27;s stack and TLS, i.e. the only parts of the VAS that are distinct between threads (although they are technically accessible from all threads).</li></ul><p>By contrast, when creating a new process, the arguments of the <code>clone</code> syscall are simpler (i.e. fewer flags are present).
Remember that in both cases <code>clone</code> creates a new <strong>thread</strong>.
When creating a process, <code>clone</code> creates this new thread within a new separate address space.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/operating-systems/Compute/Questions/not-race-condition"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Not Race Condition</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/operating-systems/Compute/lab7"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Lab 7 - Copy-on-Write</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#task-creating-a-process" class="table-of-contents__link toc-highlight">Task: Creating a process</a><ul><li><a href="#higher-level---python" class="table-of-contents__link toc-highlight">Higher level - Python</a></li><li><a href="#lower-level---c" class="table-of-contents__link toc-highlight">Lower level - C</a></li></ul></li><li><a href="#task-wait-for-me" class="table-of-contents__link toc-highlight">Task: Wait for Me</a></li><li><a href="#task-create-process" class="table-of-contents__link toc-highlight">Task: Create Process</a></li><li><a href="#task-multithreaded" class="table-of-contents__link toc-highlight">Task: Multithreaded</a></li><li><a href="#task-libraries-for-parallel-processing" class="table-of-contents__link toc-highlight">Task: Libraries for Parallel Processing</a><ul><li><a href="#stdparallelism-in-d" class="table-of-contents__link toc-highlight"><code>std.parallelism</code> in D</a></li><li><a href="#openmp-for-c" class="table-of-contents__link toc-highlight">OpenMP for C</a></li><li><a href="#array-sum-in-python" class="table-of-contents__link toc-highlight">Array Sum in Python</a></li></ul></li><li><a href="#task-wait-for-it" class="table-of-contents__link toc-highlight">Task: Wait for It</a><ul><li><a href="#memory-corruption" class="table-of-contents__link toc-highlight">Memory Corruption</a></li></ul></li><li><a href="#hardware-perspective" class="table-of-contents__link toc-highlight">Hardware Perspective</a><ul><li><a href="#the-role-of-the-operating-system" class="table-of-contents__link toc-highlight">The Role of the Operating System</a></li></ul></li><li><a href="#processes" class="table-of-contents__link toc-highlight">Processes</a><ul><li><a href="#fork" class="table-of-contents__link toc-highlight">Fork</a></li></ul></li><li><a href="#threads" class="table-of-contents__link toc-highlight">Threads</a><ul><li><a href="#threads-vs-processes" class="table-of-contents__link toc-highlight">Threads vs Processes</a></li><li><a href="#memory-layout-of-multithreaded-programs" class="table-of-contents__link toc-highlight">Memory Layout of Multithreaded Programs</a></li></ul></li><li><a href="#guide-baby-steps---python" class="table-of-contents__link toc-highlight">Guide: Baby steps - Python</a></li><li><a href="#guide-sum-array-processes" class="table-of-contents__link toc-highlight">Guide: Sum Array Processes</a><ul><li><a href="#sum-of-the-elements-in-an-array" class="table-of-contents__link toc-highlight">Sum of the Elements in an Array</a></li><li><a href="#spreading-the-work-among-other-processes" class="table-of-contents__link toc-highlight">Spreading the Work Among Other Processes</a></li></ul></li><li><a href="#guide-system-dissected" class="table-of-contents__link toc-highlight">Guide: <code>system</code> Dissected</a></li><li><a href="#guide-sum-array-threads" class="table-of-contents__link toc-highlight">Guide: Sum array Threads</a><ul><li><a href="#spreading-the-work-among-other-threads" class="table-of-contents__link toc-highlight">Spreading the Work Among Other Threads</a></li></ul></li><li><a href="#guide-threads-and-processes-clone" class="table-of-contents__link toc-highlight">Guide: Threads and Processes: <code>clone</code></a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://curs.upb.ro" target="_blank" rel="noopener noreferrer" class="footer__link-item">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ocw.cs.pub.ro/courses/so" target="_blank" rel="noopener noreferrer" class="footer__link-item">OCW<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/sisteme.de.operare/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 SO Team</div></div></div></footer></div>
<script src="/operating-systems/assets/js/runtime~main.cf1d83f1.js"></script>
<script src="/operating-systems/assets/js/main.abededcd.js"></script>
</body>
</html>