<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Compute/lab8">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Lab 8 - Synchronization | Operating Systems</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://localhost//operating-systems/Compute/lab8"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Lab 8 - Synchronization | Operating Systems"><meta data-rh="true" name="description" content="Task Race Conditions"><meta data-rh="true" property="og:description" content="Task Race Conditions"><link data-rh="true" rel="canonical" href="http://localhost//operating-systems/Compute/lab8"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/Compute/lab8" hreflang="en"><link data-rh="true" rel="alternate" href="http://localhost//operating-systems/Compute/lab8" hreflang="x-default"><link rel="stylesheet" href="/operating-systems/assets/css/styles.48876178.css">
<link rel="preload" href="/operating-systems/assets/js/runtime~main.b1620ad0.js" as="script">
<link rel="preload" href="/operating-systems/assets/js/main.fb2c1889.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/operating-systems/"><div class="navbar__logo"><img src="/operating-systems/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/operating-systems/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">SO</b></a><a class="navbar__item navbar__link" href="/operating-systems/Software Stack">Software Stack</a><a class="navbar__item navbar__link" href="/operating-systems/Data">Data</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/operating-systems/Compute">Compute</a><a class="navbar__item navbar__link" href="/operating-systems/IO">IO</a><a class="navbar__item navbar__link" href="/operating-systems/Application Interaction">Application Interaction</a><a class="navbar__item navbar__link" href="/operating-systems/Assignments">Assignments</a><a class="navbar__item navbar__link" href="/operating-systems/Exams">Exams</a><a class="navbar__item navbar__link" href="/operating-systems/Hackathons">Hackathons</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/lab-setup">Setting up the Lab Environment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Software Stack/">Software Stack</a><button aria-label="Toggle the collapsible sidebar category &#x27;Software Stack&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Data/">Data</a><button aria-label="Toggle the collapsible sidebar category &#x27;Data&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/operating-systems/Compute/">Compute</a><button aria-label="Toggle the collapsible sidebar category &#x27;Compute&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Compute/">Slides</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Compute/compute-overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/operating-systems/Compute/Questions/">Questions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Questions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Compute/lab6">Lab 6 - Multiprocess and Multithread</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/operating-systems/Compute/lab7">Lab 7 - Copy-on-Write</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/operating-systems/Compute/lab8">Lab 8 - Synchronization</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/IO/">IO</a><button aria-label="Toggle the collapsible sidebar category &#x27;IO&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Application Interaction/">Application Interaction</a><button aria-label="Toggle the collapsible sidebar category &#x27;Application Interaction&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Assignments/">Assignments</a><button aria-label="Toggle the collapsible sidebar category &#x27;Assignments&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Exams/">Exams</a><button aria-label="Toggle the collapsible sidebar category &#x27;Exams&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operating-systems/Hackathons/">Hackathons</a><button aria-label="Toggle the collapsible sidebar category &#x27;Hackathons&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/rules-and-grading">Rules and Grading</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/operating-systems/resources">Resources</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/operating-systems/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/operating-systems/Compute/"><span itemprop="name">Compute</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lab 8 - Synchronization</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Lab 8 - Synchronization</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-c-race-conditions">Task: C: Race Conditions<a class="hash-link" href="#task-c-race-conditions" title="Direct link to heading">​</a></h2><p>Go to <code>chapters/compute/synchronization/drills/tasks/race-condition/support/c/race_condition_mutex.c</code> and notice the differences between this code and the buggy one.
We now use a <code>pthread_mutex_t</code> variable, which we <code>lock</code> at the beginning of a critical section, and we <code>unlock</code> at the end.
Generally speaking, <code>lock</code>-ing a mutex makes a thread enter a critical section, while calling <code>pthread_mutex_unlock()</code> makes the thread leave said critical section.
Therefore, as we said previously, the critical sections in our code are <code>var--</code> and <code>var++</code>.
Run the code multiple times to convince yourself that in the end, the value of <code>var</code> will always be 0.</p><p>Mutexes contain an internal variable which can be either 1 (locked) or 0 (unlocked).
When a thread calls <code>pthread_mutex_lock()</code>, it attempts to set that variable to 1.
If it was 0, the thread sets it to 1 and proceeds to execute the critical section.
Otherwise, it <strong>suspends its execution</strong> and waits until that variable is set to 0 again.</p><p>When calling <code>pthread_mutex_unlock()</code>, the internal variable is set to 0 and all waiting threads are woken up to try to acquire the mutex again.
<strong>Be careful:</strong> It is generally considered unsafe and <a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/pthread_mutex_lock.html" target="_blank" rel="noopener noreferrer">in many cases undefined behaviour</a> to call <code>pthread_mutex_unlock()</code> from a different thread than the one that acquired the lock.
So the general workflow should look something like this:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">within a single thread:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pthread_mutex_lock(&amp;mutex)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // do atomic stuff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pthread_mutex_unlock(&amp;mutex)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="synchronization---overhead">Synchronization - Overhead<a class="hash-link" href="#synchronization---overhead" title="Direct link to heading">​</a></h3><blockquote><p>There ain&#x27;t no such thing as a free lunch</p></blockquote><p>This saying is also true for multithreading.
Running threads in parallel is nice and efficient, but synchronization always comes with a penalty: overhead.
Use the <code>time</code> command to record the running times of <code>race_condition</code> and <code>race_condition_mutex</code>.
Notice that those of <code>race_condition_mutex</code> are larger than those of <code>race_condition</code>.</p><p>The cause of this is that now when one thread is executing the critical section, the other has to wait and do nothing.
Waiting means changing its state from RUNNING to WAITING, which brings further overhead from the scheduler.
This latter overhead comes from the <strong>context switch</strong> that is necessary for a thread to switch its state from RUNNING to WAITING and back.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-wrap-the-whole-for-statements-in-critical-sections">Task: Wrap the Whole <code>for</code> Statements in Critical Sections<a class="hash-link" href="#task-wrap-the-whole-for-statements-in-critical-sections" title="Direct link to heading">​</a></h2><p>Navigate to the <code>chapters/compute/synchronization/drills/tasks/wrap-the-for/</code> directory, run <code>make skels</code> and open the <code>support/src</code> directory.</p><p>Here you will find two source files:</p><ul><li>race_condition_inner_mutex</li><li>race_condition_outer_mutex</li></ul><p>Following the pattern used in <code>race_condition_inner_mutex.c</code> go in <code>race_condition_outer_mutex.c</code> move the calls to <code>pthread_mutex_lock()</code> and <code>pthread_mutex_unlock()</code> outside the <code>for</code> statements so that the critical sections become the entire statement.
To see the time difference between the two implementations all you have to do is enter <code>tests/</code> and run the checker.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/tests/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./checker.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should see in the terminal:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Test passed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><iframe id="380c7aed-20e3-4b42-8124-338b2daa10d0" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;5c9e9e84-dc2d-4c77-8af7-f6639314fbce&quot;&gt; &lt;p&gt;Why does code with the the larger (coarser) critical section run faster than the one with the smaller (more granular) critical section?&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;a1e8a783-48ba-4283-a429-c5792465e8a1&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;a1e8a783-48ba-4283-a429-c5792465e8a1&quot;&gt; &lt;p&gt;Because the loops in the more granular code run for more steps&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;90a4c7a8-aee5-4c7e-b418-092ddf7a3f70&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;90a4c7a8-aee5-4c7e-b418-092ddf7a3f70&quot;&gt; &lt;p&gt;Because the more granular code causes more context switches, which are expensive&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;81e35e8f-e184-44fb-a7c1-91e26c774302&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;81e35e8f-e184-44fb-a7c1-91e26c774302&quot;&gt; &lt;p&gt;Because the coarser code can be better optimised by the compiler&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;90a4c7a8-aee5-4c7e-b418-092ddf7a3f70&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;The larger critical sections only require &lt;strong&gt;2 context switches&lt;/strong&gt;.
The first thread that reaches the call to &lt;code&gt;lock()&lt;/code&gt; acquires to the mutex and starts executing the whole of the &lt;code&gt;for&lt;/code&gt; loop.
The second thread then finds the mutex &lt;em&gt;locked&lt;/em&gt; and enters the WAITING state.
When the first thread finishes its loop, it calls &lt;code&gt;unlock()&lt;/code&gt; and wakes up the second thread, which acquires the lock and starts its loop.&lt;/p&gt;&lt;p&gt;In the more granular example, in the worst case, the holder of the mutex can change at every step of the loop.
This would mean 1 context switch per step per thread, i.e. &lt;strong&gt;20 million context switches&lt;/strong&gt;.&lt;/p&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-c-atomics">Task: C: Atomics<a class="hash-link" href="#task-c-atomics" title="Direct link to heading">​</a></h2><p>So now we know how to use mutexes.
And we know that mutexes work by using an internal variable that can be either 1 (locked) or 0 (unlocked).
But how does <code>pthread_mutex_lock()</code> actually set that variable to 1?
How does it avoid a race condition in case another thread also wants to set it to 1?</p><p>We need a guarantee that anyone &quot;touching&quot; that variable does so &quot;within its own critical section&quot;.
But now we need a critical section to implement a critical section...
To solve this circular problem, we make use of a very common <em>Deus ex Machina</em>: <strong>hardware support</strong>.</p><p>Modern processors are capable of <em>atomically</em> accessing data, either for reads or writes.
An atomic action is an indivisible sequence of operations that a thread runs without interference from others.
Concretely, before initiating an atomic transfer on one of its data buses, the CPU first makes sure all other transfers have ended, then <strong>locks</strong> the data bus by stalling all cores attempting to transfer data on it.
This way, one thread obtains <strong>exclusive</strong> access to the data bus while accessing data.
As a side note, the critical sections in <code>chapters/compute/synchronization/drills/tasks/race-condition/support/c/race_condition_mutex.c</code> are also atomic once they are wrapped between calls to <code>pthread_mutex_lock()</code> and <code>pthread_mutex_unlock()</code>.</p><p>As with every hardware feature, the <code>x86</code> ISA exposes an instruction for atomic operations.
In particular, this instruction is a <strong>prefix</strong>, called <code>lock</code>.
It makes the instruction that follows it run atomically.
The <code>lock</code> prefix ensures that the core performing the instruction has exclusive ownership of the cache line from where the data is transferred for the entire operation.
This is how the increment is made into an indivisible unit.</p><p>For example, <code>inc dword [x]</code> can be made atomic, like so: <code>lock inc dword [x]</code>.</p><p>Compilers provide support for such hardware-level atomic operations.
GCC exposes <a href="https://gcc.gnu.org/onlinedocs/gcc/_005f_005fatomic-Builtins.html" target="_blank" rel="noopener noreferrer">built-ins</a> such as <code>__atomic_load()</code>, <code>__atomic_store()</code>, <code>__atomic_compare_exchange()</code> and many others.
All of them rely on the mechanism described above.</p><p>Go to <code>chapters/compute/synchronization/drills/tasks/race-condition-atomic/</code> and run:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">make</span><span class="token plain"> skels</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now enter <code>chapters/compute/synchronization/drills/tasks/race-condition-atomic/support/src/race_condition_atomic.c</code> and complete the function <code>decrement_var()</code>.
Compile and run the code.
Its running time should be somewhere between <code>race_condition</code> and <code>race_condition_mutex</code>.</p><p>The C standard library also provides atomic data types.
Access to these variables can be done only by one thread at a time.
Go to <code>chapters/compute/synchronization/drills/tasks/race-condition-atomic/support/race_condition_atomic2.c</code>, compile and run the code.</p><p>After both tasks are done, go in the checker folder and run it using the following commands:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/tests/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./checker.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Notice that the time is similar to <code>race_condition_atomic</code>.</p><p>So using the hardware support is more efficient, but it usually is leveraged only for simple, individual instructions, such as loads and stores.
And the fact that high-level languages also expose an API for atomic operations shows how useful these operations are for developers.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-c---tls-on-demand">Task: C - TLS on Demand<a class="hash-link" href="#task-c---tls-on-demand" title="Direct link to heading">​</a></h2><p>The perspective of C towards TLS is the following: everything is shared by default.
This makes multithreading easier and more lightweight to implement than in other languages, like D, because synchronization is left entirely up to the developer, at the cost of potential unsafety.</p><p>Of course, we can specify that some data belongs to the TLS, by preceding the declaration of a variable with <code>__thread</code> keyword.
Enter <code>chapters/compute/synchronization/drills/tasks/tls-on-demand/</code> and run <code>make skels</code>.
Now enter <code>support/src</code> and follow the TODOs.</p><ol><li><p>Create the declaration of <code>var</code> and add the <code>__thread</code> keyword to place the variable in the TLS of each thread.
Recompile and run the code a few more times.
You should see that in the end, <code>var</code> is 0.</p></li><li><p>Print the address and value of <code>var</code> in each thread.
See that they differ.</p></li><li><p>Modify the value of <code>var</code> in the <code>main()</code> function before calling <code>pthread_create()</code>.
Notice that the value doesn&#x27;t propagate to the other threads.
This is because, upon creating a new thread, its TLS is initialised.</p></li></ol><p><a href="/operating-systems/Compute/questions/tls-synchronization.md">Quiz 1</a></p><iframe id="bb41535b-74ef-4fce-81a8-8b7ac1291547" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;228ebd5a-3695-4ef1-932f-6cbe3618c032&quot;&gt; &lt;p&gt;How many copies of the &lt;code&gt;var&lt;/code&gt; variable from &lt;code&gt;support/race-condition/c/race_condition_tls.c&lt;/code&gt; are there after each thread has modified it at leas once?&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;dce9e67a-3759-4ab7-8fe1-adf0d0f03502&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;dce9e67a-3759-4ab7-8fe1-adf0d0f03502&quot;&gt; &lt;p&gt;5&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;44326640-cf5b-41bd-8739-4c703d542711&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;44326640-cf5b-41bd-8739-4c703d542711&quot;&gt; &lt;p&gt;1&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;2e8f6b01-605d-47d6-8ddc-7c378d3c3c9f&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;2e8f6b01-605d-47d6-8ddc-7c378d3c3c9f&quot;&gt; &lt;p&gt;2&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;64380b9e-8301-41b4-8a8f-84f193ea30db&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;64380b9e-8301-41b4-8a8f-84f193ea30db&quot;&gt; &lt;p&gt;3&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;64380b9e-8301-41b4-8a8f-84f193ea30db&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;There are 3 copies one for the &lt;code&gt;main()&lt;/code&gt; thread, another one for &lt;code&gt;increment_var()&lt;/code&gt; and the third for &lt;code&gt;decrement_var()&lt;/code&gt;.&lt;/p&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-atomic-assembly">Task: Atomic Assembly<a class="hash-link" href="#task-atomic-assembly" title="Direct link to heading">​</a></h2><p>No, this section is not about nukes, sadly :(.
Instead, we aim to get accustomed to the way in which the x86 ISA provides atomic instructions.</p><p>This mechanism looks very simple.
It is but <strong>one instruction prefix</strong>: <code>lock</code>.
It is not an instruction with its own separate opcode, but a prefix that slightly modifies the opcode of the following instructions to make the CPU execute it atomically (i.e. with exclusive access to the data bus).</p><p><code>lock</code> must only be place before an instruction that executes a <em>read-modify-write</em> action.
For example, we cannot place it before a <code>mov</code> instruction, as the action of a <code>mov</code> is simply <code>read</code> or <code>write</code>.
Instead, we can place it in front of an <code>inc</code> instruction if its operand is memory.</p><p>Go in <code>chapters/compute/synchronization/drills/tasks/atomic-assembly/</code> and run:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">make</span><span class="token plain"> skels</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Look at the code in <code>chapters/compute/synchronization/drills/tasks/atomic-assembly/support/src/race_condition_lock.asm</code>.
It&#x27;s an Assembly equivalent of the code you&#x27;ve already seen many times so far (such as <code>chapters/compute/synchronization/drills/tasks/race-condition/support/c/race_condition.c</code>).
The 2 assembly functions (<strong>increment_var</strong> and <strong>decrement_var</strong>) are called by <code>race_condition_lock_checker.c</code></p><p>Now add the <code>lock</code> prefix before <code>dec</code>.
Go in the <code>tests/</code> folder and run the checker:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">/tests/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./checker.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You should see something like this, if done correctly:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Building the project...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nasm -f elf64 -o race_condition_lock.o race_condition_lock.asm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcc -no-pie -o race_condition_lock_checker race_condition_lock_checker.c race_condition_lock.o -lpthread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Checking if var == 0...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Test passed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And now we have synchronized the two threads by leveraging CPU support.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-apache2-simulator---semaphore">Guide: <code>apache2</code> Simulator - Semaphore<a class="hash-link" href="#guide-apache2-simulator---semaphore" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="semaphores">Semaphores<a class="hash-link" href="#semaphores" title="Direct link to heading">​</a></h3><p>Up to now, we&#x27;ve learned how to create critical sections that can be accessed by <strong>only one thread</strong> at a time.
These critical sections revolved around <strong>data</strong>.
Whenever we define a critical section, there is some specific data to which we cannot allow parallel access.
The reason why we can&#x27;t allow it is, in general, data integrity, as we&#x27;ve seen in our examples in <code>chapters/compute/synchronization/drills/tasks/race-condition/support/</code></p><p>But what if threads need to count?
Counting is inherently thread-unsafe because it&#x27;s a <em>read-modify-write</em> operation.
We read the counter, increment (modify) it and then write it back.
Think about our example with <a href="/operating-systems/Compute/lab7#usage-of-processes-and-threads-in-apache2"><code>apache2</code></a>
Let&#x27;s say a <code>worker</code> has created a <em>pool</em> of 3 threads.
They are not doing any work initially;
they are in the WAITING state.
As clients initiate connections, these threads are picked up and are used to serve <strong>at most 3</strong> connections at a time.
But the number of connections may be arbitrarily large.
Therefore, we need a way to keep track of it.
When serving a client, a thread should decrement it to inform the others that a connection has been finished.
In short, we need a counter that the dispatcher increments and that worker threads decrement.</p><p>Such a counter could be implemented using a <strong>semaphore</strong>.
For simplicity&#x27;s sake, you can view a semaphore as simply a mutex whose internal variable can take any value and acts like a counter.
When a thread attempts to <code>acquire()</code> a semaphore, it will wait if this counter is less than or equal to 0.
Otherwise, the thread <strong>decrements</strong> the internal counter and the function returns.
The opposite of <code>acquire()</code> is <code>release()</code>, which increases the internal counter by a given value (by default 1).</p><p>Go to <code>chapters/compute/synchronization/guides/apache2-simulator-semaphore/support/apache2_simulator_semaphore.py</code>.
In the <code>main()</code> function we create a semaphore which we increment (<code>release()</code>) upon every new message.
Each thread decrements (<code>acquire()</code>) this semaphore to signal that it wants to retrieve a message from the list.
The retrieval means modifying a data structure, which is a critical section, so we use a <strong>separate</strong> mutex for this.
Otherwise, multiple threads could acquire the semaphore at the same time and try to modify the list at the same time.
Not good.</p><p>Locking this mutex (which in Python is called <code>Lock</code>) is done with the following statement: <code>with msg_mutex:</code>
This is a syntactic equivalent to:</p><div class="language-Python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">event.acquire()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">messages.append(msg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">event.release()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Since the length of the <code>messages</code> list is simply <code>len(messages)</code>, it may seem a bit redundant to use a semaphore to store essentially the same value.
In the next section, we&#x27;ll look at a more refined mechanism for our use case: <em>condition variables</em>.</p><iframe id="af6608bc-1953-42dd-9894-b660616e1450" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;a0025849-6084-4fe7-b55f-7e2433221962&quot;&gt; &lt;p&gt;From running and inspecting the code in &lt;code&gt;support/apache2-simulator/apache2_simulator_semaphore.py&lt;/code&gt;, which of the following is an an equivalent to the value of the semaphore &lt;code&gt;sem&lt;/code&gt;?&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;c0cab6c3-fe29-44e7-a80d-78a6d66b9fcf&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;c0cab6c3-fe29-44e7-a80d-78a6d66b9fcf&quot;&gt; &lt;p&gt;The length of the &lt;code&gt;messages&lt;/code&gt; list&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;6762c00f-1ba2-4050-a016-2f9d3ccb53fc&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;6762c00f-1ba2-4050-a016-2f9d3ccb53fc&quot;&gt; &lt;p&gt;The number of worker threads&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;49fd9461-bd71-4b84-b4c0-7d54bcaa2038&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;49fd9461-bd71-4b84-b4c0-7d54bcaa2038&quot;&gt; &lt;p&gt;The time a worker thread has to wait before running&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;c153cbc6-6ed8-4a23-99c1-1894feee60f8&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;c153cbc6-6ed8-4a23-99c1-1894feee60f8&quot;&gt; &lt;p&gt;The value of &lt;code&gt;msg_mutex&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;c0cab6c3-fe29-44e7-a80d-78a6d66b9fcf&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;&lt;code&gt;sem&lt;/code&gt; is incremented (&lt;code&gt;release()&lt;/code&gt;) upon adding a message to the &lt;code&gt;messages&lt;/code&gt; list and decremented (&lt;code&gt;acquire()&lt;/code&gt;) when removing a message from said list.
So it&#x27;s a rough equivalent to the length of this list.&lt;/p&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-apache2-simulator---condition">Task: <code>apache2</code> Simulator - Condition<a class="hash-link" href="#task-apache2-simulator---condition" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="conditions">Conditions<a class="hash-link" href="#conditions" title="Direct link to heading">​</a></h3><p>Another way we can implement our <code>apache2</code> simulator is to use a condition variable.
This one is probably the most intuitive synchronization primitive.
It&#x27;s a means by which a thread can tell another one: &quot;Hey, wake up, <em>this</em> happened!&quot;.
So it&#x27;s a way for threads to notify each other.
For this reason, the main methods associated with conditions are <code>notify()</code> and <code>wait()</code>.
As you might expect, they are complementary:</p><ul><li><code>wait()</code> puts the thread in the WAITING state until it&#x27;s woken up by another one</li><li><code>notify()</code> wakes up one or more <code>wait()</code>-ing threads.
If <code>notify()</code> is called before any thread has called <code>wait()</code>, the first thread that calls it will continue its execution unhindered.</li></ul><p>Let&#x27;s talk about a classic problem in synchronization and parallel computing: <strong>The producer-consumer problem</strong>
The problem states that one or more producers generate data and places it in a shared buffer (a queue for example), while one or more consumers take data from the buffer to further process it.
More about it in this <a href="https://www.youtube.com/watch?v=Qx3P2wazwI0" target="_blank" rel="noopener noreferrer">video</a>.
There are a few rules though, such as:</p><ul><li>The producer must not insert data when the buffer is full.</li><li>The consumer must not retrieve data if the buffer is empty.</li><li>The producer and the consumer can&#x27;t access the shared buffer at the same time.</li></ul><p>Now enter <code>chapters/compute/synchronization/drills/tasks/apache2-simulator-condition/</code> and run <code>make skels</code>.
Look at the code in <code>chapters/compute/synchronization/drills/tasks/apache2-simulator/support/src/producer_consumer.py</code>.
We have one producer and one consumer for simplicity.
Observe that the producer calls <code>notify()</code> once there is data available, and the consumer calls <code>notify()</code>, when data is read.
Notice that this call is preceded by an <code>acquire()</code> call, and succeeded by a <code>release()</code> call.</p><p><code>acquire()</code> and <code>release()</code> are commonly associated with mutexes or semaphores.
What do they have to do with condition variables?</p><p>Well, a lock <code>Condition</code> variable also stores an inner lock (mutex).
It is this lock that we <code>acquire()</code> and <code>release()</code>.
In fact, the <a href="https://docs.python.org/3/library/threading.html#condition-objects" target="_blank" rel="noopener noreferrer">documentation</a> states we should only call <code>Condition</code> methods with its inner lock taken.</p><p>Why is this necessary?
We don&#x27;t want both the consumer and the producer to modify a buffer at the same time, this could lead to a race condition, especially if we have more producers and more consumers.</p><p>So now we know we cannot only use a mutex.
The mutex is used to access and modify the <code>queue</code> atomically.
Now, you might be thinking that this code causes a deadlock:</p><div class="language-Python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">condition.acquire()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    with condition:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    condition.wait()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The thread gets the lock and then, if there is no data, it switches its state to WAITING.
A classic deadlock, right?
No.
<code>wait()</code> also releases the inner lock of the <code>Condition</code> and being woken up reacquires it.
Neat!</p><p>So now we have both synchronization <strong>and</strong> signalling.
This is what conditions are for, ultimately.</p><p>Open <code>chapters/compute/synchronization/drills/tasks/apache2-simulator/support/src/apache2_simulator_condition.py</code> and follow the TODOs.
The code is similar to <code>apache2_simulator_semaphore.py</code>, but this time we use condition variables as shown in <code>producer_consumer.py</code>.</p><iframe id="66b2ab0d-9e2a-4c80-8953-0fb2a76f79ba" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;9b778d97-c820-4c01-a82e-33aebb4aafcf&quot;&gt; &lt;p&gt;Can we only use a mutex when signalling an event from one thread to another in?&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;2ffaf855-5a1e-4f86-a07c-64fbaf406294&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;2ffaf855-5a1e-4f86-a07c-64fbaf406294&quot;&gt; &lt;p&gt;Yes and this would yield better performance because the threads would only wait for one object: the mutex&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;e24ed3f4-52e0-4935-a2ec-7bc6548c9183&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;e24ed3f4-52e0-4935-a2ec-7bc6548c9183&quot;&gt; &lt;p&gt;No, because it will result in a deadlock where the both threads will be waiting for each other&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;a1803786-59f2-43df-a667-93b4ebf8c19a&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;a1803786-59f2-43df-a667-93b4ebf8c19a&quot;&gt; &lt;p&gt;Yes, because only one thread can modify the shared variables in order to maintain their integrity&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;1028e5f2-b884-4458-8537-e5bd0df421a3&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;1028e5f2-b884-4458-8537-e5bd0df421a3&quot;&gt; &lt;p&gt;No, because this would imply that the signalling thread would &lt;code&gt;unlock()&lt;/code&gt; the mutex, that the signalled thread attempts to &lt;code&gt;lock()&lt;/code&gt;, which is an undefined behaviour&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;1028e5f2-b884-4458-8537-e5bd0df421a3&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;In some implementations, such as &lt;a href=&quot;https://pubs.opengroup.org/onlinepubs/9699919799/functions/pthread_mutex_lock.html&quot;&gt;POSIX threads (pthreads)&lt;/a&gt;, calling &lt;code&gt;unlock()&lt;/code&gt; from another thread than that which called &lt;code&gt;lock()&lt;/code&gt; can result in an undefined behaviour.
For this reason, it is unsafe to only use a mutex as a notification mechanism.
In addition, a mutex cannot notify more than one thread at once, if we so desire.
Mutexes are only meant to be used to isolate a critical section within the same thread.&lt;/p&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><h2 class="anchor anchorWithStickyNavbar_LWe7" id="synchronization">Synchronization<a class="hash-link" href="#synchronization" title="Direct link to heading">​</a></h2><p>So far, we&#x27;ve used threads and processes without wondering how to &quot;tell&quot; them how to access shared data.
Moreover, in order to make threads wait for each other, we simply had the main thread wait for the others to finish all their work.
But what if we want one thread to wait until another one simply performs some specific action, after which it resumes its execution?
For this, we need to use some more complex synchronization mechanisms.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="race-conditions">Race Conditions<a class="hash-link" href="#race-conditions" title="Direct link to heading">​</a></h3><p>For example, what if one thread wants to increase a global variable while another one wants to decrease it?
Let&#x27;s say the assembly code for increasing and decreasing the variable looks like the one in the snippet below.</p><div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">increase:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov eax, [var]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inc eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov [var], eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">decrease:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov eax, [var]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dec eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov [var], eax</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Imagine both threads executed <code>mov eax, [var]</code> at the same time.
Then each would independently increase its (<strong>non-shared</strong>) <code>eax</code> register.
In the end, the final value of <code>var</code> depends on which thread executes <code>mov [var], eax</code> <em>last</em>.
So it&#x27;s kind of a reversed race.
The thread that runs the slowest &quot;wins&quot; this race and writes the final value of <code>var</code>.
But this is up to the scheduler and is non-deterministic.
Such undefined behaviours can cripple the execution of a program if <code>var</code> is some critical variable.</p><p>Let&#x27;s see this bug in action.
Go to <code>chapters/compute/synchronization/drills/tasks/race-condition/support/c/race_condition.c</code>, compile and run the code a few times.
It spawns to threads that do exactly what we&#x27;ve talked about so far: one thread increments <code>var</code> 10 million times, while the other decrements it 10 million times.</p><p>As you can see from running the program, the differences between subsequent runs can be substantial.
To fix this, we must ensure that <strong>only one thread</strong> can execute either <code>var++</code> or <code>var--</code> at any time.
We call these code sections <strong>critical sections</strong>.
A critical section is a piece of code that can only be executed by <strong>one thread</strong> at a time.
So we need some sort of <em>mutual exclusion mechanism</em> so that when one thread runs the critical section, the other has to <strong>wait</strong> before entering it.
This mechanism is called a <strong>mutex</strong>, whose name comes from &quot;mutual exclusion&quot;.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="thread-local-storage-tls">Thread-Local Storage (TLS)<a class="hash-link" href="#thread-local-storage-tls" title="Direct link to heading">​</a></h3><p>First things first: what if we don&#x27;t want data to be shared between threads?
Are we condemned to have to worry about race conditions?
Well, no.</p><p>To protect data from race conditions &quot;by design&quot;, we can place in what&#x27;s called <strong>Thread-Local Storage (TLS)</strong>.
As its name implies, this is a type of storage that is &quot;owned&quot; by individual threads, as opposed to being shared among all threads.
<strong>Do not confuse it with copy-on-write</strong>.
TLS pages are always duplicated when creating a new thread and their contents are reinitialised.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="user-level-threads">User-Level Threads<a class="hash-link" href="#user-level-threads" title="Direct link to heading">​</a></h2><p>User-level threads differ from the threads you are used to (kernel-level threads, those created by <code>pthread_create</code>).
This kind of threads are scheduled by an user-level scheduler, and can run on the same kernel-level thread.
From now on, we will refer to user-level threads as fibers, and kernel-level threads as simply threads.</p><p>We will use the fiber implementation from <code>libboost</code>.
This implementation uses a cooperative scheduler on each thread, meaning that each fiber has to yield, in order for other fiber to be executed.
We will also use C++, and the standard <code>thread</code> implementation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">​</a></h3><p>Unless you are using the OS docker image, you will need to install <code>cmake</code> and <code>libboost</code>.
You can do this with the following command:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~$ sudo apt-get install cmake libboost-context-dev libboost-fiber-dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="creation">Creation<a class="hash-link" href="#creation" title="Direct link to heading">​</a></h3><p>Follow the <code>chapters/compute/user-level-threads/guides/user-level-threads/support/simple.cc</code> implementation.
It creates <code>NUM_FIBERS</code> fibers, that each prints &quot;Hello World&quot;.
To compile and run the program, do the following steps:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../user-level-threads/support$ mkdir build/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../user-level-threads/support$ cd build/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../user-level-threads/support$ cmake -S .. -B .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../user-level-threads/support$ make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">student@os:~/.../user-level-threads/support$ ./simple</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>cmake</code> step must be executed only once.
After modifying the source files, it is enough to run <code>make</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="practice-sleeper-fiber">Practice: Sleeper Fiber<a class="hash-link" href="#practice-sleeper-fiber" title="Direct link to heading">​</a></h4><p>Add in <code>user-level-threads/support/simple.cc</code> a fiber that sleeps for 5 seconds, before the other ones are created.
What happens?
Answer in this <a href="/operating-systems/Compute/questions/sleeping-on-a-fiber.md">quiz</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="no-system-calls">No system calls<a class="hash-link" href="#no-system-calls" title="Direct link to heading">​</a></h3><p>Use <code>strace</code> to find calls to <code>clone()</code> in the execution of <code>simple</code>.
Can you find any?
Provide your answer in this <a href="/operating-systems/Compute/questions/fiber-strace.md">quiz</a>
<code>clone</code> is the system call used to create <strong>kernel-level</strong> threads, as pointed out <a href="/operating-systems/Compute/lab6#guide-threads-and-processes-clone">in this guide on creating threads and processes</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="synchronization-1">Synchronization<a class="hash-link" href="#synchronization-1" title="Direct link to heading">​</a></h3><p>By default, the fibers that run on the same thread are synchronized - no race-conditions can occur.
This is illustrated by the <code>chapters/compute/user-level-threads/guides/user-level-threads/support/sum.cc</code> implementation.</p><p>The user can, however, implement further synchronization, by using the <code>yield()</code> call, or classic synchronization methods, like mutexes, barriers and condition variables.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="yielding">Yielding<a class="hash-link" href="#yielding" title="Direct link to heading">​</a></h4><p>As the scheduler is cooperative, each fiber can yield (or not), to allow another fiber to run.
Follow the <code>compute/user-level-threads/guides/user-level-threads/support/yield_launch.cc</code> implementation and run it.
Note the <code>boost::fibers::launch::dispatch</code> parameter provided to the fiber constructor.
It notifies the scheduler to start the fiber as soon as it is created.
In order to explain the output, we must consider that the fibers are created by a <strong>main fiber</strong>, that is scheduled along with the others, in this case.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="practice">Practice<a class="hash-link" href="#practice" title="Direct link to heading">​</a></h5><p>Modify the launch parameter into <code>boost::fibers::launch::post</code>, compile and notice the differences.
The <code>post</code> parameter notifies the scheduler not to start the fibers immediately, but rather place them into an execution queue.
Their execution will start after the main fiber calls the <code>join()</code> function.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="barriers">Barriers<a class="hash-link" href="#barriers" title="Direct link to heading">​</a></h4><p>Follow the <code>chapters/compute/user-level-threads/guides/user-level-threads/support/yield_barrier.cc</code> implementation.
It uses a barrier to achieve the same result as the previous implementation, that used <code>post</code> as the launch parameter.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="c-unique_lock">C++ unique_lock<a class="hash-link" href="#c-unique_lock" title="Direct link to heading">​</a></h4><p><code>unique_lock</code> is a type of mutex that is unlocked automatically when the end of its scope is reached (end of function or bracket-pair).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="scheduling">Scheduling<a class="hash-link" href="#scheduling" title="Direct link to heading">​</a></h2><p>Up to now, we know that the OS decides which <strong>thread</strong> (not process) runs on each CPU core at each time.
Now we&#x27;ll learn about the component that performs this task specifically: <strong>the scheduler</strong>.</p><p>There are thousands of threads running at any time in a modern OS.
The job of the scheduler is to run and pause threads as well as allocate them to the CPU cores, with the following goals:</p><ul><li><strong>fairness</strong>: we do want all threads to get the same chance to run, i.e. run for about the same amount of time</li><li><strong>throughput</strong>: we want to run as many threads to completion so as to complete as many tasks as we can</li></ul><p>To do this, the scheduler must decide, at given times, to suspend a thread, save its current state and let another one run in its place.
This event is called a <strong>context switch</strong>.
A context switch means changing the state of one thread (the replaced thread) from RUNNING to WAITING, and the state of the replacement thread from READY / WAITING to RUNNING.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="user-level-vs-kernel-level-threads">User-Level vs Kernel-Level Threads<a class="hash-link" href="#user-level-vs-kernel-level-threads" title="Direct link to heading">​</a></h3><p>There are two types of threads.
The threads you&#x27;ve used so far are <strong>kernel-level threads (KLT)</strong>.
They are created and scheduled in the kernel of the OS.
One of the most important of their features is that they offer true parallelism.
With KLTs, we can truly run a program on all the cores of our CPU at once.
But we must pay a price for this: scheduling them is very complex, and context switches are costly (in terms of time), especially when switching threads belonging to different processes.</p><p>By contrast, <strong>user-level threads (ULT)</strong> are managed by the user space.
More of the ULTs created by a program are generally mapped to the same kernel thread.
If a process only creates ULTs, then they will all be mapped to the single, main kernel thread of the process.
So if we cannot run code in parallel with ULTs, then why use them?
Well, programs that create many context switches may suffer from the larger overhead if they use kernel-level threads.
In such cases, user-level threads may be useful as context switches bring less overhead between user-level threads.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="thread-control-block">Thread Control Block<a class="hash-link" href="#thread-control-block" title="Direct link to heading">​</a></h3><p>Let&#x27;s dissect the <code>threads_create()</code> function a bit.
It first initialises its queues and the timer for preemption.
We&#x27;ll discuss preemption separately, in a <a href="#scheduling---how-is-it-done">section of its own</a>.
After performing initialisations, the function creates a <code>TCB</code> object.
TCB stands for <strong>Thread Control Block</strong>.</p><p>During the lecture, you saw that the kernel stores one instance of a <a href="https://elixir.bootlin.com/linux/v5.19.11/source/include/linux/sched.h#L726" target="_blank" rel="noopener noreferrer"><code>task_struct</code></a> for each thread.
Remember that its most important fields are:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">task_struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain">                    __state</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain">                           </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">stack</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain">                    flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain">                             on_cpu</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain">                             prio</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* Scheduler information */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">sched_entity</span><span class="token plain">             se</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">sched_class</span><span class="token plain">        </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sched_class</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* The VAS: memory mappings */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">mm_struct</span><span class="token plain">                </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mm</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain">                             exit_state</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain">                             exit_code</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token class-name">pid_t</span><span class="token plain">                           pid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">task_struct</span><span class="token plain"> __rcu        </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">parent</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* Child processes */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">list_head</span><span class="token plain">                children</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* Open file information */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">files_struct</span><span class="token plain">             </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">files</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you can see, this <code>struct</code> stores <em>metadata</em> regarding a given thread.
The same is true about the <code>TCB</code> in <code>libult.so</code>:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token class-name">ucontext_t</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> bool has_dynamic_stack</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">start_routine</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argument</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">return_value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> TCB</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It stores the thread ID (tid - <code>id</code>), similar to the PID of a process.
It stores a pointer to the function passed as argument to <code>threads_create()</code> (<code>start_routine</code>), as well as the argument (<code>argument</code>) and the returned value (<code>return_value</code>) of said function.</p><p>In addition, the <code>TCB</code> stores a <code>context</code>.
From the <a href="https://pubs.opengroup.org/onlinepubs/7908799/xsh/ucontext.h.html" target="_blank" rel="noopener noreferrer">man page of the <code>ucontext.h</code> header</a>, we can see this type is a <code>struct</code> that stores a pointer to the stack of the current thread (<code>uc_stack</code>).
This is similar to the <code>stack</code> pointer in the <code>task_struct</code> above.
In short, we can say a context defines an execution unit, such as a thread.
<strong>This is why changing the running thread is called a context switch.</strong></p><p>Let&#x27;s compare this context with another thread implementation, from <a href="https://unikraft.org/" target="_blank" rel="noopener noreferrer">Unikraft</a>.
We&#x27;ll look at the <a href="https://github.com/unikraft/unikraft/blob/9bf6e63314a401204c02597834fb02f63a29aaf4/lib/uksched/include/uk/thread.h#L55-L76" target="_blank" rel="noopener noreferrer"><code>uk_thread</code></a> <code>struct</code>, which is the TCB used in Unikraft:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">uk_thread</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">stack</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">tls</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">UK_TAILQ_ENTRY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">uk_thread</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> thread_list</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> __snsec wakeup_time</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> bool detached</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">uk_waitq</span><span class="token plain"> waiting_threads</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">uk_sched</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sched</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">entry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">arg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">prv</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There are some visible similarities between the two TCBs.</p><iframe id="1cc6b65e-e8eb-4ea5-a03e-91711ebd0816" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;edcfde0c-8b0c-4a21-bdd9-f50a3a0698ca&quot;&gt; &lt;p&gt;Which members of the TCBs in &lt;code&gt;libult&lt;/code&gt; and Unikraft have similar meanings?&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;e1d7b0b5-cdf4-4c2a-9dc6-685052ae8eaa&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;e1d7b0b5-cdf4-4c2a-9dc6-685052ae8eaa&quot;&gt; &lt;p&gt;&lt;code&gt;id&lt;/code&gt; and &lt;code&gt;name&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;3f083a46-90e4-4852-b8a3-9043cd091ec2&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;3f083a46-90e4-4852-b8a3-9043cd091ec2&quot;&gt; &lt;p&gt;&lt;code&gt;start_routine&lt;/code&gt; and &lt;code&gt;entry&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;d73d7d6e-6958-4cd5-aef1-b1694aaf91df&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;d73d7d6e-6958-4cd5-aef1-b1694aaf91df&quot;&gt; &lt;p&gt;&lt;code&gt;return_value&lt;/code&gt; and &lt;code&gt;prv&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;9c4f8400-d9dd-46ca-9446-0fa6b478ce4e&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;9c4f8400-d9dd-46ca-9446-0fa6b478ce4e&quot;&gt; &lt;p&gt;&lt;code&gt;argument&lt;/code&gt; and &lt;code&gt;arg&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;20c69953-67e6-4517-a132-ad6151f6a145&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;20c69953-67e6-4517-a132-ad6151f6a145&quot;&gt; &lt;p&gt;&lt;code&gt;context&lt;/code&gt; and &lt;code&gt;tls&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;293667f4-6aa7-419d-83ef-66fbaf454a4f&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;293667f4-6aa7-419d-83ef-66fbaf454a4f&quot;&gt; &lt;p&gt;&lt;code&gt;has_dynamic_stack&lt;/code&gt; and &lt;code&gt;detached&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;2cb9691f-12a7-4f4e-a37b-044319ac16eb&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;2cb9691f-12a7-4f4e-a37b-044319ac16eb&quot;&gt; &lt;p&gt;&lt;code&gt;context&lt;/code&gt; and &lt;code&gt;sched&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;f9c43f93-71e9-4e99-a8e4-92318e8faf04&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;f9c43f93-71e9-4e99-a8e4-92318e8faf04&quot;&gt; &lt;p&gt;&lt;code&gt;context.uc_stack&lt;/code&gt; and &lt;code&gt;stack&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;aff607dd-ef83-498d-9b2f-570d1419d321&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;aff607dd-ef83-498d-9b2f-570d1419d321&quot;&gt; &lt;p&gt;&lt;code&gt;context&lt;/code&gt; and &lt;code&gt;ctx&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;ef66a9d2-838f-483f-9300-91bef3c0704b&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;ef66a9d2-838f-483f-9300-91bef3c0704b&quot;&gt; &lt;p&gt;&lt;code&gt;arguments&lt;/code&gt; and &lt;code&gt;flags&lt;/code&gt;&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;3f083a46-90e4-4852-b8a3-9043cd091ec2&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;&lt;code&gt;start_routine&lt;/code&gt; and &lt;code&gt;entry&lt;/code&gt; are the functions that run in the newly created threads.&lt;code&gt;context.uc_stack&lt;/code&gt; and &lt;code&gt;stack&lt;/code&gt; are pointers to the stack of the newly created threads.&lt;code&gt;argument&lt;/code&gt; and &lt;code&gt;arg&lt;/code&gt; are pointers to the arguments of &lt;code&gt;start_routine&lt;/code&gt; and &lt;code&gt;entry&lt;/code&gt;, respectively.&lt;code&gt;context&lt;/code&gt; and &lt;code&gt;ctx&lt;/code&gt; are the contexts in which the new threads run.&lt;code&gt;return_value&lt;/code&gt; and &lt;code&gt;prv&lt;/code&gt; are both pointers to the values returned by the thread functions.&lt;/p&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><p>Therefore, the workflow for creating and running a thread goes like this:</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">main thread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `--&gt; threads_create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |--&gt; tcb_new()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            `--&gt; makecontext()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      `--&gt; handle_thread_start() - called using the context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       |--&gt; start_routine() - the thread runs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            `--&gt; threads_exit()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Compile and run the code in <code>libult/support/test_ult.c</code>.
If you encounter the following error when running <code>test_ult</code>, remember what you learned about the loader and using custom shared libraries in the <a href="/operating-systems/Compute/lab2.md#libraries-and-libc">Software Stack lab</a>.</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./test_ult: error while loading shared libraries: libult.so: cannot open shared object file: No such file or directory</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>Hint: Use the <code>LD_LIBRARY_PATH</code> variable.</p></blockquote><p>Notice that the threads run their code and alternatively, because their prints appear interleaved.</p><p><a href="/operating-systems/Compute/questions/ult-thread-ids.md">Quiz</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="scheduling---how-is-it-done">Scheduling - How is it done?<a class="hash-link" href="#scheduling---how-is-it-done" title="Direct link to heading">​</a></h3><p>There are two types of schedulers: <strong>preemptive</strong> and <strong>cooperative</strong>.
When discussing this distinction, we need to first define the notion of <strong>yielding</strong>.
Yielding the CPU means that a thread suspends its own execution and enters the WAITING or READY state, either as a result of a blocking call (I/O operations or calling the scheduler&#x27;s <code>yield()</code> function directly).
So, yielding the CPU triggers a context switch whereby the current thread stops running and another one resumes or starts running in its place.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cooperative-scheduling">Cooperative Scheduling<a class="hash-link" href="#cooperative-scheduling" title="Direct link to heading">​</a></h4><p>Cooperative scheduling relies on the fact that threads themselves would yield the CPU at some point.
If threads don&#x27;t abide by this convention, they end up monopolising the CPU (since there is no one to suspend them) and end up starving the others.
You can get a feel of this behaviour by running the cooperative <a href="https://github.com/unikraft/unikraft/blob/staging/lib/ukschedcoop/schedcoop.c" target="_blank" rel="noopener noreferrer">scheduler from Unikraft</a> in the <!-- -->[lecture demos]<!-- -->.</p><p>This type of schedulers have the advantage of being lightweight, thus resulting in less overhead caused by context switches.
However, as we&#x27;ve already stated, they rely on the &quot;good will&quot; of threads to yield the CPU at some point.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="preemptive-scheduling">Preemptive Scheduling<a class="hash-link" href="#preemptive-scheduling" title="Direct link to heading">​</a></h4><p>Preemptive scheduling solves the issue stated above by leaving the task of suspending the currently RUNNING thread and replacing it with another one from the READY queue up to the scheduler.
This increases its complexity and the duration of context switches, but threads now are not required to worry about yielding themselves and can focus on running their code and performing the task for which they are created.</p><p>Preemptive schedulers allow threads to run only for a maximum amount of time, called a <strong>time slice</strong> (usually a few milliseconds).
They use timers which fire when a new time slice passes.
The firing of one such timer causes a context switch whereby the currently RUNNING thread is <em>preempted</em> (i.e. suspended) and replaced with another one.</p><iframe id="da3eb73e-c469-4648-8f14-6376feeed741" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;692dd9fb-51bc-41ee-9706-c50982e741d3&quot;&gt; &lt;p&gt;Inspect the code in &lt;code&gt;support/libult/threads.c&lt;/code&gt; further.
Which type of scheduler does &lt;code&gt;libult.so&lt;/code&gt; use?&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;8f715daa-e6d2-4826-a7ec-9153dce8acbf&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;8f715daa-e6d2-4826-a7ec-9153dce8acbf&quot;&gt; &lt;p&gt;It uses both a cooperative and a preemptive scheduler&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;81839814-6fcb-4391-843f-8d7eefea3ea9&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;81839814-6fcb-4391-843f-8d7eefea3ea9&quot;&gt; &lt;p&gt;It uses a cooperative scheduler&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;3caa8bb4-7dc6-4ed1-a1b8-103890f852f8&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;3caa8bb4-7dc6-4ed1-a1b8-103890f852f8&quot;&gt; &lt;p&gt;It uses a preemptive scheduler&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;3caa8bb4-7dc6-4ed1-a1b8-103890f852f8&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;&lt;code&gt;libult.so&lt;/code&gt; uses a preemptive scheduler.
Its timer is initialised in the &lt;code&gt;init_profiling_timer()&lt;/code&gt; function.
The context switch is performed in the &lt;code&gt;handle_sigprof()&lt;/code&gt; function.&lt;/p&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><p>Look at the <code>init_profiling_timer()</code> function.
It creates a timer that generates a <code>SIGPROF</code> signal and then defines a handler (the <code>handle_sigprof()</code> function) that is executed whenever the <code>SIGPROF</code> signal is received.</p><iframe id="892d31ea-efea-400c-bf43-2cf3777a0cad" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;9333599a-0323-41fb-b7eb-cfaa5772cff3&quot;&gt; &lt;p&gt;Using the &lt;a href=&quot;https://man7.org/linux/man-pages/man2/setitimer.2.html&quot;&gt;man page&lt;/a&gt;, what is the time slice used by the scheduler in &lt;code&gt;libult.so&lt;/code&gt;?&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;c02c7bc3-7800-496f-a2e9-268d74834664&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;c02c7bc3-7800-496f-a2e9-268d74834664&quot;&gt; &lt;p&gt;10 microseconds&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;18cd06f1-2a59-4e7a-a070-ebc97a2c4359&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;18cd06f1-2a59-4e7a-a070-ebc97a2c4359&quot;&gt; &lt;p&gt;10 milliseconds&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;15c20e9c-5e20-4e33-a12d-f14190055056&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;15c20e9c-5e20-4e33-a12d-f14190055056&quot;&gt; &lt;p&gt;100 microseconds&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;a038e85d-aaa2-4960-aa3b-b822d3e49f97&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;a038e85d-aaa2-4960-aa3b-b822d3e49f97&quot;&gt; &lt;p&gt;100 milliseconds&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;18cd06f1-2a59-4e7a-a070-ebc97a2c4359&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;The code we&#x27;re interested in lies in the function &lt;code&gt;init_profiling_timer()&lt;/code&gt;:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot;&gt;const struct itimerval timer = { { 0, 10000 }, { 0, 1 }  // arms the timer as soon as possible
};&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The &lt;a href=&quot;https://man7.org/linux/man-pages/man2/setitimer.2.html&quot;&gt;man page&lt;/a&gt; gives the following definition the &lt;code&gt;struct itimerval&lt;/code&gt;:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-c&quot;&gt;struct itimerval { struct timeval it_interval; /* Interval for periodic timer */ struct timeval it_value;    /* Time until next expiration */
};&lt;br /&gt;struct timeval { time_t      tv_sec;         /* seconds */ suseconds_t tv_usec;        /* microseconds */
};&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;So when constructing the &lt;code&gt;timer&lt;/code&gt; variable, &lt;code&gt;{ 0, 10000 }&lt;/code&gt; means 0 seconds and 10000 microseconds, i.e. 0 seconds and 10 milliseconds.&lt;/p&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><p>It is this handler that performs the context switch per se.
Look at its code.
It first saves the context of the current thread:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">ucontext_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">stored </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">running</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">ucontext_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">updated </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ucontext_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stored</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">uc_flags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> updated</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">uc_flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stored</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">uc_link </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> updated</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">uc_link</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stored</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">uc_mcontext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> updated</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">uc_mcontext</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stored</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">uc_sigmask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> updated</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">uc_sigmask</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then it places the current thread in the <code>ready</code> queue and replaces it with the first thread in the same queue.
This algorithm (that schedules the first thread in the READY queue) is called <em>Round-Robin</em>:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">queue_enqueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ready</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> running</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">abort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">running </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">queue_dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ready</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">abort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The new <code>running</code> thread is resumed upon setting the current context to it:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">setcontext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">running</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token function" style="color:#d73a49">abort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is how scheduling is done!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-interaction-between-threads-and-fibers">Guide: Interaction Between Threads and Fibers<a class="hash-link" href="#guide-interaction-between-threads-and-fibers" title="Direct link to heading">​</a></h2><p>As we mentioned before, multiple fibers can run on the same thread, and a scheduler is implemented on each thread.
By default, the scheduling algorithm is <a href="https://www.guru99.com/round-robin-scheduling-example.html" target="_blank" rel="noopener noreferrer"><code>round_robin</code></a>.
It runs the fibers, in the order of their creation, until they yield or finish their work.
If a fiber yields, it is placed at the back of the round-robin queue.
Using this scheduler, each thread only uses its fibers;
if one thread has more work to do than another, bad luck.
This may lead to starvation.</p><p>But there are other scheduler implementations, such as <code>shared_work</code> and <code>work_stealing</code>.
Follow the <code>chapters/compute/user-level-threads/guides/user-level-threads/support/threads_and_fibers.cc</code> implementation.
It creates multiple fibers and threads, and uses the <code>shared_work</code> scheduler to balance the workload between the threads.
Each main fiber, from each thread, is suspended until all worker fibers have completed their work, using a condition variable.</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cnd_count</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> lk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> fiber_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The program also uses <code>thread local storage</code> and <code>fiber local storage</code> to store the ID of each thread / fiber.</p><p>Now change the <code>shared_work</code> scheduler into the <code>work_stealing</code> one.
It takes a parameter, the number of threads that will use that scheduler.</p><p>Compile, rerun and note the differences.
The <code>work_stealing</code> scheduler, as the name suggests, will &quot;steal&quot; fibers from other schedulers.
So, if the <code>shared_work</code> scheduler tried to balance the available work between the available threads, the <code>work_stealing</code> one will focus on having as many threads as possible on 100% workload.
Vary the number of threads and fibers, and the workload (maybe put each fibre to do some computational-intensive work), and observe the results.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="guide-user-level-threads-scheduler">Guide: User-Level Threads Scheduler<a class="hash-link" href="#guide-user-level-threads-scheduler" title="Direct link to heading">​</a></h2><p>Go to <code>chapters/compute/scheduling/guides/libult/support</code>.
It contains a minimalist <strong>user-level threads</strong> scheduler.
Compiling it produces a shared library called <code>libult.so</code>.
You can also consult its <a href="https://www.schaertl.me/posts/a-bare-bones-user-level-thread-library/" target="_blank" rel="noopener noreferrer">documentation</a>.
It explains the API as well as its implementation.
The API exposed by the scheduling library is very simple.
It is only made up of 3 functions:</p><ul><li><code>threads_create()</code> creates a new ULT</li><li><code>threads_exit()</code> moves the current ULT to the COMPLETED state</li><li><code>threads_join()</code> waits for a given thread to end and saves its return value in the <code>result</code> argument</li></ul><p>Look inside <code>chapters/compute/scheduling/guides/libult/support/threads.c</code>.
Here you will find the 3 functions mentioned above.</p><p>The scheduler only uses 3 states: RUNNING, READY, COMPLETED.</p><iframe id="fe4ae7ff-12ea-47e6-b484-ec63faa373a1" srcdoc="&lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot; integrity=&quot;sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js&quot; integrity=&quot;sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css&quot;&gt;&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js&quot;&gt;&lt;/script&gt;&lt;script&gt;hljs.highlightAll();&lt;/script&gt;&lt;div class=&quot;card d-flex&quot; style=&quot;width: 75%; margin: auto; margin-top: 1rem; margin-bottom: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot; id=&quot;764da12d-a581-4d17-bfea-3bb7bca93072&quot;&gt; &lt;p&gt;How many threads can be RUNNING simultaneously if we only create them using the API exposed by &lt;code&gt;libult.so&lt;/code&gt;?&lt;/p&gt; &lt;/div&gt; &lt;ul class=&quot;list-group list-group-flush&quot;&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;0b3af0ee-66d3-4e70-b5f8-571fd1bb6ed6&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;0b3af0ee-66d3-4e70-b5f8-571fd1bb6ed6&quot;&gt; &lt;p&gt;2: the main thread and another one for the created threads&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;0a2c882f-7de7-4a4a-9623-b513370b198a&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;0a2c882f-7de7-4a4a-9623-b513370b198a&quot;&gt; &lt;p&gt;None&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;4c18b322-a0bb-46fb-b621-336260313d90&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;4c18b322-a0bb-46fb-b621-336260313d90&quot;&gt; &lt;p&gt;Equal to the number of cores on the CPU&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;li class=&quot;list-group-item choice&quot;&gt; &lt;div class=&quot;form-check&quot;&gt; &lt;input class=&quot;form-check-input&quot; type=&quot;radio&quot; name=&quot;flexRadioDefault&quot; id=&quot;5be71d44-dff5-4aee-b6f9-628b776cb189&quot;&gt; &lt;label class=&quot;form-check-label&quot; for=&quot;5be71d44-dff5-4aee-b6f9-628b776cb189&quot;&gt; &lt;p&gt;1&lt;/p&gt; &lt;/label&gt; &lt;/div&gt; &lt;/li&gt; &lt;/ul&gt; &lt;div class=&quot;card-footer&quot;&gt; &lt;div class=&quot;text-center&quot; style=&quot;padding: 5px;&quot;&gt; &lt;button class=&quot;check btn btn-primary&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedcheck&#x27;);answerIndex=&#x27;5be71d44-dff5-4aee-b6f9-628b776cb189&#x27;;document.getElementsByClassName(&#x27;check&#x27;)[0].classList.add(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=true;if(radio.checked){if(radio.id===answerIndex){choices[i].classList.add(&#x27;list-group-item-success&#x27;);document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.remove(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;feedback&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;}else{choices[i].classList.add(&#x27;list-group-item-danger&#x27;);}}}&quot;&gt;Check Answer &lt;/button&gt; &lt;button class=&quot;reset btn btn-default&quot; type=&quot;button&quot; onclick=&quot;console.log(&#x27;Clickedreset&#x27;);document.getElementsByClassName(&#x27;check&#x27;)[0].classList.remove(&#x27;disabled&#x27;);choices=document.getElementsByClassName(&#x27;choice&#x27;);for(i=0;i&lt;choices.length;i++){radio=choices[i].firstElementChild.firstElementChild;radio.disabled=false;choices[i].classList.remove(&#x27;list-group-item-success&#x27;);choices[i].classList.remove(&#x27;list-group-item-danger&#x27;);radio.checked=false;}document.getElementsByClassName(&#x27;feedback&#x27;)[0].classList.add(&#x27;d-none&#x27;);var savTop=parent.document.documentElement.scrollTop;document.getElementsByClassName(&#x27;card&#x27;)[0].scrollIntoView(false);parent.document.documentElement.scrollTop=savTop;&quot;&gt;Try Again&lt;/button&gt; &lt;/div&gt; &lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;feedback card d-flex d-none&quot; style=&quot;width: 80%; margin: auto; margin-top: 1rem;&quot;&gt; &lt;div class=&quot;card-header&quot;&gt; Feedback &lt;/div&gt; &lt;div class=&quot;card-body alert alert-success&quot;&gt; &lt;p&gt;Only kernel-level threads can run in parallel.
Since all &lt;code&gt;libult.so&lt;/code&gt; threads are user-level threads, they run within the same kernel-level thread, so only one of them can run at any time.&lt;/p&gt; &lt;/div&gt;&lt;/div&gt;" width="100%" style="border:none;overflow:hidden"></iframe><p>The threads in the READY and COMPLETED states are kept in 2 separate queues.
When the scheduler wants to run a new thread, it retrieves it from the READY queue.
When a thread ends its execution, it is added to the COMPLETED queue, together with its return value.</p><p><a href="/operating-systems/Compute/questions/why-use-completed-queue.md">Quiz</a></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/operating-systems/Compute/lab7"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Lab 7 - Copy-on-Write</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/operating-systems/IO/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">IO</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#task-c-race-conditions" class="table-of-contents__link toc-highlight">Task: C: Race Conditions</a><ul><li><a href="#synchronization---overhead" class="table-of-contents__link toc-highlight">Synchronization - Overhead</a></li></ul></li><li><a href="#task-wrap-the-whole-for-statements-in-critical-sections" class="table-of-contents__link toc-highlight">Task: Wrap the Whole <code>for</code> Statements in Critical Sections</a></li><li><a href="#task-c-atomics" class="table-of-contents__link toc-highlight">Task: C: Atomics</a></li><li><a href="#task-c---tls-on-demand" class="table-of-contents__link toc-highlight">Task: C - TLS on Demand</a></li><li><a href="#task-atomic-assembly" class="table-of-contents__link toc-highlight">Task: Atomic Assembly</a></li><li><a href="#guide-apache2-simulator---semaphore" class="table-of-contents__link toc-highlight">Guide: <code>apache2</code> Simulator - Semaphore</a><ul><li><a href="#semaphores" class="table-of-contents__link toc-highlight">Semaphores</a></li></ul></li><li><a href="#task-apache2-simulator---condition" class="table-of-contents__link toc-highlight">Task: <code>apache2</code> Simulator - Condition</a><ul><li><a href="#conditions" class="table-of-contents__link toc-highlight">Conditions</a></li></ul></li><li><a href="#synchronization" class="table-of-contents__link toc-highlight">Synchronization</a><ul><li><a href="#race-conditions" class="table-of-contents__link toc-highlight">Race Conditions</a></li><li><a href="#thread-local-storage-tls" class="table-of-contents__link toc-highlight">Thread-Local Storage (TLS)</a></li></ul></li><li><a href="#user-level-threads" class="table-of-contents__link toc-highlight">User-Level Threads</a><ul><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#creation" class="table-of-contents__link toc-highlight">Creation</a></li><li><a href="#no-system-calls" class="table-of-contents__link toc-highlight">No system calls</a></li><li><a href="#synchronization-1" class="table-of-contents__link toc-highlight">Synchronization</a></li></ul></li><li><a href="#scheduling" class="table-of-contents__link toc-highlight">Scheduling</a><ul><li><a href="#user-level-vs-kernel-level-threads" class="table-of-contents__link toc-highlight">User-Level vs Kernel-Level Threads</a></li><li><a href="#thread-control-block" class="table-of-contents__link toc-highlight">Thread Control Block</a></li><li><a href="#scheduling---how-is-it-done" class="table-of-contents__link toc-highlight">Scheduling - How is it done?</a></li></ul></li><li><a href="#guide-interaction-between-threads-and-fibers" class="table-of-contents__link toc-highlight">Guide: Interaction Between Threads and Fibers</a></li><li><a href="#guide-user-level-threads-scheduler" class="table-of-contents__link toc-highlight">Guide: User-Level Threads Scheduler</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://curs.upb.ro" target="_blank" rel="noopener noreferrer" class="footer__link-item">Main site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ocw.cs.pub.ro/courses/so" target="_blank" rel="noopener noreferrer" class="footer__link-item">OCW<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.facebook.com/sisteme.de.operare/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 SO Team</div></div></div></footer></div>
<script src="/operating-systems/assets/js/runtime~main.b1620ad0.js"></script>
<script src="/operating-systems/assets/js/main.fb2c1889.js"></script>
</body>
</html>